<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ãƒ™ãƒ“ãƒ¼ãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼ˆLANé™å®š / 1ãƒ•ã‚¡ã‚¤ãƒ« / QRï¼‰</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- QRç”Ÿæˆï¼ˆè¡¨ç¤ºï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <!-- QRèª­å–ï¼ˆã‚¹ã‚­ãƒ£ãƒ³ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <style>
    body { -webkit-tap-highlight-color: transparent; }
    video { background:#000; }
    .night { filter: brightness(1.9) contrast(1.45) saturate(0.85); }
    .glass { backdrop-filter: blur(10px); }
  </style>
</head>

<body class="bg-slate-50 text-slate-800">
  <div class="max-w-4xl mx-auto p-4 space-y-4">
    <!-- Header -->
    <header class="space-y-2">
      <div class="flex items-center justify-between gap-2 flex-wrap">
        <div class="text-xl font-black">ãƒ™ãƒ“ãƒ¼ãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼ˆåŒã˜Wi-Fiå†… / 1ãƒ•ã‚¡ã‚¤ãƒ« / QRï¼‰</div>
        <div class="text-xs font-bold px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">
          LANé™å®šï¼ˆå¤–éƒ¨æ¥ç¶šä¸å¯æƒ³å®šï¼‰
        </div>
      </div>
      <div class="text-xs text-slate-500 leading-relaxed">
        â€»HTTPSå¿…é ˆï¼ˆGitHub Pagesç­‰ï¼‰ã€‚åŒã˜Wi-Fiå†…ã§ä½¿ã£ã¦ãã ã•ã„ï¼ˆã‚²ã‚¹ãƒˆWi-Fiã®ç«¯æœ«éš”é›¢ãŒã‚ã‚‹ã¨æ¥ç¶šã§ãã¾ã›ã‚“ï¼‰ã€‚<br/>
        â€»åŒ»ç™‚æ©Ÿå™¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚çŸ­æ™‚é–“ã®â€œè£œåŠ©â€ç”¨é€”ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚
      </div>
    </header>

    <!-- Mode & Password -->
    <section class="bg-white rounded-3xl border border-slate-200 p-4 space-y-4 shadow-sm">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="font-black text-slate-700">0ï¼‰ãƒ¢ãƒ¼ãƒ‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</div>
        <div class="text-xs text-slate-500">åŒã˜ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã®ã¿å¾©å·ãƒ»æ¥ç¶šã§ãã¾ã™</div>
      </div>

      <div class="grid md:grid-cols-2 gap-3">
        <div class="bg-slate-50 rounded-2xl p-3 border border-slate-200">
          <div class="text-sm font-bold text-slate-700 mb-2">ãƒ¢ãƒ¼ãƒ‰é¸æŠ</div>
          <div class="grid grid-cols-2 gap-2">
            <button id="btnModeSend" class="px-3 py-3 rounded-2xl font-black border border-slate-200 bg-white hover:bg-slate-100">
              ğŸ‘¶ é€ä¿¡ï¼ˆãƒ™ãƒ“ãƒ¼å´ï¼‰
            </button>
            <button id="btnModeRecv" class="px-3 py-3 rounded-2xl font-black border border-slate-200 bg-white hover:bg-slate-100">
              ğŸ‘€ å—ä¿¡ï¼ˆè¦‹å®ˆã‚Šå´ï¼‰
            </button>
          </div>
          <div class="mt-2 text-xs text-slate-500">
            åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’2å°ã§é–‹ãã€ç‰‡æ–¹ã‚’é€ä¿¡ãƒ»ã‚‚ã†ç‰‡æ–¹ã‚’å—ä¿¡ã«ã—ã¾ã™ã€‚
          </div>
        </div>

        <div class="bg-slate-50 rounded-2xl p-3 border border-slate-200 space-y-2">
          <div class="flex items-center justify-between">
            <div class="text-sm font-bold text-slate-700">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</div>
            <button id="btnTogglePw" class="text-xs font-bold px-3 py-1 rounded-full bg-white border border-slate-200">è¡¨ç¤º</button>
          </div>
          <input id="pw" type="password" class="w-full rounded-2xl border border-slate-200 px-4 py-3 font-bold"
                 placeholder="ä¸¡ç«¯æœ«ã§åŒã˜ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" />
          <div class="text-xs text-slate-500">
            Offer/Answerã‚³ãƒ¼ãƒ‰ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§æš—å·åŒ–ã•ã‚Œã¾ã™ï¼ˆã‚µãƒ¼ãƒä¸è¦ï¼‰ã€‚
          </div>
        </div>
      </div>

      <div class="flex items-center justify-between gap-2 flex-wrap">
        <div class="text-sm">
          çŠ¶æ…‹ï¼š<span id="globalState" class="font-black text-slate-700">å¾…æ©Ÿä¸­</span>
        </div>
        <div class="text-xs text-slate-500">
          ãƒ’ãƒ³ãƒˆï¼š<span id="uaHint"></span>
        </div>
      </div>
    </section>

    <!-- SEND VIEW -->
    <section id="sendView" class="space-y-4 hidden">
      <section class="bg-white rounded-3xl border border-slate-200 p-4 space-y-4 shadow-sm">
        <div class="flex items-center justify-between gap-2 flex-wrap">
          <div class="font-black text-slate-700">é€ä¿¡ï¼ˆãƒ™ãƒ“ãƒ¼å´ï¼‰</div>
          <div class="flex items-center gap-2">
            <button id="btnStartCam" class="px-4 py-2 rounded-2xl bg-sky-600 text-white font-black">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
            <button id="btnStopAllSend" class="px-4 py-2 rounded-2xl bg-slate-200 font-black" disabled>åœæ­¢</button>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <!-- Preview -->
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <div class="text-sm font-bold text-slate-600">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
              <button id="btnFullLocal" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>â›¶ å…¨ç”»é¢</button>
            </div>
            <video id="localVideo" class="w-full rounded-3xl aspect-video" playsinline muted autoplay></video>

            <div class="grid grid-cols-2 gap-2">
              <button id="btnFlipCam" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>ğŸ“· å‰/å¾Œåˆ‡æ›¿</button>
              <button id="btnMicMute" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>ğŸ¤ ãƒã‚¤ã‚¯ï¼šON</button>
              <button id="btnNightLocal" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>ğŸŒ™ æš—è¦–ï¼šOFF</button>
              <button id="btnTorch" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>ğŸ”¦ ãƒ©ã‚¤ãƒˆï¼šOFF</button>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3 text-xs text-slate-600">
              <div class="font-bold text-slate-700 mb-1">å®Ÿéš›ã®æ’®å½±è¨­å®š</div>
              <div id="camInfo">æœªé–‹å§‹</div>
              <div class="mt-1 text-slate-500">â€»ã€Œæœ€é«˜ç”»è³ªã€ã‚’ç†æƒ³å€¤ã§è¦æ±‚ã—ã€ç«¯æœ«ãŒå¯èƒ½ãªæœ€å¤§ã«å¯„ã›ã¾ã™ã€‚</div>
            </div>

            <div class="text-xs text-slate-500">
              â€»æš—è¦–ã¯ã€Œç–‘ä¼¼ï¼ˆæ˜ã‚‹ã•/ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·èª¿ï¼‰ã€ã§ã™ã€‚èµ¤å¤–ç·šæš—è¦–ã¯ç«¯æœ«ãƒãƒ¼ãƒ‰ä¾å­˜ã§ã€Webã‚¢ãƒ—ãƒªã‹ã‚‰è¿½åŠ ã§ãã¾ã›ã‚“ã€‚
            </div>
          </div>

          <!-- Flow -->
          <div class="space-y-3">
            <div class="bg-indigo-50 border border-indigo-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-indigo-900">1ï¼‰Offerã‚’ä½œæˆã—ã¦æ¸¡ã™</div>
              <div class="text-indigo-700 text-xs mt-1">ã‚³ãƒ”ãƒ¼ or QRè¡¨ç¤ºã§å—ä¿¡å´ã¸</div>
              <div class="mt-2 flex gap-2 flex-wrap">
                <button id="btnMakeOffer" class="px-4 py-2 rounded-2xl bg-indigo-600 text-white font-black" disabled>Offerä½œæˆ</button>
                <button id="btnCopyOffer" class="px-4 py-2 rounded-2xl bg-slate-200 font-black" disabled>ã‚³ãƒ”ãƒ¼</button>
                <button id="btnShowOfferQR" class="px-4 py-2 rounded-2xl border border-indigo-200 bg-white font-black" disabled>ğŸ“· QRè¡¨ç¤º</button>
              </div>
              <textarea id="offerOut" class="mt-2 w-full h-28 rounded-2xl border border-indigo-200 p-3 text-xs font-mono"
                        placeholder="Offerã‚³ãƒ¼ãƒ‰ï¼ˆæš—å·åŒ–æ¸ˆã¿ï¼‰ãŒã“ã“ã«å‡ºã¾ã™" readonly></textarea>
            </div>

            <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-emerald-900">2ï¼‰Answerã‚’å—ã‘å–ã£ã¦æ¥ç¶š</div>
              <div class="text-emerald-700 text-xs mt-1">è²¼ã‚Šä»˜ã‘ or QRèª­å– â†’ æ¥ç¶š</div>
              <div class="mt-2 flex gap-2 flex-wrap">
                <button id="btnScanAnswerQR" class="px-4 py-2 rounded-2xl border border-emerald-200 bg-white font-black" disabled>ğŸ“· QRèª­å–</button>
                <button id="btnConnectSend" class="px-4 py-2 rounded-2xl bg-emerald-600 text-white font-black" disabled>æ¥ç¶š</button>
              </div>
              <textarea id="answerIn" class="mt-2 w-full h-28 rounded-2xl border border-emerald-200 p-3 text-xs font-mono"
                        placeholder="Answerã‚³ãƒ¼ãƒ‰ï¼ˆæš—å·åŒ–æ¸ˆã¿ï¼‰ã‚’è²¼ã‚Šä»˜ã‘ï¼ˆã¾ãŸã¯QRèª­å–ï¼‰"></textarea>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-slate-700">æ¥ç¶šçŠ¶æ…‹</div>
              <div class="mt-1 text-sm">Peerï¼š<span id="sendConn" class="font-black">æœªæ¥ç¶š</span></div>
              <div class="text-xs text-slate-500 mt-1">â€»LANå€™è£œã®ã¿ï¼ˆå¤–éƒ¨ã‹ã‚‰ã¯åŸºæœ¬æ¥ç¶šä¸å¯ã®ä½œã‚Šï¼‰</div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <!-- RECV VIEW -->
    <section id="recvView" class="space-y-4 hidden">
      <section class="bg-white rounded-3xl border border-slate-200 p-4 space-y-4 shadow-sm">
        <div class="flex items-center justify-between gap-2 flex-wrap">
          <div class="font-black text-slate-700">å—ä¿¡ï¼ˆè¦‹å®ˆã‚Šå´ï¼‰</div>
          <div class="flex items-center gap-2">
            <button id="btnResetRecv" class="px-4 py-2 rounded-2xl bg-slate-200 font-black" disabled>åˆ‡æ–­/ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <!-- Offer/Answer -->
          <div class="space-y-2">
            <div class="bg-indigo-50 border border-indigo-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-indigo-900">1ï¼‰Offerã‚’å—ã‘å–ã‚‹ï¼ˆè²¼ã‚Šä»˜ã‘ or QRèª­å–ï¼‰</div>
              <div class="mt-2 flex gap-2 flex-wrap">
                <button id="btnScanOfferQR" class="px-4 py-2 rounded-2xl border border-indigo-200 bg-white font-black">ğŸ“· QRèª­å–</button>
                <button id="btnMakeAnswer" class="px-4 py-2 rounded-2xl bg-indigo-600 text-white font-black">Answerä½œæˆ</button>
              </div>
              <textarea id="offerIn" class="mt-2 w-full h-28 rounded-2xl border border-indigo-200 p-3 text-xs font-mono"
                        placeholder="Offerã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ï¼ˆã¾ãŸã¯QRèª­å–ï¼‰"></textarea>
            </div>

            <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-emerald-900">2ï¼‰Answerã‚’è¿”ã™ï¼ˆã‚³ãƒ”ãƒ¼ or QRè¡¨ç¤ºï¼‰</div>
              <div class="mt-2 flex gap-2 flex-wrap">
                <button id="btnCopyAnswer" class="px-4 py-2 rounded-2xl bg-slate-200 font-black" disabled>ã‚³ãƒ”ãƒ¼</button>
                <button id="btnShowAnswerQR" class="px-4 py-2 rounded-2xl border border-emerald-200 bg-white font-black" disabled>ğŸ“· QRè¡¨ç¤º</button>
              </div>
              <textarea id="answerOut" class="mt-2 w-full h-28 rounded-2xl border border-emerald-200 p-3 text-xs font-mono"
                        placeholder="Answerã‚³ãƒ¼ãƒ‰ï¼ˆæš—å·åŒ–æ¸ˆã¿ï¼‰ãŒã“ã“ã«å‡ºã¾ã™" readonly></textarea>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-slate-700">æ¥ç¶šçŠ¶æ…‹</div>
              <div class="mt-1 text-sm">Peerï¼š<span id="recvConn" class="font-black">æœªæ¥ç¶š</span></div>
              <div class="text-xs text-slate-500 mt-1">iPhone/iPadã¯è‡ªå‹•å†ç”Ÿåˆ¶é™ãŒã‚ã‚‹ãŸã‚ã€Œå†ç”Ÿã€ã‚’æŠ¼ã™ã¨å®‰å®šã—ã¾ã™ã€‚</div>
            </div>
          </div>

          <!-- Video -->
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <div class="text-sm font-bold text-slate-600">å—ä¿¡æ˜ åƒ</div>
              <button id="btnFullRemote" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>â›¶ å…¨ç”»é¢</button>
            </div>
            <video id="remoteVideo" class="w-full rounded-3xl aspect-video" playsinline autoplay></video>

            <div class="grid grid-cols-2 gap-2">
              <button id="btnPlayRemote" class="px-3 py-2 rounded-2xl bg-emerald-600 text-white font-black" disabled>â–¶ å†ç”Ÿ</button>
              <button id="btnSpkMute" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>ğŸ”ˆ éŸ³ï¼šON</button>
              <button id="btnNightRemote" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>ğŸŒ™ æš—è¦–ï¼šOFF</button>
              <button id="btnFull" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>â›¶ï¼ˆä»£æ›¿ï¼‰</button>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3 text-xs text-slate-600">
              <div class="font-bold text-slate-700 mb-1">ãƒ¡ãƒ¢</div>
              <ul class="list-disc pl-5 space-y-1">
                <li>å¤–éƒ¨å›ç·šã‹ã‚‰ã¯æ¥ç¶šä¸å¯æƒ³å®šï¼ˆLANå€™è£œã®ã¿ï¼‰ã€‚</li>
                <li>åŒã˜Wi-Fiã§ã‚‚ã€Œç«¯æœ«éš”é›¢ã€ãŒã‚ã‚‹ã¨æ¥ç¶šã§ãã¾ã›ã‚“ã€‚</li>
              </ul>
            </div>
          </div>
        </div>
      </section>
    </section>

    <div class="text-[11px] text-slate-500 px-1">
      ğŸ”’ Offer/Answerã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§æš—å·åŒ–ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã†ã¨å¾©å·ã§ããšã€æ¥ç¶šã§ãã¾ã›ã‚“ã€‚
    </div>
  </div>

  <!-- QR: Show Modal -->
  <div id="qrModal" class="fixed inset-0 hidden z-50">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-md bg-white rounded-3xl border border-slate-200 shadow-xl overflow-hidden">
        <div class="p-4 border-b border-slate-200 flex items-center justify-between">
          <div>
            <div id="qrTitle" class="font-black text-slate-800">QR</div>
            <div class="text-xs text-slate-500">ç›¸æ‰‹ã®ç«¯æœ«ã§ã€ŒQRèª­å–ã€ã—ã¦ãã ã•ã„</div>
          </div>
          <button id="btnCloseQR" class="px-3 py-2 rounded-2xl bg-slate-200 font-black">é–‰ã˜ã‚‹</button>
        </div>
        <div class="p-4 space-y-3">
          <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3 flex items-center justify-center">
            <div id="qrBox"></div>
          </div>
          <div class="flex items-center justify-between">
            <div class="text-sm font-bold text-slate-700">ã‚³ãƒ¼ãƒ‰</div>
            <button id="btnCopyQRText" class="px-3 py-2 rounded-2xl bg-slate-200 font-black">ã‚³ãƒ”ãƒ¼</button>
          </div>
          <textarea id="qrText" class="w-full h-24 rounded-2xl border border-slate-200 p-3 text-xs font-mono" readonly></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- QR: Scan Modal -->
  <div id="scanModal" class="fixed inset-0 hidden z-50">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-md bg-white rounded-3xl border border-slate-200 shadow-xl overflow-hidden">
        <div class="p-4 border-b border-slate-200 flex items-center justify-between">
          <div>
            <div id="scanTitle" class="font-black text-slate-800">QRèª­å–</div>
            <div id="scanHint" class="text-xs text-slate-500">ã‚«ãƒ¡ãƒ©ã‚’å‘ã‘ã¦ãã ã•ã„</div>
          </div>
          <button id="btnCloseScan" class="px-3 py-2 rounded-2xl bg-slate-200 font-black">é–‰ã˜ã‚‹</button>
        </div>
        <div class="p-4 space-y-3">
          <div class="bg-slate-50 border border-slate-200 rounded-2xl p-2">
            <div id="qrReader" class="w-full"></div>
          </div>
          <div class="flex gap-2">
            <button id="btnSwitchCam" class="flex-1 px-3 py-2 rounded-2xl border border-slate-200 bg-white font-black">
              ğŸ” ã‚«ãƒ¡ãƒ©åˆ‡æ›¿
            </button>
            <button id="btnPasteToTarget" class="flex-1 px-3 py-2 rounded-2xl bg-emerald-600 text-white font-black">
              æ‰‹å‹•è²¼ä»˜ã«æˆ»ã‚‹
            </button>
          </div>
          <div class="text-xs text-slate-500">
            â€»iOSã¯è¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒå‡ºã¾ã™ã€‚æ‹’å¦ã™ã‚‹ã¨èª­å–ã§ãã¾ã›ã‚“ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // UI
  const uaHint = $("uaHint");
  const globalState = $("globalState");
  const btnModeSend = $("btnModeSend");
  const btnModeRecv = $("btnModeRecv");
  const sendView = $("sendView");
  const recvView = $("recvView");
  const pwEl = $("pw");
  const btnTogglePw = $("btnTogglePw");

  // Send UI
  const btnStartCam = $("btnStartCam");
  const btnStopAllSend = $("btnStopAllSend");
  const btnFlipCam = $("btnFlipCam");
  const btnMicMute = $("btnMicMute");
  const btnNightLocal = $("btnNightLocal");
  const btnTorch = $("btnTorch");
  const localVideo = $("localVideo");
  const camInfo = $("camInfo");
  const btnMakeOffer = $("btnMakeOffer");
  const btnCopyOffer = $("btnCopyOffer");
  const btnShowOfferQR = $("btnShowOfferQR");
  const offerOut = $("offerOut");
  const answerIn = $("answerIn");
  const btnScanAnswerQR = $("btnScanAnswerQR");
  const btnConnectSend = $("btnConnectSend");
  const sendConn = $("sendConn");
  const btnFullLocal = $("btnFullLocal");

  // Recv UI
  const btnResetRecv = $("btnResetRecv");
  const offerIn = $("offerIn");
  const btnScanOfferQR = $("btnScanOfferQR");
  const btnMakeAnswer = $("btnMakeAnswer");
  const answerOut = $("answerOut");
  const btnCopyAnswer = $("btnCopyAnswer");
  const btnShowAnswerQR = $("btnShowAnswerQR");
  const recvConn = $("recvConn");
  const remoteVideo = $("remoteVideo");
  const btnPlayRemote = $("btnPlayRemote");
  const btnSpkMute = $("btnSpkMute");
  const btnNightRemote = $("btnNightRemote");
  const btnFull = $("btnFull");
  const btnFullRemote = $("btnFullRemote");

  // QR Modals
  const qrModal = $("qrModal");
  const qrTitle = $("qrTitle");
  const qrBox = $("qrBox");
  const qrText = $("qrText");
  const btnCloseQR = $("btnCloseQR");
  const btnCopyQRText = $("btnCopyQRText");

  const scanModal = $("scanModal");
  const scanTitle = $("scanTitle");
  const scanHint = $("scanHint");
  const qrReader = $("qrReader");
  const btnCloseScan = $("btnCloseScan");
  const btnSwitchCam = $("btnSwitchCam");
  const btnPasteToTarget = $("btnPasteToTarget");

  uaHint.textContent = (navigator.userAgent.includes("iPhone") || navigator.userAgent.includes("iPad"))
    ? "iOSï¼ˆå†ç”Ÿãƒœã‚¿ãƒ³ãŒå¿…è¦ãªå ´åˆã‚ã‚Šï¼‰"
    : "OK";

  // ====== LAN-only WebRTC policy ======
  // STUN/TURNãªã— + hostå€™è£œã®ã¿ï¼ˆå¤–éƒ¨æ¥ç¶šã‚’é¿ã‘ã‚‹æ„å›³ï¼‰
  const pcConfig = { iceServers: [] };
  function isHostCandidate(candStr) { return / typ host /i.test(candStr); }

  // ====== Crypto (password-gated offer/answer) ======
  const te = new TextEncoder();
  const td = new TextDecoder();

  function b64uEncode(u8) {
    let s = btoa(String.fromCharCode(...u8));
    return s.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
  }
  function b64uDecode(s) {
    s = s.replace(/-/g, "+").replace(/_/g, "/");
    while (s.length % 4) s += "=";
    const bin = atob(s);
    const u8 = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) u8[i] = bin.charCodeAt(i);
    return u8;
  }

  async function deriveKey(pass, saltU8) {
    const baseKey = await crypto.subtle.importKey("raw", te.encode(pass), { name: "PBKDF2" }, false, ["deriveKey"]);
    return crypto.subtle.deriveKey(
      { name: "PBKDF2", salt: saltU8, iterations: 120000, hash: "SHA-256" },
      baseKey,
      { name: "AES-GCM", length: 256 },
      false,
      ["encrypt","decrypt"]
    );
  }

  async function encryptJSON(pass, obj) {
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const key = await deriveKey(pass, salt);
    const plain = te.encode(JSON.stringify(obj));
    const cipher = new Uint8Array(await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, plain));
    return "v1." + b64uEncode(salt) + "." + b64uEncode(iv) + "." + b64uEncode(cipher);
  }

  async function decryptJSON(pass, blob) {
    const parts = (blob || "").trim().split(".");
    if (parts.length !== 4 || parts[0] !== "v1") throw new Error("å½¢å¼ãŒä¸æ­£ã§ã™");
    const salt = b64uDecode(parts[1]);
    const iv = b64uDecode(parts[2]);
    const cipher = b64uDecode(parts[3]);
    const key = await deriveKey(pass, salt);
    const plainBuf = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, cipher);
    return JSON.parse(td.decode(new Uint8Array(plainBuf)));
  }

  function mustPw() {
    const p = (pwEl.value || "").trim();
    if (p.length < 4) throw new Error("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ4æ–‡å­—ä»¥ä¸Šæ¨å¥¨ï¼‰");
    return p;
  }

  async function safeCopy(text) {
    if (!text) return;
    try { await navigator.clipboard.writeText(text); }
    catch {
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
    }
  }

  // ===== Fullscreen helper =====
  async function requestVideoFullscreen(videoEl) {
    if (!videoEl) return;
    try {
      if (videoEl.requestFullscreen) await videoEl.requestFullscreen();
      else if (videoEl.webkitEnterFullscreen) videoEl.webkitEnterFullscreen(); // iOS
    } catch {}
  }

  // ===== QR: show modal =====
  function openQR(title, text) {
    qrTitle.textContent = title;
    qrText.value = text || "";
    qrBox.innerHTML = "";
    // QRç”Ÿæˆï¼ˆqrcodejsï¼‰
    try {
      new QRCode(qrBox, {
        text: text || "",
        width: 260,
        height: 260,
        correctLevel: QRCode.CorrectLevel.M
      });
    } catch {
      // ç”Ÿæˆå¤±æ•—æ™‚ã¯ä½•ã‚‚ã—ãªã„ï¼ˆã‚³ãƒ¼ãƒ‰ã¯æ®‹ã‚‹ï¼‰
    }
    qrModal.classList.remove("hidden");
  }
  function closeQR() {
    qrModal.classList.add("hidden");
    qrBox.innerHTML = "";
  }
  btnCloseQR.addEventListener("click", closeQR);
  btnCopyQRText.addEventListener("click", () => safeCopy(qrText.value));
  qrModal.addEventListener("click", (e) => { if (e.target === qrModal) closeQR(); });

  // ===== QR: scan modal =====
  let html5Qr = null;
  let scanTarget = null;
  let scanFacing = "environment";

  async function startScanner() {
    qrReader.innerHTML = "";
    html5Qr = new Html5Qrcode("qrReader");
    scanHint.textContent = "ã‚«ãƒ¡ãƒ©ã‚’å‘ã‘ã¦ãã ã•ã„ï¼ˆèª­ã¿å–ã‚‹ã¨è‡ªå‹•å…¥åŠ›ã—ã¾ã™ï¼‰";

    const config = { fps: 10, qrbox: { width: 240, height: 240 } };

    await html5Qr.start(
      { facingMode: scanFacing },
      config,
      async (decodedText) => {
        if (scanTarget) scanTarget.value = decodedText;
        await stopScanner(true);
        closeScan();
      },
      () => {}
    );
  }

  async function stopScanner(silent=false) {
    try {
      if (html5Qr) {
        await html5Qr.stop();
        await html5Qr.clear();
      }
    } catch (e) {
      if (!silent) console.log(e);
    } finally {
      html5Qr = null;
      qrReader.innerHTML = "";
    }
  }

  async function openScan(title, targetEl) {
    scanTitle.textContent = title;
    scanTarget = targetEl;
    scanModal.classList.remove("hidden");
    try {
      await startScanner();
    } catch (e) {
      scanHint.textContent = "ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ï¼ˆè¨±å¯/HTTPS/ä»–ã‚¢ãƒ—ãƒªä½¿ç”¨ä¸­ã‚’ç¢ºèªï¼‰";
      // ã“ã“ã§æ­¢ã‚ã¦ã‚‚è‰¯ã„ãŒã€UIã¯æ®‹ã™
    }
  }

  async function closeScan() {
    await stopScanner(true);
    scanModal.classList.add("hidden");
    scanTarget = null;
  }

  btnCloseScan.addEventListener("click", closeScan);
  btnPasteToTarget.addEventListener("click", closeScan);

  btnSwitchCam.addEventListener("click", async () => {
    scanFacing = (scanFacing === "environment") ? "user" : "environment";
    scanHint.textContent = "ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ä¸­â€¦";
    await stopScanner(true);
    try { await startScanner(); } catch { scanHint.textContent = "åˆ‡æ›¿ã«å¤±æ•—ï¼ˆæ‰‹å‹•è²¼ä»˜ã«æˆ»ã‚Œã¾ã™ï¼‰"; }
  });

  scanModal.addEventListener("click", (e) => { if (e.target === scanModal) closeScan(); });

  // ===== Mode =====
  function setMode(mode) {
    if (mode === "send") {
      sendView.classList.remove("hidden");
      recvView.classList.add("hidden");
      btnModeSend.className = "px-3 py-3 rounded-2xl font-black border border-slate-200 bg-sky-50 text-sky-700";
      btnModeRecv.className = "px-3 py-3 rounded-2xl font-black border border-slate-200 bg-white hover:bg-slate-100";
      globalState.textContent = "é€ä¿¡ãƒ¢ãƒ¼ãƒ‰";
    } else {
      recvView.classList.remove("hidden");
      sendView.classList.add("hidden");
      btnModeRecv.className = "px-3 py-3 rounded-2xl font-black border border-slate-200 bg-emerald-50 text-emerald-700";
      btnModeSend.className = "px-3 py-3 rounded-2xl font-black border border-slate-200 bg-white hover:bg-slate-100";
      globalState.textContent = "å—ä¿¡ãƒ¢ãƒ¼ãƒ‰";
    }
  }
  btnModeSend.addEventListener("click", () => setMode("send"));
  btnModeRecv.addEventListener("click", () => setMode("recv"));
  setMode("send");

  btnTogglePw.addEventListener("click", () => {
    const isPw = pwEl.type === "password";
    pwEl.type = isPw ? "text" : "password";
    btnTogglePw.textContent = isPw ? "éè¡¨ç¤º" : "è¡¨ç¤º";
  });

  // ====== Sender logic ======
  let sendPc = null;
  let sendStream = null;
  let currentFacing = "environment";
  let micOn = true;
  let nightLocalOn = false;
  let torchOn = false;

  async function startCameraHighest() {
    const constraints = {
      audio: true,
      video: {
        facingMode: { ideal: currentFacing },
        width: { ideal: 3840 },
        height: { ideal: 2160 },
        frameRate: { ideal: 30, max: 60 }
      }
    };

    sendStream = await navigator.mediaDevices.getUserMedia(constraints);
    localVideo.srcObject = sendStream;

    btnStopAllSend.disabled = false;
    btnFlipCam.disabled = false;
    btnMicMute.disabled = false;
    btnNightLocal.disabled = false;
    btnTorch.disabled = false;
    btnMakeOffer.disabled = false;
    btnFullLocal.disabled = false;

    const vtrack = sendStream.getVideoTracks()[0];
    const atrack = sendStream.getAudioTracks()[0];
    const s = vtrack.getSettings ? vtrack.getSettings() : {};
    camInfo.textContent = [
      `è§£åƒåº¦ï¼š${s.width || "?"} x ${s.height || "?"}`,
      `FPSï¼š${s.frameRate || "?"}`,
      `ã‚«ãƒ¡ãƒ©ï¼š${(s.facingMode || currentFacing)}`,
      `éŸ³å£°ï¼š${atrack ? "æœ‰åŠ¹" : "ãªã—"}`
    ].join(" / ");

    sendConn.textContent = "é…ä¿¡ä¸­ï¼ˆOfferä½œæˆã¸ï¼‰";
  }

  function stopSenderAll() {
    try { if (sendPc) sendPc.close(); } catch {}
    sendPc = null;

    if (sendStream) sendStream.getTracks().forEach(t => t.stop());
    sendStream = null;

    offerOut.value = "";
    answerIn.value = "";
    btnCopyOffer.disabled = true;
    btnConnectSend.disabled = true;
    btnShowOfferQR.disabled = true;
    btnScanAnswerQR.disabled = true;

    btnStopAllSend.disabled = true;
    btnFlipCam.disabled = true;
    btnMicMute.disabled = true;
    btnNightLocal.disabled = true;
    btnTorch.disabled = true;
    btnMakeOffer.disabled = true;
    btnFullLocal.disabled = true;

    micOn = true;
    btnMicMute.textContent = "ğŸ¤ ãƒã‚¤ã‚¯ï¼šON";
    nightLocalOn = false;
    localVideo.classList.remove("night");
    btnNightLocal.textContent = "ğŸŒ™ æš—è¦–ï¼šOFF";
    torchOn = false;
    btnTorch.textContent = "ğŸ”¦ ãƒ©ã‚¤ãƒˆï¼šOFF";
    btnTorch.disabled = true; // å†é–‹æ™‚ã«å†è©•ä¾¡
    camInfo.textContent = "æœªé–‹å§‹";

    sendConn.textContent = "åœæ­¢";
  }

  async function flipCamera() {
    currentFacing = (currentFacing === "environment") ? "user" : "environment";
    // restart stream
    if (sendStream) sendStream.getTracks().forEach(t => t.stop());
    sendStream = null;
    await startCameraHighest();
  }

  function toggleMic() {
    if (!sendStream) return;
    const atrack = sendStream.getAudioTracks()[0];
    if (!atrack) return;
    micOn = !micOn;
    atrack.enabled = micOn;
    btnMicMute.textContent = micOn ? "ğŸ¤ ãƒã‚¤ã‚¯ï¼šON" : "ğŸ¤ ãƒã‚¤ã‚¯ï¼šMUTE";
  }

  function toggleNightLocal() {
    nightLocalOn = !nightLocalOn;
    localVideo.classList.toggle("night", nightLocalOn);
    btnNightLocal.textContent = nightLocalOn ? "ğŸŒ™ æš—è¦–ï¼šON" : "ğŸŒ™ æš—è¦–ï¼šOFF";
  }

  async function toggleTorch() {
    if (!sendStream) return;
    const vtrack = sendStream.getVideoTracks()[0];
    if (!vtrack) return;
    try {
      torchOn = !torchOn;
      await vtrack.applyConstraints({ advanced: [{ torch: torchOn }] });
      btnTorch.textContent = torchOn ? "ğŸ”¦ ãƒ©ã‚¤ãƒˆï¼šON" : "ğŸ”¦ ãƒ©ã‚¤ãƒˆï¼šOFF";
      btnTorch.disabled = false;
    } catch {
      torchOn = false;
      btnTorch.textContent = "ğŸ”¦ ãƒ©ã‚¤ãƒˆï¼šéå¯¾å¿œ";
      btnTorch.disabled = true;
    }
  }

  function waitIceComplete(pc, timeoutMs=1500) {
    return new Promise(resolve => {
      if (pc.iceGatheringState === "complete") return resolve();
      const t = setTimeout(() => {
        pc.removeEventListener("icegatheringstatechange", onChange);
        resolve();
      }, timeoutMs);
      function onChange() {
        if (pc.iceGatheringState === "complete") {
          clearTimeout(t);
          pc.removeEventListener("icegatheringstatechange", onChange);
          resolve();
        }
      }
      pc.addEventListener("icegatheringstatechange", onChange);
    });
  }

  async function makeOfferEncrypted() {
    const pass = mustPw();
    if (!sendStream) throw new Error("å…ˆã«ã€Œã‚«ãƒ¡ãƒ©é–‹å§‹ã€ã‚’ã—ã¦ãã ã•ã„ã€‚");

    sendPc = new RTCPeerConnection(pcConfig);
    sendStream.getTracks().forEach(tr => sendPc.addTrack(tr, sendStream));

    const candidates = [];
    sendPc.onicecandidate = (e) => {
      if (!e.candidate) return;
      const s = e.candidate.candidate || "";
      if (isHostCandidate(s)) candidates.push(e.candidate);
    };
    sendPc.onconnectionstatechange = () => { sendConn.textContent = sendPc.connectionState; };

    const offer = await sendPc.createOffer();
    await sendPc.setLocalDescription(offer);
    await waitIceComplete(sendPc);

    const payload = { sdp: sendPc.localDescription, candidates };
    const blob = await encryptJSON(pass, payload);

    offerOut.value = blob;
    btnCopyOffer.disabled = false;
    btnConnectSend.disabled = false;
    btnShowOfferQR.disabled = false;
    btnScanAnswerQR.disabled = false;
    sendConn.textContent = "Offerä½œæˆæ¸ˆï¼ˆå—ä¿¡å´ã¸ï¼‰";
  }

  async function connectWithEncryptedAnswer() {
    const pass = mustPw();
    if (!sendPc) throw new Error("å…ˆã«ã€ŒOfferä½œæˆã€ã‚’ã—ã¦ãã ã•ã„ã€‚");
    const blob = (answerIn.value || "").trim();
    if (!blob) throw new Error("Answerã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã‚‹ï¼ˆã¾ãŸã¯QRèª­å–ï¼‰ã—ã¦ãã ã•ã„ã€‚");

    let payload;
    try { payload = await decryptJSON(pass, blob); }
    catch { throw new Error("å¾©å·ã«å¤±æ•—ï¼šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã„ï¼ã‚³ãƒ¼ãƒ‰ç ´æã®å¯èƒ½æ€§ã€‚"); }

    await sendPc.setRemoteDescription(payload.sdp);
    if (Array.isArray(payload.candidates)) {
      for (const c of payload.candidates) {
        const s = c.candidate || "";
        if (isHostCandidate(s)) { try { await sendPc.addIceCandidate(c); } catch {} }
      }
    }
    sendConn.textContent = "æ¥ç¶šä¸­â€¦";
  }

  btnStartCam.addEventListener("click", async () => {
    try {
      globalState.textContent = "é€ä¿¡ï¼šã‚«ãƒ¡ãƒ©é–‹å§‹ä¸­â€¦";
      btnTorch.disabled = false; // å†åˆ¤å®šã®ãŸã‚
      await startCameraHighest();
      globalState.textContent = "é€ä¿¡ï¼šæº–å‚™OK";
      // Torchå¯¾å¿œã¯æŠ¼ã—ã¦åˆ¤å®šï¼ˆapplyConstraintsã§è½ã¡ã‚‹ç«¯æœ«ãŒã‚ã‚‹ãŸã‚ï¼‰
    } catch {
      globalState.textContent = "ã‚¨ãƒ©ãƒ¼";
      alert("ã‚«ãƒ¡ãƒ©/ãƒã‚¤ã‚¯ã®è¨±å¯ãŒå¿…è¦ã§ã™ï¼ˆHTTPSã§é–‹ã„ã¦ãã ã•ã„ï¼‰ã€‚");
    }
  });

  btnStopAllSend.addEventListener("click", stopSenderAll);
  btnFlipCam.addEventListener("click", async () => { try { await flipCamera(); } catch { alert("ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ã«å¤±æ•—ã—ã¾ã—ãŸ"); } });
  btnMicMute.addEventListener("click", toggleMic);
  btnNightLocal.addEventListener("click", toggleNightLocal);
  btnTorch.addEventListener("click", toggleTorch);

  btnMakeOffer.addEventListener("click", async () => {
    try {
      globalState.textContent = "é€ä¿¡ï¼šOfferä½œæˆä¸­â€¦";
      await makeOfferEncrypted();
      globalState.textContent = "é€ä¿¡ï¼šOfferä½œæˆæ¸ˆ";
    } catch (e) {
      globalState.textContent = "ã‚¨ãƒ©ãƒ¼";
      alert(e.message || "Offerä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  });

  btnCopyOffer.addEventListener("click", () => safeCopy(offerOut.value));
  btnShowOfferQR.addEventListener("click", () => openQR("Offerï¼ˆå—ä¿¡å´ã§QRèª­å–ï¼‰", offerOut.value));

  btnScanAnswerQR.addEventListener("click", async () => {
    try { mustPw(); await openScan("Answer QRèª­å–ï¼ˆé€ä¿¡å´ï¼‰", answerIn); }
    catch (e) { alert(e.message || "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…ˆã«å…¥åŠ›ã—ã¦ãã ã•ã„"); }
  });

  btnConnectSend.addEventListener("click", async () => {
    try {
      globalState.textContent = "é€ä¿¡ï¼šæ¥ç¶šä¸­â€¦";
      await connectWithEncryptedAnswer();
      globalState.textContent = "é€ä¿¡ï¼šæ¥ç¶šå‡¦ç†OKï¼ˆçŠ¶æ…‹ã‚’ç¢ºèªï¼‰";
    } catch (e) {
      globalState.textContent = "ã‚¨ãƒ©ãƒ¼";
      alert(e.message || "æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  });

  btnFullLocal.addEventListener("click", () => requestVideoFullscreen(localVideo));
  localVideo.addEventListener("dblclick", () => requestVideoFullscreen(localVideo));

  // ====== Receiver logic ======
  let recvPc = null;
  let recvStream = null;
  let spkOn = true;
  let nightRemoteOn = false;

  function resetReceiverAll() {
    try { if (recvPc) recvPc.close(); } catch {}
    recvPc = null;
    recvStream = null;
    remoteVideo.srcObject = null;

    answerOut.value = "";
    btnCopyAnswer.disabled = true;
    btnShowAnswerQR.disabled = true;
    btnPlayRemote.disabled = true;
    btnSpkMute.disabled = true;
    btnNightRemote.disabled = true;
    btnFull.disabled = true;
    btnFullRemote.disabled = true;
    btnResetRecv.disabled = true;

    spkOn = true;
    remoteVideo.muted = false;
    btnSpkMute.textContent = "ğŸ”ˆ éŸ³ï¼šON";
    nightRemoteOn = false;
    remoteVideo.classList.remove("night");
    btnNightRemote.textContent = "ğŸŒ™ æš—è¦–ï¼šOFF";

    recvConn.textContent = "æœªæ¥ç¶š";
    globalState.textContent = "å—ä¿¡ï¼šå¾…æ©Ÿä¸­";
  }

  async function makeAnswerEncrypted() {
    const pass = mustPw();
    const blob = (offerIn.value || "").trim();
    if (!blob) throw new Error("Offerã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã‚‹ï¼ˆã¾ãŸã¯QRèª­å–ï¼‰ã—ã¦ãã ã•ã„ã€‚");

    let offerPayload;
    try { offerPayload = await decryptJSON(pass, blob); }
    catch { throw new Error("å¾©å·ã«å¤±æ•—ï¼šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã„ï¼ã‚³ãƒ¼ãƒ‰ç ´æã®å¯èƒ½æ€§ã€‚"); }

    recvPc = new RTCPeerConnection(pcConfig);

    const candidates = [];
    recvPc.onicecandidate = (e) => {
      if (!e.candidate) return;
      const s = e.candidate.candidate || "";
      if (isHostCandidate(s)) candidates.push(e.candidate);
    };

    recvPc.ontrack = (e) => {
      if (!recvStream) recvStream = new MediaStream();
      recvStream.addTrack(e.track);
      remoteVideo.srcObject = recvStream;

      btnPlayRemote.disabled = false;
      btnSpkMute.disabled = false;
      btnNightRemote.disabled = false;
      btnFull.disabled = false;
      btnFullRemote.disabled = false;
      btnResetRecv.disabled = false;

      remoteVideo.play().catch(() => {});
    };

    recvPc.onconnectionstatechange = () => { recvConn.textContent = recvPc.connectionState; };

    await recvPc.setRemoteDescription(offerPayload.sdp);
    if (Array.isArray(offerPayload.candidates)) {
      for (const c of offerPayload.candidates) {
        const s = c.candidate || "";
        if (isHostCandidate(s)) { try { await recvPc.addIceCandidate(c); } catch {} }
      }
    }

    const answer = await recvPc.createAnswer();
    await recvPc.setLocalDescription(answer);
    await waitIceComplete(recvPc);

    const payload = { sdp: recvPc.localDescription, candidates };
    const outBlob = await encryptJSON(pass, payload);

    answerOut.value = outBlob;
    btnCopyAnswer.disabled = false;
    btnShowAnswerQR.disabled = false;
    btnResetRecv.disabled = false;

    globalState.textContent = "å—ä¿¡ï¼šAnswerä½œæˆæ¸ˆï¼ˆé€ä¿¡å´ã¸è¿”ã™ï¼‰";
    recvConn.textContent = "Answerä½œæˆæ¸ˆ";
  }

  btnMakeAnswer.addEventListener("click", async () => {
    try {
      globalState.textContent = "å—ä¿¡ï¼šAnswerä½œæˆä¸­â€¦";
      await makeAnswerEncrypted();
    } catch (e) {
      globalState.textContent = "ã‚¨ãƒ©ãƒ¼";
      alert(e.message || "Answerä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  });

  btnCopyAnswer.addEventListener("click", () => safeCopy(answerOut.value));
  btnShowAnswerQR.addEventListener("click", () => openQR("Answerï¼ˆé€ä¿¡å´ã§QRèª­å–ï¼‰", answerOut.value));

  btnScanOfferQR.addEventListener("click", async () => {
    try { mustPw(); await openScan("Offer QRèª­å–ï¼ˆå—ä¿¡å´ï¼‰", offerIn); }
    catch (e) { alert(e.message || "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…ˆã«å…¥åŠ›ã—ã¦ãã ã•ã„"); }
  });

  btnPlayRemote.addEventListener("click", async () => { try { await remoteVideo.play(); } catch {} });

  btnSpkMute.addEventListener("click", () => {
    spkOn = !spkOn;
    remoteVideo.muted = !spkOn;
    btnSpkMute.textContent = spkOn ? "ğŸ”ˆ éŸ³ï¼šON" : "ğŸ”‡ éŸ³ï¼šMUTE";
  });

  btnNightRemote.addEventListener("click", () => {
    nightRemoteOn = !nightRemoteOn;
    remoteVideo.classList.toggle("night", nightRemoteOn);
    btnNightRemote.textContent = nightRemoteOn ? "ğŸŒ™ æš—è¦–ï¼šON" : "ğŸŒ™ æš—è¦–ï¼šOFF";
  });

  btnFull.addEventListener("click", () => requestVideoFullscreen(remoteVideo));
  btnFullRemote.addEventListener("click", () => requestVideoFullscreen(remoteVideo));
  remoteVideo.addEventListener("dblclick", () => requestVideoFullscreen(remoteVideo));

  btnResetRecv.addEventListener("click", resetReceiverAll);

  // ===== enable/disable helpers for scan buttons =====
  // é€ä¿¡å´ï¼šAnswerQRèª­å–ã¯ Offerä½œæˆå¾Œã«æœ‰åŠ¹åŒ–ã—ã¦ã„ã‚‹
  // å—ä¿¡å´ï¼šOfferQRèª­å–ã¯å¸¸ã«OKï¼ˆãŸã ã—ãƒ‘ã‚¹å…¥åŠ›å¿…é ˆï¼‰

  // ====== Basic Cleanup ======
  window.addEventListener("beforeunload", async () => {
    stopSenderAll();
    resetReceiverAll();
    await closeScan();
    closeQR();
  });

  // Init
  resetReceiverAll();
  btnTorch.disabled = true;
})();
</script>
</body>
</html>
