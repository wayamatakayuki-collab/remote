<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ãƒ™ãƒ“ãƒ¼ãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼ˆLANé™å®š / 1ãƒ•ã‚¡ã‚¤ãƒ« / QRã®ã¿ï¼‰</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- QRç”Ÿæˆï¼ˆè¡¨ç¤ºï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <!-- QRèª­å–ï¼ˆã‚¹ã‚­ãƒ£ãƒ³ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <style>
    body { -webkit-tap-highlight-color: transparent; }
    video { background:#000; }
    .night { filter: brightness(1.9) contrast(1.45) saturate(0.85); }
  </style>
</head>

<body class="bg-slate-50 text-slate-800">
  <div class="max-w-4xl mx-auto p-4 space-y-4">
    <!-- Header -->
    <header class="space-y-2">
      <div class="flex items-center justify-between gap-2 flex-wrap">
        <div class="text-xl font-black">ãƒ™ãƒ“ãƒ¼ãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼ˆåŒã˜Wi-Fiå†… / QRã®ã¿ / 1ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰</div>
        <div class="text-xs font-bold px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">
          LANé™å®šï¼ˆå¤–éƒ¨æ¥ç¶šä¸å¯æƒ³å®šï¼‰
        </div>
      </div>
      <div class="text-xs text-slate-500 leading-relaxed">
        â€»HTTPSå¿…é ˆï¼ˆGitHub Pagesç­‰ï¼‰ã€‚åŒã˜Wi-Fiå†…ã§ä½¿ã£ã¦ãã ã•ã„ï¼ˆã‚²ã‚¹ãƒˆWi-Fiã®ç«¯æœ«éš”é›¢ãŒã‚ã‚‹ã¨æ¥ç¶šã§ãã¾ã›ã‚“ï¼‰ã€‚<br/>
        â€»åŒ»ç™‚æ©Ÿå™¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚çŸ­æ™‚é–“ã®â€œè£œåŠ©â€ç”¨é€”ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚
      </div>
    </header>

    <!-- Mode -->
    <section class="bg-white rounded-3xl border border-slate-200 p-4 space-y-4 shadow-sm">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="font-black text-slate-700">0ï¼‰ãƒ¢ãƒ¼ãƒ‰é¸æŠ</div>
        <div class="text-xs text-slate-500">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸è¦ï¼QRã ã‘ã§æ¥ç¶š</div>
      </div>

      <div class="grid md:grid-cols-2 gap-3">
        <div class="bg-slate-50 rounded-2xl p-3 border border-slate-200">
          <div class="text-sm font-bold text-slate-700 mb-2">ãƒ¢ãƒ¼ãƒ‰</div>
          <div class="grid grid-cols-2 gap-2">
            <button id="btnModeSend" class="px-3 py-3 rounded-2xl font-black border border-slate-200 bg-white hover:bg-slate-100 active:scale-[0.99]">
              ğŸ‘¶ é€ä¿¡ï¼ˆãƒ™ãƒ“ãƒ¼å´ï¼‰
            </button>
            <button id="btnModeRecv" class="px-3 py-3 rounded-2xl font-black border border-slate-200 bg-white hover:bg-slate-100 active:scale-[0.99]">
              ğŸ‘€ å—ä¿¡ï¼ˆè¦‹å®ˆã‚Šå´ï¼‰
            </button>
          </div>
          <div class="mt-2 text-xs text-slate-500">
            åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’2å°ã§é–‹ãã€ç‰‡æ–¹ã‚’é€ä¿¡ãƒ»ã‚‚ã†ç‰‡æ–¹ã‚’å—ä¿¡ã«ã—ã¾ã™ã€‚
          </div>
        </div>

        <div class="bg-slate-50 rounded-2xl p-3 border border-slate-200 space-y-2">
          <div class="text-sm font-bold text-slate-700">çŠ¶æ…‹</div>
          <div class="text-sm">
            <span class="text-slate-500">ç¾åœ¨ï¼š</span><span id="globalState" class="font-black text-slate-700">å¾…æ©Ÿä¸­</span>
          </div>
          <div class="text-xs text-slate-500">
            ãƒ’ãƒ³ãƒˆï¼š<span id="uaHint"></span><br/>
            â€»iPhone/iPadã¯å—ä¿¡å´ã§ã€Œâ–¶å†ç”Ÿã€ã‚’æŠ¼ã™ã¨å®‰å®šã—ã¾ã™ã€‚
          </div>
        </div>
      </div>
    </section>

    <!-- SEND VIEW -->
    <section id="sendView" class="space-y-4 hidden">
      <section class="bg-white rounded-3xl border border-slate-200 p-4 space-y-4 shadow-sm">
        <div class="flex items-center justify-between gap-2 flex-wrap">
          <div class="font-black text-slate-700">é€ä¿¡ï¼ˆãƒ™ãƒ“ãƒ¼å´ï¼‰</div>
          <div class="flex items-center gap-2">
            <button id="btnStartCam" class="px-4 py-2 rounded-2xl bg-sky-600 text-white font-black active:scale-[0.99]">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
            <button id="btnStopAllSend" class="px-4 py-2 rounded-2xl bg-slate-200 font-black active:scale-[0.99]" disabled>åœæ­¢</button>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <!-- Preview -->
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <div class="text-sm font-bold text-slate-600">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
              <button id="btnFullLocal" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold active:scale-[0.99]" disabled>â›¶ å…¨ç”»é¢</button>
            </div>
            <video id="localVideo" class="w-full rounded-3xl aspect-video" playsinline muted autoplay></video>

            <div class="grid grid-cols-2 gap-2">
              <button id="btnFlipCam" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold active:scale-[0.99]" disabled>ğŸ“· å‰/å¾Œåˆ‡æ›¿</button>
              <button id="btnMicMute" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold active:scale-[0.99]" disabled>ğŸ¤ ãƒã‚¤ã‚¯ï¼šON</button>
              <button id="btnNightLocal" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold active:scale-[0.99]" disabled>ğŸŒ™ æš—è¦–ï¼šOFF</button>
              <button id="btnTorch" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold active:scale-[0.99]" disabled>ğŸ”¦ ãƒ©ã‚¤ãƒˆï¼šOFF</button>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3 text-xs text-slate-600">
              <div class="font-bold text-slate-700 mb-1">å®Ÿéš›ã®æ’®å½±è¨­å®š</div>
              <div id="camInfo">æœªé–‹å§‹</div>
              <div class="mt-1 text-slate-500">â€»ã€Œæœ€é«˜ç”»è³ªã€ã‚’ç†æƒ³å€¤ã§è¦æ±‚ã—ã€ç«¯æœ«ãŒå¯èƒ½ãªæœ€å¤§ã«å¯„ã›ã¾ã™ã€‚</div>
            </div>

            <div class="text-xs text-slate-500">
              â€»æš—è¦–ã¯ã€Œç–‘ä¼¼ï¼ˆæ˜ã‚‹ã•/ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·èª¿ï¼‰ã€ã§ã™ã€‚èµ¤å¤–ç·šæš—è¦–ã¯ç«¯æœ«ãƒãƒ¼ãƒ‰ä¾å­˜ã§ã€Webã‚¢ãƒ—ãƒªã‹ã‚‰è¿½åŠ ã§ãã¾ã›ã‚“ã€‚
            </div>
          </div>

          <!-- Flow -->
          <div class="space-y-3">
            <div class="bg-indigo-50 border border-indigo-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-indigo-900">1ï¼‰Offerã®QRã‚’è¡¨ç¤º</div>
              <div class="text-indigo-700 text-xs mt-1">æŠ¼ã™ã¨ã™ãQRç”»é¢ãŒå‡ºã¾ã™ï¼ˆè£ã§Offerç”Ÿæˆï¼‰</div>
              <div class="mt-2">
                <button id="btnShowOfferQRNow" class="w-full px-4 py-4 rounded-3xl bg-indigo-600 text-white font-black text-base active:scale-[0.99]" disabled>
                  ğŸ“· Offer QR ã‚’è¡¨ç¤ºã™ã‚‹
                </button>
              </div>
            </div>

            <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-emerald-900">2ï¼‰Answerã‚’èª­ã¿å–ã‚‹ã¨è‡ªå‹•æ¥ç¶š</div>
              <div class="text-emerald-700 text-xs mt-1">å—ä¿¡å´ãŒè¿”ã—ãŸAnswerã®QRã‚’èª­ã¿å–ã‚Šã¾ã™</div>
              <div class="mt-2">
                <button id="btnScanAnswerQR" class="w-full px-4 py-4 rounded-3xl border border-emerald-200 bg-white font-black text-base active:scale-[0.99]" disabled>
                  ğŸ“· Answer QR ã‚’èª­å– â†’ è‡ªå‹•æ¥ç¶š
                </button>
              </div>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-slate-700">æ¥ç¶šçŠ¶æ…‹</div>
              <div class="mt-1 text-sm">Peerï¼š<span id="sendConn" class="font-black">æœªæ¥ç¶š</span></div>
              <div class="text-xs text-slate-500 mt-1">â€»LANå€™è£œã®ã¿ï¼ˆå¤–éƒ¨ã‹ã‚‰ã¯åŸºæœ¬æ¥ç¶šä¸å¯ã®ä½œã‚Šï¼‰</div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <!-- RECV VIEW -->
    <section id="recvView" class="space-y-4 hidden">
      <section class="bg-white rounded-3xl border border-slate-200 p-4 space-y-4 shadow-sm">
        <div class="flex items-center justify-between gap-2 flex-wrap">
          <div class="font-black text-slate-700">å—ä¿¡ï¼ˆè¦‹å®ˆã‚Šå´ï¼‰</div>
          <div class="flex items-center gap-2">
            <button id="btnResetRecv" class="px-4 py-2 rounded-2xl bg-slate-200 font-black active:scale-[0.99]" disabled>åˆ‡æ–­/ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <!-- Offer/Answer -->
          <div class="space-y-2">
            <div class="bg-indigo-50 border border-indigo-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-indigo-900">1ï¼‰Offerã‚’èª­å– â†’ Answerã®QRã‚’è‡ªå‹•è¡¨ç¤º</div>
              <div class="text-indigo-700 text-xs mt-1">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€é€ä¿¡å´ã®Offer QRã‚’èª­ã¿å–ã‚‹ã ã‘</div>
              <div class="mt-2">
                <button id="btnScanOfferQR" class="w-full px-4 py-4 rounded-3xl border border-indigo-200 bg-white font-black text-base active:scale-[0.99]">
                  ğŸ“· Offer QR ã‚’èª­å–ï¼ˆè‡ªå‹•ã§Answerè¡¨ç¤ºï¼‰
                </button>
              </div>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-slate-700">æ¥ç¶šçŠ¶æ…‹</div>
              <div class="mt-1 text-sm">Peerï¼š<span id="recvConn" class="font-black">æœªæ¥ç¶š</span></div>
              <div class="text-xs text-slate-500 mt-1">iPhone/iPadã¯è‡ªå‹•å†ç”Ÿåˆ¶é™ãŒã‚ã‚‹ãŸã‚ã€Œâ–¶å†ç”Ÿã€ã‚’æŠ¼ã™ã¨å®‰å®šã—ã¾ã™ã€‚</div>
            </div>
          </div>

          <!-- Video -->
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <div class="text-sm font-bold text-slate-600">å—ä¿¡æ˜ åƒ</div>
              <button id="btnFullRemote" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold active:scale-[0.99]" disabled>â›¶ å…¨ç”»é¢</button>
            </div>
            <video id="remoteVideo" class="w-full rounded-3xl aspect-video" playsinline autoplay></video>

            <div class="grid grid-cols-2 gap-2">
              <button id="btnPlayRemote" class="px-3 py-2 rounded-2xl bg-emerald-600 text-white font-black active:scale-[0.99]" disabled>â–¶ å†ç”Ÿ</button>
              <button id="btnSpkMute" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold active:scale-[0.99]" disabled>ğŸ”ˆ éŸ³ï¼šON</button>
              <button id="btnNightRemote" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold active:scale-[0.99]" disabled>ğŸŒ™ æš—è¦–ï¼šOFF</button>
              <button id="btnFullAlt" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold active:scale-[0.99]" disabled>â›¶ï¼ˆä»£æ›¿ï¼‰</button>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3 text-xs text-slate-600">
              <div class="font-bold text-slate-700 mb-1">ãƒ¡ãƒ¢</div>
              <ul class="list-disc pl-5 space-y-1">
                <li>å¤–éƒ¨å›ç·šã‹ã‚‰ã¯æ¥ç¶šä¸å¯æƒ³å®šï¼ˆLANå€™è£œã®ã¿ï¼‰ã€‚</li>
                <li>åŒã˜Wi-Fiã§ã‚‚ã€Œç«¯æœ«éš”é›¢ã€ãŒã‚ã‚‹ã¨æ¥ç¶šã§ãã¾ã›ã‚“ã€‚</li>
              </ul>
            </div>
          </div>
        </div>
      </section>
    </section>

    <div class="text-[11px] text-slate-500 px-1">
      âœ… ä»•æ§˜ï¼šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã—ï¼ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãªã—ã€‚QRã®èª­ã¿å–ã‚Šã ã‘ã§æ¥ç¶šã—ã¾ã™ã€‚
    </div>
  </div>

  <!-- QR: Show Modal -->
  <div id="qrModal" class="fixed inset-0 hidden z-50">
    <div class="absolute inset-0 bg-black/55"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-md bg-white rounded-3xl border border-slate-200 shadow-xl overflow-hidden">
        <div class="p-4 border-b border-slate-200 flex items-center justify-between">
          <div>
            <div id="qrTitle" class="font-black text-slate-800">QR</div>
            <div id="qrMeta" class="text-[11px] text-slate-500 mt-0.5"></div>
            <div class="text-xs text-slate-500">ç›¸æ‰‹ã®ç«¯æœ«ã§ã€ŒQRèª­å–ã€ã—ã¦ãã ã•ã„</div>
          </div>
          <button id="btnCloseQR" class="px-3 py-2 rounded-2xl bg-slate-200 font-black active:scale-[0.99]">é–‰ã˜ã‚‹</button>
        </div>
        <div class="p-4 space-y-3">
          <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3 flex items-center justify-center">
            <div id="qrBox"></div>
          </div>
          <div id="qrFoot" class="text-[11px] text-slate-500">
            â€»é•·ã„å ´åˆã¯ã€Œåˆ†å‰²QRã€ã‚’è‡ªå‹•ã§åˆ‡ã‚Šæ›¿ãˆã¦è¡¨ç¤ºã—ã¾ã™ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- QR: Scan Modal -->
  <div id="scanModal" class="fixed inset-0 hidden z-50">
    <div class="absolute inset-0 bg-black/65"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-md bg-white rounded-3xl border border-slate-200 shadow-xl overflow-hidden">
        <div class="p-4 border-b border-slate-200 flex items-center justify-between">
          <div>
            <div id="scanTitle" class="font-black text-slate-800">QRèª­å–</div>
            <div id="scanHint" class="text-xs text-slate-500">ã‚«ãƒ¡ãƒ©ã‚’å‘ã‘ã¦ãã ã•ã„</div>
            <div id="scanProgress" class="text-xs font-black text-slate-600 mt-1"></div>
          </div>
          <button id="btnCloseScan" class="px-3 py-2 rounded-2xl bg-slate-200 font-black active:scale-[0.99]">é–‰ã˜ã‚‹</button>
        </div>
        <div class="p-4 space-y-3">
          <div class="bg-slate-50 border border-slate-200 rounded-2xl p-2">
            <div id="qrReader" class="w-full"></div>
          </div>
          <div class="flex gap-2">
            <button id="btnSwitchCam" class="flex-1 px-3 py-2 rounded-2xl border border-slate-200 bg-white font-black active:scale-[0.99]">
              ğŸ” ã‚«ãƒ¡ãƒ©åˆ‡æ›¿
            </button>
            <button id="btnCloseScan2" class="flex-1 px-3 py-2 rounded-2xl bg-emerald-600 text-white font-black active:scale-[0.99]">
              é–‰ã˜ã‚‹
            </button>
          </div>
          <div class="text-xs text-slate-500">
            â€»iOSã¯è¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒå‡ºã¾ã™ã€‚æ‹’å¦ã™ã‚‹ã¨èª­å–ã§ãã¾ã›ã‚“ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // UI
  const uaHint = $("uaHint");
  const globalState = $("globalState");
  const btnModeSend = $("btnModeSend");
  const btnModeRecv = $("btnModeRecv");
  const sendView = $("sendView");
  const recvView = $("recvView");

  // Send UI
  const btnStartCam = $("btnStartCam");
  const btnStopAllSend = $("btnStopAllSend");
  const btnFlipCam = $("btnFlipCam");
  const btnMicMute = $("btnMicMute");
  const btnNightLocal = $("btnNightLocal");
  const btnTorch = $("btnTorch");
  const localVideo = $("localVideo");
  const camInfo = $("camInfo");
  const btnShowOfferQRNow = $("btnShowOfferQRNow");
  const btnScanAnswerQR = $("btnScanAnswerQR");
  const sendConn = $("sendConn");
  const btnFullLocal = $("btnFullLocal");

  // Recv UI
  const btnResetRecv = $("btnResetRecv");
  const btnScanOfferQR = $("btnScanOfferQR");
  const recvConn = $("recvConn");
  const remoteVideo = $("remoteVideo");
  const btnPlayRemote = $("btnPlayRemote");
  const btnSpkMute = $("btnSpkMute");
  const btnNightRemote = $("btnNightRemote");
  const btnFullAlt = $("btnFullAlt");
  const btnFullRemote = $("btnFullRemote");

  // QR Modals
  const qrModal = $("qrModal");
  const qrTitle = $("qrTitle");
  const qrMeta = $("qrMeta");
  const qrBox = $("qrBox");
  const btnCloseQR = $("btnCloseQR");

  const scanModal = $("scanModal");
  const scanTitle = $("scanTitle");
  const scanHint = $("scanHint");
  const scanProgress = $("scanProgress");
  const qrReader = $("qrReader");
  const btnCloseScan = $("btnCloseScan");
  const btnCloseScan2 = $("btnCloseScan2");
  const btnSwitchCam = $("btnSwitchCam");

  uaHint.textContent = (navigator.userAgent.includes("iPhone") || navigator.userAgent.includes("iPad"))
    ? "iOSï¼ˆå—ä¿¡å´ã¯â–¶å†ç”ŸãŒå¿…è¦ãªå ´åˆã‚ã‚Šï¼‰"
    : "OK";

  // ====== LAN-only WebRTC policy ======
  // STUN/TURNãªã—ï¼ˆå¤–éƒ¨æ¥ç¶šã‚’é¿ã‘ã‚‹æ„å›³ï¼‰
  const pcConfig = { iceServers: [] };

  function isHostCandidateLine(line) {
    // a=candidate:... typ host ...
    return / typ host /i.test(line);
  }

  function filterHostCandidatesInSdp(sdp) {
    const lines = (sdp || "").split(/\r\n|\n/);
    const kept = [];
    for (const line of lines) {
      if (line.startsWith("a=candidate:")) {
        if (isHostCandidateLine(line)) kept.push(line);
      } else {
        kept.push(line);
      }
    }
    // SDPã¯CRLFæ¨å¥¨
    return kept.join("\r\n").trim() + "\r\n";
  }

  // ===== Fullscreen helper =====
  async function requestVideoFullscreen(videoEl) {
    if (!videoEl) return;
    try {
      if (videoEl.requestFullscreen) await videoEl.requestFullscreen();
      else if (videoEl.webkitEnterFullscreen) videoEl.webkitEnterFullscreen(); // iOS
    } catch {}
  }

  // ===== QR split protocol =====
  // 1æšã«åã¾ã‚‰ãªã„å ´åˆã€BM1|<id>|<i>/<n>|<chunk> ã§åˆ†å‰²
  function randId(len = 6) {
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let s = "";
    for (let i = 0; i < len; i++) s += chars[Math.floor(Math.random() * chars.length)];
    return s;
  }

  function makeQrSegments(text) {
    const CHUNK = 850; // å®‰å…¨å´
    if ((text || "").length <= CHUNK) {
      return { raw: text, parts: [text] };
    }
    const id = randId();
    const n = Math.ceil(text.length / CHUNK);
    const parts = [];
    for (let i = 0; i < n; i++) {
      const chunk = text.slice(i * CHUNK, (i + 1) * CHUNK);
      parts.push(`BM1|${id}|${i + 1}/${n}|${chunk}`);
    }
    return { raw: text, parts };
  }

  function parseBm1(text) {
    // BM1|id|i/n|chunk
    if (!text.startsWith("BM1|")) return null;
    const a = text.split("|");
    if (a.length < 4) return null;
    const id = a[1];
    const frac = a[2];
    const chunk = a.slice(3).join("|");
    const m = frac.match(/^(\d+)\/(\d+)$/);
    if (!m) return null;
    return { id, i: Number(m[1]), n: Number(m[2]), chunk };
  }

  // ===== QR modal: â€œå³è¡¨ç¤ºâ†’å¾Œã‹ã‚‰QRæç”»â€ ã«ã™ã‚‹ =====
  let qrParts = [];
  let qrIdx = 0;
  let qrTimer = null;

  function showQrModal(title, meta="") {
    qrTitle.textContent = title;
    qrMeta.textContent = meta;
    qrBox.innerHTML = `
      <div class="w-[280px] h-[280px] grid place-items-center">
        <div class="text-sm font-black text-slate-600">ç”Ÿæˆä¸­â€¦</div>
      </div>
    `;
    qrModal.classList.remove("hidden");
  }

  function setQrContent(text) {
    const pack = makeQrSegments(text || "");
    qrParts = pack.parts;
    qrIdx = 0;

    const render = (idx) => {
      qrBox.innerHTML = "";
      try {
        new QRCode(qrBox, {
          text: qrParts[idx],
          width: 280,
          height: 280,
          correctLevel: QRCode.CorrectLevel.L
        });
      } catch {
        qrBox.innerHTML = `<div class="text-sm font-bold text-rose-600">
          QRç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç«¯æœ«è² è·ãŒé«˜ã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆå†èª­ã¿è¾¼ã¿â†’å†è©¦è¡Œï¼‰ã€‚
        </div>`;
      }
      qrMeta.textContent = (qrParts.length <= 1) ? "" : `åˆ†å‰²QRï¼š${idx + 1} / ${qrParts.length}ï¼ˆè‡ªå‹•åˆ‡æ›¿ï¼‰`;
    };

    render(0);

    if (qrTimer) clearInterval(qrTimer);
    if (qrParts.length > 1) {
      qrTimer = setInterval(() => {
        qrIdx = (qrIdx + 1) % qrParts.length;
        render(qrIdx);
      }, 800);
    }
  }

  function closeQR() {
    qrModal.classList.add("hidden");
    qrBox.innerHTML = "";
    qrMeta.textContent = "";
    if (qrTimer) clearInterval(qrTimer);
    qrTimer = null;
    qrParts = [];
    qrIdx = 0;
  }

  btnCloseQR.addEventListener("click", closeQR);
  qrModal.addEventListener("click", (e) => { if (e.target === qrModal) closeQR(); });

  // ===== QR scan modal (collect split parts) =====
  let html5Qr = null;
  let scanFacing = "environment";
  let scanCollect = null; // { id, total, map }
  let scanDone = false;
  let scanAfter = null;

  function resetScanCollect() {
    scanCollect = null;
    scanProgress.textContent = "";
    scanDone = false;
  }

  async function stopScanner() {
    try {
      if (html5Qr) {
        await html5Qr.stop();
        await html5Qr.clear();
      }
    } catch {} finally {
      html5Qr = null;
      qrReader.innerHTML = "";
    }
  }

  async function finishScan(val) {
    if (scanDone) return;
    scanDone = true;

    const cb = scanAfter;
    scanAfter = null;

    await stopScanner();
    scanModal.classList.add("hidden");
    resetScanCollect();

    if (cb) setTimeout(() => cb(val), 0);
  }

  async function handleScanDecoded(decodedText) {
    const bm = parseBm1(decodedText);

    // 1æšQR
    if (!bm) {
      await finishScan(decodedText);
      return;
    }

    // åˆ†å‰²QR
    if (!scanCollect || scanCollect.id !== bm.id) {
      scanCollect = { id: bm.id, total: bm.n, map: new Map() };
    }
    scanCollect.map.set(bm.i, bm.chunk);

    const got = scanCollect.map.size;
    scanProgress.textContent = `å—ä¿¡ä¸­ï¼š${got} / ${scanCollect.total}`;

    if (got >= scanCollect.total) {
      let full = "";
      for (let i = 1; i <= scanCollect.total; i++) full += (scanCollect.map.get(i) || "");
      await finishScan(full);
    }
  }

  async function startScanner() {
    qrReader.innerHTML = "";
    html5Qr = new Html5Qrcode("qrReader");
    scanHint.textContent = "ã‚«ãƒ¡ãƒ©ã‚’å‘ã‘ã¦ãã ã•ã„ï¼ˆèª­ã¿å–ã‚Šå¾Œã€è‡ªå‹•ã§é€²ã¿ã¾ã™ï¼‰";
    const config = { fps: 10, qrbox: { width: 240, height: 240 } };
    await html5Qr.start(
      { facingMode: scanFacing },
      config,
      async (decodedText) => { await handleScanDecoded(decodedText); },
      () => {}
    );
  }

  async function openScan(title, afterCb) {
    scanTitle.textContent = title;
    scanAfter = afterCb || null;
    resetScanCollect();
    scanModal.classList.remove("hidden");
    try {
      await startScanner();
    } catch {
      scanHint.textContent = "ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ï¼ˆè¨±å¯/HTTPS/ä»–ã‚¢ãƒ—ãƒªä½¿ç”¨ä¸­ã‚’ç¢ºèªï¼‰";
    }
  }

  async function closeScan() {
    scanAfter = null;
    await stopScanner();
    scanModal.classList.add("hidden");
    resetScanCollect();
  }

  btnCloseScan.addEventListener("click", closeScan);
  btnCloseScan2.addEventListener("click", closeScan);
  scanModal.addEventListener("click", (e) => { if (e.target === scanModal) closeScan(); });

  btnSwitchCam.addEventListener("click", async () => {
    scanFacing = (scanFacing === "environment") ? "user" : "environment";
    scanHint.textContent = "ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ä¸­â€¦";
    await stopScanner();
    resetScanCollect();
    try { await startScanner(); }
    catch { scanHint.textContent = "åˆ‡æ›¿ã«å¤±æ•—ï¼ˆé–‰ã˜ã‚‹â†’å†è©¦è¡Œï¼‰"; }
  });

  // ===== Mode =====
  function setMode(mode) {
    if (mode === "send") {
      sendView.classList.remove("hidden");
      recvView.classList.add("hidden");
      btnModeSend.className = "px-3 py-3 rounded-2xl font-black border border-slate-200 bg-sky-50 text-sky-700";
      btnModeRecv.className = "px-3 py-3 rounded-2xl font-black border border-slate-200 bg-white hover:bg-slate-100 active:scale-[0.99]";
      globalState.textContent = "é€ä¿¡ãƒ¢ãƒ¼ãƒ‰";
    } else {
      recvView.classList.remove("hidden");
      sendView.classList.add("hidden");
      btnModeRecv.className = "px-3 py-3 rounded-2xl font-black border border-slate-200 bg-emerald-50 text-emerald-700";
      btnModeSend.className = "px-3 py-3 rounded-2xl font-black border border-slate-200 bg-white hover:bg-slate-100 active:scale-[0.99]";
      globalState.textContent = "å—ä¿¡ãƒ¢ãƒ¼ãƒ‰";
    }
  }
  btnModeSend.addEventListener("click", () => setMode("send"));
  btnModeRecv.addEventListener("click", () => setMode("recv"));
  setMode("send");

  // ====== ICE gather (çŸ­æ™‚é–“ã ã‘å¾…ã¤ï¼šå›ºã¾ã‚‰ãªã„) ======
  async function gatherIceQuick(pc, maxMs=2200) {
    const t0 = performance.now();
    let lastCand = performance.now();
    let hasAny = false;

    const onCand = () => {
      hasAny = true;
      lastCand = performance.now();
    };

    pc.addEventListener("icecandidate", onCand);

    return new Promise((resolve) => {
      const tick = () => {
        const now = performance.now();
        const doneByState = (pc.iceGatheringState === "complete");
        const doneByIdle = hasAny && (now - lastCand > 220);
        const doneByMax = (now - t0 > maxMs);
        if (doneByState || doneByIdle || doneByMax) {
          pc.removeEventListener("icecandidate", onCand);
          resolve();
          return;
        }
        setTimeout(tick, 120);
      };
      tick();
    });
  }

  // ====== Signal formatï¼ˆæœ€å°ï¼‰ ======
  // Offer: "O1\n<SDP>"
  // Answer:"A1\n<SDP>"
  function makeOfferSignal(sdp) { return "O1\n" + (sdp || ""); }
  function makeAnswerSignal(sdp){ return "A1\n" + (sdp || ""); }

  function parseSignal(text) {
    const t = (text || "").replace(/\r\n/g, "\n");
    if (t.startsWith("O1\n")) return { kind: "offer", sdp: t.slice(3) };
    if (t.startsWith("A1\n")) return { kind: "answer", sdp: t.slice(3) };
    // æ—§/æ··åœ¨ã«å‚™ãˆï¼šoffer/answerã‚’æ¨æ¸¬ã§ããªã„å ´åˆã¯null
    return null;
  }

  // ====== Sender logic ======
  let sendPc = null;
  let sendStream = null;
  let currentFacing = "environment";
  let micOn = true;
  let nightLocalOn = false;
  let torchOn = false;

  async function startCameraHighest() {
    const constraints = {
      audio: true,
      video: {
        facingMode: { ideal: currentFacing },
        width: { ideal: 3840 },
        height: { ideal: 2160 },
        frameRate: { ideal: 30, max: 60 }
      }
    };

    sendStream = await navigator.mediaDevices.getUserMedia(constraints);
    localVideo.srcObject = sendStream;

    btnStopAllSend.disabled = false;
    btnFlipCam.disabled = false;
    btnMicMute.disabled = false;
    btnNightLocal.disabled = false;
    btnTorch.disabled = false;
    btnShowOfferQRNow.disabled = false;
    btnFullLocal.disabled = false;

    const vtrack = sendStream.getVideoTracks()[0];
    const atrack = sendStream.getAudioTracks()[0];
    const s = vtrack.getSettings ? vtrack.getSettings() : {};
    camInfo.textContent = [
      `è§£åƒåº¦ï¼š${s.width || "?"} x ${s.height || "?"}`,
      `FPSï¼š${s.frameRate || "?"}`,
      `ã‚«ãƒ¡ãƒ©ï¼š${(s.facingMode || currentFacing)}`,
      `éŸ³å£°ï¼š${atrack ? "æœ‰åŠ¹" : "ãªã—"}`
    ].join(" / ");

    sendConn.textContent = "é…ä¿¡ä¸­ï¼ˆOffer QRã¸ï¼‰";
  }

  function stopSenderAll() {
    try { if (sendPc) sendPc.close(); } catch {}
    sendPc = null;

    if (sendStream) sendStream.getTracks().forEach(t => t.stop());
    sendStream = null;

    btnStopAllSend.disabled = true;
    btnFlipCam.disabled = true;
    btnMicMute.disabled = true;
    btnNightLocal.disabled = true;
    btnTorch.disabled = true;
    btnShowOfferQRNow.disabled = true;
    btnScanAnswerQR.disabled = true;
    btnFullLocal.disabled = true;

    micOn = true;
    btnMicMute.textContent = "ğŸ¤ ãƒã‚¤ã‚¯ï¼šON";
    nightLocalOn = false;
    localVideo.classList.remove("night");
    btnNightLocal.textContent = "ğŸŒ™ æš—è¦–ï¼šOFF";
    torchOn = false;
    btnTorch.textContent = "ğŸ”¦ ãƒ©ã‚¤ãƒˆï¼šOFF";
    btnTorch.disabled = true;

    camInfo.textContent = "æœªé–‹å§‹";
    sendConn.textContent = "åœæ­¢";
  }

  async function flipCamera() {
    currentFacing = (currentFacing === "environment") ? "user" : "environment";
    if (sendStream) sendStream.getTracks().forEach(t => t.stop());
    sendStream = null;
    await startCameraHighest();
  }

  function toggleMic() {
    if (!sendStream) return;
    const atrack = sendStream.getAudioTracks()[0];
    if (!atrack) return;
    micOn = !micOn;
    atrack.enabled = micOn;
    btnMicMute.textContent = micOn ? "ğŸ¤ ãƒã‚¤ã‚¯ï¼šON" : "ğŸ¤ ãƒã‚¤ã‚¯ï¼šMUTE";
  }

  function toggleNightLocal() {
    nightLocalOn = !nightLocalOn;
    localVideo.classList.toggle("night", nightLocalOn);
    btnNightLocal.textContent = nightLocalOn ? "ğŸŒ™ æš—è¦–ï¼šON" : "ğŸŒ™ æš—è¦–ï¼šOFF";
  }

  async function toggleTorch() {
    if (!sendStream) return;
    const vtrack = sendStream.getVideoTracks()[0];
    if (!vtrack) return;
    try {
      torchOn = !torchOn;
      await vtrack.applyConstraints({ advanced: [{ torch: torchOn }] });
      btnTorch.textContent = torchOn ? "ğŸ”¦ ãƒ©ã‚¤ãƒˆï¼šON" : "ğŸ”¦ ãƒ©ã‚¤ãƒˆï¼šOFF";
      btnTorch.disabled = false;
    } catch {
      torchOn = false;
      btnTorch.textContent = "ğŸ”¦ ãƒ©ã‚¤ãƒˆï¼šéå¯¾å¿œ";
      btnTorch.disabled = true;
    }
  }

  async function makeOfferSignalString() {
    if (!sendStream) throw new Error("å…ˆã«ã€Œã‚«ãƒ¡ãƒ©é–‹å§‹ã€ã‚’ã—ã¦ãã ã•ã„ã€‚");

    // æ—¢å­˜PCãŒã‚ã‚Œã°é–‰ã˜ã‚‹
    try { if (sendPc) sendPc.close(); } catch {}
    sendPc = null;

    sendPc = new RTCPeerConnection(pcConfig);
    sendPc.onconnectionstatechange = () => { sendConn.textContent = sendPc.connectionState; };

    // trackè¿½åŠ 
    sendStream.getTracks().forEach(tr => sendPc.addTrack(tr, sendStream));

    // Offerä½œæˆ
    const offer = await sendPc.createOffer();
    await sendPc.setLocalDescription(offer);

    // â€œçŸ­æ™‚é–“ã ã‘â€ICEã‚’é›†ã‚ã¦SDPã«candidateã‚’è¼‰ã›ã‚‹
    await gatherIceQuick(sendPc, 2200);

    const sdp = filterHostCandidatesInSdp(sendPc.localDescription?.sdp || "");
    return makeOfferSignal(sdp);
  }

  async function applyAnswerFromSignalString(signalText) {
    if (!sendPc) throw new Error("å…ˆã«Offerã®QRã‚’è¡¨ç¤ºã—ã¦ãã ã•ã„ã€‚");

    const parsed = parseSignal(signalText);
    if (!parsed || parsed.kind !== "answer") throw new Error("Answerã®QRã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");

    const sdp = filterHostCandidatesInSdp(parsed.sdp || "");
    await sendPc.setRemoteDescription({ type: "answer", sdp });
    sendConn.textContent = "æ¥ç¶šä¸­â€¦";
  }

  btnStartCam.addEventListener("click", async () => {
    try {
      globalState.textContent = "é€ä¿¡ï¼šã‚«ãƒ¡ãƒ©é–‹å§‹ä¸­â€¦";
      btnTorch.disabled = false;
      await startCameraHighest();
      globalState.textContent = "é€ä¿¡ï¼šæº–å‚™OK";
    } catch {
      globalState.textContent = "ã‚¨ãƒ©ãƒ¼";
      alert("ã‚«ãƒ¡ãƒ©/ãƒã‚¤ã‚¯ã®è¨±å¯ãŒå¿…è¦ã§ã™ï¼ˆHTTPSã§é–‹ã„ã¦ãã ã•ã„ï¼‰ã€‚");
    }
  });

  btnStopAllSend.addEventListener("click", stopSenderAll);
  btnFlipCam.addEventListener("click", async () => { try { await flipCamera(); } catch { alert("ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ã«å¤±æ•—ã—ã¾ã—ãŸ"); } });
  btnMicMute.addEventListener("click", toggleMic);
  btnNightLocal.addEventListener("click", toggleNightLocal);
  btnTorch.addEventListener("click", toggleTorch);
  btnFullLocal.addEventListener("click", () => requestVideoFullscreen(localVideo));
  localVideo.addEventListener("dblclick", () => requestVideoFullscreen(localVideo));

  // â˜…æŠ¼ã—ãŸã‚‰å³QRç”»é¢ â†’ è£ã§Offerä½œã£ã¦QRã‚’å·®ã—æ›¿ãˆ
  btnShowOfferQRNow.addEventListener("click", async () => {
    try {
      btnShowOfferQRNow.disabled = true;
      globalState.textContent = "é€ä¿¡ï¼šOfferä½œæˆä¸­â€¦";

      // å…ˆã«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‡ºã™ï¼ˆä½“æ„Ÿâ€œå³â€ï¼‰
      showQrModal("Offerï¼ˆå—ä¿¡å´ã§QRèª­å–ï¼‰", "æº–å‚™ä¸­â€¦");

      const offerSignal = await makeOfferSignalString();
      setQrContent(offerSignal);

      globalState.textContent = "é€ä¿¡ï¼šOffer QRè¡¨ç¤ºä¸­";
      btnScanAnswerQR.disabled = false;
      sendConn.textContent = "Offerä½œæˆæ¸ˆï¼ˆAnswerå¾…ã¡ï¼‰";
    } catch (e) {
      closeQR();
      globalState.textContent = "ã‚¨ãƒ©ãƒ¼";
      alert(e.message || "Offerä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
    } finally {
      btnShowOfferQRNow.disabled = false;
    }
  });

  // Answer QRã‚’èª­å– â†’ è‡ªå‹•æ¥ç¶š
  btnScanAnswerQR.addEventListener("click", async () => {
    try {
      await openScan("Answer QRèª­å–ï¼ˆé€ä¿¡å´ï¼‰", async (val) => {
        try {
          globalState.textContent = "é€ä¿¡ï¼šæ¥ç¶šä¸­â€¦";
          await applyAnswerFromSignalString(val);
          globalState.textContent = "é€ä¿¡ï¼šæ¥ç¶šå‡¦ç†OKï¼ˆçŠ¶æ…‹ã‚’ç¢ºèªï¼‰";
        } catch (e) {
          globalState.textContent = "ã‚¨ãƒ©ãƒ¼";
          alert(e.message || "æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
      });
    } catch {
      alert("QRèª­å–ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
    }
  });

  // ====== Receiver logic ======
  let recvPc = null;
  let recvStream = null;
  let spkOn = true;
  let nightRemoteOn = false;

  function resetReceiverAll() {
    try { if (recvPc) recvPc.close(); } catch {}
    recvPc = null;
    recvStream = null;
    remoteVideo.srcObject = null;

    btnPlayRemote.disabled = true;
    btnSpkMute.disabled = true;
    btnNightRemote.disabled = true;
    btnFullAlt.disabled = true;
    btnFullRemote.disabled = true;
    btnResetRecv.disabled = true;

    spkOn = true;
    remoteVideo.muted = false;
    btnSpkMute.textContent = "ğŸ”ˆ éŸ³ï¼šON";
    nightRemoteOn = false;
    remoteVideo.classList.remove("night");
    btnNightRemote.textContent = "ğŸŒ™ æš—è¦–ï¼šOFF";

    recvConn.textContent = "æœªæ¥ç¶š";
    globalState.textContent = "å—ä¿¡ï¼šå¾…æ©Ÿä¸­";
  }

  async function makeAnswerFromOfferSignalString(signalText) {
    const parsed = parseSignal(signalText);
    if (!parsed || parsed.kind !== "offer") throw new Error("Offerã®QRã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚");

    // æ—¢å­˜PCãŒã‚ã‚Œã°é–‰ã˜ã‚‹
    try { if (recvPc) recvPc.close(); } catch {}
    recvPc = null;

    recvPc = new RTCPeerConnection(pcConfig);
    recvPc.onconnectionstatechange = () => { recvConn.textContent = recvPc.connectionState; };

    recvPc.ontrack = (e) => {
      if (!recvStream) recvStream = new MediaStream();
      recvStream.addTrack(e.track);
      remoteVideo.srcObject = recvStream;

      btnPlayRemote.disabled = false;
      btnSpkMute.disabled = false;
      btnNightRemote.disabled = false;
      btnFullAlt.disabled = false;
      btnFullRemote.disabled = false;
      btnResetRecv.disabled = false;

      // iOSã¯å¤±æ•—ã—ã¦ã‚‚OKï¼ˆå†ç”Ÿãƒœã‚¿ãƒ³ã§ï¼‰
      remoteVideo.play().catch(() => {});
    };

    const offerSdp = filterHostCandidatesInSdp(parsed.sdp || "");
    await recvPc.setRemoteDescription({ type: "offer", sdp: offerSdp });

    const answer = await recvPc.createAnswer();
    await recvPc.setLocalDescription(answer);

    await gatherIceQuick(recvPc, 2200);

    const sdp = filterHostCandidatesInSdp(recvPc.localDescription?.sdp || "");
    return makeAnswerSignal(sdp);
  }

  // Offer QRèª­å– â†’ èª­ã¿å–ã‚Šå®Œäº†å¾Œã« â€œè‡ªå‹•ã§Answerä½œæˆã—ã¦QRè¡¨ç¤ºâ€
  btnScanOfferQR.addEventListener("click", async () => {
    try {
      await openScan("Offer QRèª­å–ï¼ˆå—ä¿¡å´ï¼‰", async (val) => {
        try {
          globalState.textContent = "å—ä¿¡ï¼šAnswerä½œæˆä¸­â€¦";

          // å…ˆã«Answerãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‡ºã™ï¼ˆä½“æ„Ÿâ€œå³â€ï¼‰
          showQrModal("Answerï¼ˆé€ä¿¡å´ã§QRèª­å–ï¼‰", "æº–å‚™ä¸­â€¦");

          const answerSignal = await makeAnswerFromOfferSignalString(val);
          setQrContent(answerSignal);

          globalState.textContent = "å—ä¿¡ï¼šAnswer QRè¡¨ç¤ºä¸­";
          recvConn.textContent = "Answerä½œæˆæ¸ˆ";
        } catch (e) {
          closeQR();
          globalState.textContent = "ã‚¨ãƒ©ãƒ¼";
          alert(e.message || "Answerä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
      });
    } catch {
      alert("QRèª­å–ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
    }
  });

  btnPlayRemote.addEventListener("click", async () => { try { await remoteVideo.play(); } catch {} });

  btnSpkMute.addEventListener("click", () => {
    spkOn = !spkOn;
    remoteVideo.muted = !spkOn;
    btnSpkMute.textContent = spkOn ? "ğŸ”ˆ éŸ³ï¼šON" : "ğŸ”‡ éŸ³ï¼šMUTE";
  });

  btnNightRemote.addEventListener("click", () => {
    nightRemoteOn = !nightRemoteOn;
    remoteVideo.classList.toggle("night", nightRemoteOn);
    btnNightRemote.textContent = nightRemoteOn ? "ğŸŒ™ æš—è¦–ï¼šON" : "ğŸŒ™ æš—è¦–ï¼šOFF";
  });

  btnFullAlt.addEventListener("click", () => requestVideoFullscreen(remoteVideo));
  btnFullRemote.addEventListener("click", () => requestVideoFullscreen(remoteVideo));
  remoteVideo.addEventListener("dblclick", () => requestVideoFullscreen(remoteVideo));

  btnResetRecv.addEventListener("click", resetReceiverAll);

  // Cleanup
  window.addEventListener("beforeunload", async () => {
    stopSenderAll();
    resetReceiverAll();
    await closeScan();
    closeQR();
  });

  // Init
  resetReceiverAll();
  btnTorch.disabled = true;
})();
</script>
</body>
</html>
