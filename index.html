<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ベビーモニター（家LAN限定 / 1ファイル / AirDrop即接続）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { -webkit-tap-highlight-color: transparent; }
    video { background:#000; }
    .night { filter: brightness(1.9) contrast(1.45) saturate(0.85); }

    /* 押下エフェクト */
    .pressy { transition: transform .08s ease, filter .15s ease; }
    .pressy:active { transform: scale(.98); filter: brightness(.96); }
    .ripple {
      position: relative; overflow: hidden;
    }
    .ripple::after{
      content:""; position:absolute; inset:auto; width:12px; height:12px; border-radius:999px;
      background: rgba(255,255,255,.55);
      transform: translate(-50%,-50%) scale(0);
      opacity: 0;
      pointer-events:none;
    }
    .ripple.rippling::after{
      animation: rip .55s ease-out;
    }
    @keyframes rip{
      0%{ opacity:.55; transform: translate(var(--x),var(--y)) scale(0); }
      100%{ opacity:0; transform: translate(var(--x),var(--y)) scale(24); }
    }

    /* 疑似全画面 */
    .pseudoFS {
      position: fixed !important;
      inset: 0 !important;
      z-index: 9999 !important;
      background: #000 !important;
      padding: 10px !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
    }
    .pseudoFS video{
      width: 100% !important;
      height: 100% !important;
      object-fit: contain !important;
      border-radius: 16px !important;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-800">
  <div class="max-w-4xl mx-auto p-4 space-y-4">

    <!-- Error banner -->
    <div id="errBar" class="hidden rounded-2xl border border-rose-200 bg-rose-50 p-3">
      <div class="font-black text-rose-800">⚠️ 初期化エラー</div>
      <div id="errText" class="text-xs text-rose-700 mt-1 whitespace-pre-wrap"></div>
      <div class="text-[11px] text-rose-700 mt-2">
        ヒント：GitHub Pages反映直後はキャッシュが残ります。URL末尾に <b>?v=2</b> を付けて開き直してください。
      </div>
    </div>

    <!-- Header -->
    <header class="space-y-2">
      <div class="flex items-center justify-between gap-2 flex-wrap">
        <div class="text-xl sm:text-2xl font-black">ベビーモニター（家LAN限定 / AirDrop即接続）</div>
        <div class="text-xs font-bold px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">
          GitHub Pages / 1ファイル
        </div>
      </div>
      <div class="text-xs text-slate-500 leading-relaxed">
        ※医療機器ではありません。<br/>
        ※HTTPS必須（GitHub Pages等）。<b>同じWi-Fi内</b>で使ってください（ゲストWi-Fiの「端末隔離(AP isolation)」があると接続不可）。<br/>
        ※「LAN限定」意図：STUN/TURNなし＋host候補のみ採用（外部回線からの接続は基本できません）。
      </div>
    </header>

    <!-- Quick Start -->
    <section class="bg-white rounded-3xl border border-slate-200 p-4 shadow-sm">
      <div class="flex items-center justify-between flex-wrap gap-2">
        <div class="font-black text-slate-700">⚡ 究極の即使い（30秒）</div>
        <div class="text-xs text-slate-500">iPhone / iPad対応</div>
      </div>
      <ol class="mt-3 text-sm text-slate-700 space-y-1 list-decimal pl-5">
        <li>2台ともこのページを開く（同じWi-Fi）</li>
        <li>片方を <b>送信</b> → 「カメラ開始」→「Offer作成」→「共有(AirDrop)」</li>
        <li>もう片方を <b>受信</b> → 受け取ったテキストを<b>コピー</b> → 「📋貼り付け」→「Answer作成」→「共有(AirDrop)」</li>
        <li>送信側で Answer を受け取って<b>コピー</b> → 「📋貼り付け」→「接続」</li>
      </ol>
      <div class="mt-3 text-[11px] text-slate-500">
        ※受信側はiOSの自動再生制限があるため、映像が来たら <b>「▶ 再生」</b> を押すのが確実です。
      </div>
    </section>

    <!-- Mode -->
    <section class="bg-white rounded-3xl border border-slate-200 p-4 space-y-3 shadow-sm">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="font-black text-slate-700">0）モード</div>
        <div class="text-xs text-slate-500">状態：<span id="globalState" class="font-black text-slate-700">待機中</span> / ブラウザ：<span id="uaHint"></span></div>
      </div>
      <div class="grid grid-cols-2 gap-2">
        <button id="btnModeSend" class="pressy ripple px-3 py-3 rounded-2xl font-black border border-slate-200 bg-sky-50 text-sky-700">
          👶 送信（ベビー側）
        </button>
        <button id="btnModeRecv" class="pressy ripple px-3 py-3 rounded-2xl font-black border border-slate-200 bg-white hover:bg-slate-100">
          👀 受信（見守り側）
        </button>
      </div>
      <div class="text-xs text-slate-500">
        ※パスワードなし（家庭内用途の即起動を優先）。家族以外が同じWi-Fiに入れる状況は避けてください。
      </div>
    </section>

    <!-- SEND VIEW -->
    <section id="sendView" class="space-y-4">
      <section class="bg-white rounded-3xl border border-slate-200 p-4 space-y-4 shadow-sm">
        <div class="flex items-center justify-between gap-2 flex-wrap">
          <div class="font-black text-slate-700">送信（ベビー側）</div>
          <div class="flex items-center gap-2">
            <button id="btnStartCam" class="pressy ripple px-4 py-2 rounded-2xl bg-sky-600 text-white font-black">カメラ開始</button>
            <button id="btnStopAllSend" class="pressy ripple px-4 py-2 rounded-2xl bg-slate-200 font-black" disabled>停止</button>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <!-- Preview -->
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <div class="text-sm font-bold text-slate-600">プレビュー</div>
              <button id="btnFullLocal" class="pressy ripple px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>⛶ 画面いっぱい</button>
            </div>
            <div id="localWrap" class="rounded-3xl overflow-hidden border border-slate-200">
              <video id="localVideo" class="w-full aspect-video" playsinline muted autoplay></video>
            </div>

            <div class="grid grid-cols-2 gap-2">
              <button id="btnFlipCam" class="pressy ripple px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>📷 前/後切替</button>
              <button id="btnMicMute" class="pressy ripple px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>🎤 マイク：ON</button>
              <button id="btnNightLocal" class="pressy ripple px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>🌙 暗視：OFF</button>
              <button id="btnTorch" class="pressy ripple px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>🔦 ライト：OFF</button>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3 text-xs text-slate-600">
              <div class="font-bold text-slate-700 mb-1">実際の撮影設定</div>
              <div id="camInfo">未開始</div>
              <div class="mt-1 text-slate-500">※理想値：4K/30fps を要求し、端末が出せる最大へ寄せます。</div>
            </div>

            <div class="text-[11px] text-slate-500">
              ※暗視は疑似（明るさ/コントラスト補正）。赤外線暗視は端末ハード依存でWebアプリから追加できません。
            </div>
          </div>

          <!-- Flow -->
          <div class="space-y-3">
            <div class="bg-indigo-50 border border-indigo-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-indigo-900">1）Offer作成 → 共有(AirDrop)</div>
              <div class="text-indigo-700 text-xs mt-1">受信側へ送る（共有できない時はコピー）</div>
              <div class="mt-2 flex gap-2 flex-wrap">
                <button id="btnMakeOffer" class="pressy ripple px-4 py-2 rounded-2xl bg-indigo-600 text-white font-black" disabled>Offer作成</button>
                <button id="btnShareOffer" class="pressy ripple px-4 py-2 rounded-2xl border border-indigo-200 bg-white font-black" disabled>共有(AirDrop)</button>
                <button id="btnCopyOffer" class="pressy ripple px-4 py-2 rounded-2xl bg-slate-200 font-black" disabled>コピー</button>
              </div>
              <textarea id="offerOut" class="mt-2 w-full h-28 rounded-2xl border border-indigo-200 p-3 text-xs font-mono"
                        placeholder="Offerがここに出ます" readonly></textarea>
            </div>

            <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-emerald-900">2）Answer受け取り → 接続</div>
              <div class="text-emerald-700 text-xs mt-1">受信側から返ってきたAnswerを貼り付け</div>
              <div class="mt-2 flex gap-2 flex-wrap">
                <button id="btnPasteAnswer" class="pressy ripple px-4 py-2 rounded-2xl border border-emerald-200 bg-white font-black" disabled>📋貼り付け</button>
                <button id="btnConnectSend" class="pressy ripple px-4 py-2 rounded-2xl bg-emerald-600 text-white font-black" disabled>接続</button>
              </div>
              <textarea id="answerIn" class="mt-2 w-full h-28 rounded-2xl border border-emerald-200 p-3 text-xs font-mono"
                        placeholder="Answerを貼り付け（または📋貼り付け）"></textarea>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-slate-700">接続状態</div>
              <div class="mt-1 text-sm">Peer：<span id="sendConn" class="font-black">未接続</span></div>
              <div class="text-xs text-slate-500 mt-1">※LAN限定（host候補のみ）。</div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <!-- RECV VIEW -->
    <section id="recvView" class="space-y-4 hidden">
      <section class="bg-white rounded-3xl border border-slate-200 p-4 space-y-4 shadow-sm">
        <div class="flex items-center justify-between gap-2 flex-wrap">
          <div class="font-black text-slate-700">受信（見守り側）</div>
          <div class="flex items-center gap-2">
            <button id="btnResetRecv" class="pressy ripple px-4 py-2 rounded-2xl bg-slate-200 font-black" disabled>切断/リセット</button>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <!-- Offer/Answer -->
          <div class="space-y-2">
            <div class="bg-indigo-50 border border-indigo-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-indigo-900">1）Offer受け取り（AirDrop → コピー → 貼り付け）</div>
              <div class="mt-2 flex gap-2 flex-wrap">
                <button id="btnPasteOffer" class="pressy ripple px-4 py-2 rounded-2xl border border-indigo-200 bg-white font-black">📋貼り付け</button>
                <button id="btnMakeAnswer" class="pressy ripple px-4 py-2 rounded-2xl bg-indigo-600 text-white font-black">Answer作成</button>
              </div>
              <textarea id="offerIn" class="mt-2 w-full h-28 rounded-2xl border border-indigo-200 p-3 text-xs font-mono"
                        placeholder="Offerを貼り付け（または📋貼り付け）"></textarea>
              <div class="text-[11px] text-indigo-700 mt-2">
                ※「貼り付け」が無理な時：Offer欄を長押し→ペースト
              </div>
            </div>

            <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-emerald-900">2）Answerを返す（共有/AirDrop）</div>
              <div class="text-emerald-700 text-xs mt-1">作成後に送信側へ返す</div>
              <div class="mt-2 flex gap-2 flex-wrap">
                <button id="btnShareAnswer" class="pressy ripple px-4 py-2 rounded-2xl border border-emerald-200 bg-white font-black" disabled>共有(AirDrop)</button>
                <button id="btnCopyAnswer" class="pressy ripple px-4 py-2 rounded-2xl bg-slate-200 font-black" disabled>コピー</button>
              </div>
              <textarea id="answerOut" class="mt-2 w-full h-28 rounded-2xl border border-emerald-200 p-3 text-xs font-mono"
                        placeholder="Answerがここに出ます" readonly></textarea>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-slate-700">接続状態</div>
              <div class="mt-1 text-sm">Peer：<span id="recvConn" class="font-black">未接続</span></div>
              <div class="text-xs text-slate-500 mt-1">iOSは自動再生制限があるため、映像が来たら「▶ 再生」を押すと安定します。</div>
            </div>
          </div>

          <!-- Video -->
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <div class="text-sm font-bold text-slate-600">受信映像</div>
              <button id="btnFullRemote" class="pressy ripple px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>⛶ 画面いっぱい</button>
            </div>

            <div id="remoteWrap" class="rounded-3xl overflow-hidden border border-slate-200">
              <video id="remoteVideo" class="w-full aspect-video" playsinline autoplay></video>
            </div>

            <div class="grid grid-cols-2 gap-2">
              <button id="btnPlayRemote" class="pressy ripple px-3 py-2 rounded-2xl bg-emerald-600 text-white font-black" disabled>▶ 再生</button>
              <button id="btnSpkMute" class="pressy ripple px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>🔈 音：ON</button>
              <button id="btnNightRemote" class="pressy ripple px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>🌙 暗視：OFF</button>
              <button id="btnForceIOSFS" class="pressy ripple px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>⛶ iOS全画面</button>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3 text-xs text-slate-600">
              <div class="font-bold text-slate-700 mb-1">メモ</div>
              <ul class="list-disc pl-5 space-y-1">
                <li>同じWi-Fiでも「端末隔離(AP isolation)」があると接続できません。</li>
                <li>外部からの接続は想定しません（STUN/TURNなし）。</li>
              </ul>
            </div>
          </div>
        </div>
      </section>
    </section>

    <div class="text-[11px] text-slate-500 px-1">
      ✅ 共有(AirDrop)は「iOSの共有シート」を使います。出ない場合は「コピー→貼り付け」でOKです。
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // ===== Error visible =====
  const errBar = $("errBar");
  const errText = $("errText");
  function showErr(e){
    errText.textContent = (e && (e.stack || e.message)) ? (e.stack || e.message) : String(e || "unknown");
    errBar.classList.remove("hidden");
  }
  window.addEventListener("error", (ev) => showErr(ev.error || ev.message));
  window.addEventListener("unhandledrejection", (ev) => showErr(ev.reason));

  // ===== Ripple effect for buttons =====
  function bindRipple(el){
    if(!el) return;
    el.addEventListener("click", (e)=>{
      const r = el.getBoundingClientRect();
      const x = (e.clientX - r.left) + "px";
      const y = (e.clientY - r.top) + "px";
      el.style.setProperty("--x", x);
      el.style.setProperty("--y", y);
      el.classList.remove("rippling");
      void el.offsetWidth;
      el.classList.add("rippling");
      setTimeout(()=>el.classList.remove("rippling"), 600);
    }, {passive:true});
  }
  document.querySelectorAll("button.ripple").forEach(bindRipple);

  // UI
  const uaHint = $("uaHint");
  const globalState = $("globalState");
  const btnModeSend = $("btnModeSend");
  const btnModeRecv = $("btnModeRecv");
  const sendView = $("sendView");
  const recvView = $("recvView");

  // Send UI
  const btnStartCam = $("btnStartCam");
  const btnStopAllSend = $("btnStopAllSend");
  const btnFlipCam = $("btnFlipCam");
  const btnMicMute = $("btnMicMute");
  const btnNightLocal = $("btnNightLocal");
  const btnTorch = $("btnTorch");
  const btnFullLocal = $("btnFullLocal");
  const localWrap = $("localWrap");
  const localVideo = $("localVideo");
  const camInfo = $("camInfo");
  const btnMakeOffer = $("btnMakeOffer");
  const btnShareOffer = $("btnShareOffer");
  const btnCopyOffer = $("btnCopyOffer");
  const offerOut = $("offerOut");
  const answerIn = $("answerIn");
  const btnPasteAnswer = $("btnPasteAnswer");
  const btnConnectSend = $("btnConnectSend");
  const sendConn = $("sendConn");

  // Recv UI
  const btnResetRecv = $("btnResetRecv");
  const offerIn = $("offerIn");
  const btnPasteOffer = $("btnPasteOffer");
  const btnMakeAnswer = $("btnMakeAnswer");
  const answerOut = $("answerOut");
  const btnShareAnswer = $("btnShareAnswer");
  const btnCopyAnswer = $("btnCopyAnswer");
  const recvConn = $("recvConn");
  const remoteWrap = $("remoteWrap");
  const remoteVideo = $("remoteVideo");
  const btnPlayRemote = $("btnPlayRemote");
  const btnSpkMute = $("btnSpkMute");
  const btnNightRemote = $("btnNightRemote");
  const btnFullRemote = $("btnFullRemote");
  const btnForceIOSFS = $("btnForceIOSFS");

  // UA hint
  const isiOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
  uaHint.textContent = isiOS ? "iOS（再生ボタン推奨）" : "OK";

  // ===== WebRTC: LAN-only-ish =====
  const pcConfig = { iceServers: [] };
  function isHostCandidate(candStr){ return / typ host /i.test(candStr || ""); }

  function waitIceComplete(pc, timeoutMs=4000){
    return new Promise(resolve=>{
      if(pc.iceGatheringState === "complete") return resolve();
      const t = setTimeout(()=>{ pc.removeEventListener("icegatheringstatechange", on); resolve(); }, timeoutMs);
      function on(){
        if(pc.iceGatheringState === "complete"){
          clearTimeout(t);
          pc.removeEventListener("icegatheringstatechange", on);
          resolve();
        }
      }
      pc.addEventListener("icegatheringstatechange", on);
    });
  }

  // ===== Clipboard helpers =====
  async function safeCopy(text){
    if(!text) return;
    try{
      await navigator.clipboard.writeText(text);
      toast("コピーしました");
    }catch{
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      toast("コピーしました");
    }
  }

  async function safePaste(){
    try{
      if(navigator.clipboard && navigator.clipboard.readText){
        return await navigator.clipboard.readText();
      }
    }catch{}
    // fallback
    return prompt("貼り付けできない場合は、ここに長押しペーストした内容を貼ってください：") || "";
  }

  // ===== Share (AirDrop) =====
  async function shareText(title, text){
    if(!text) return;
    if(navigator.share){
      try{
        await navigator.share({ title, text });
        return true;
      }catch{
        // user canceled or failed → fallback copy
      }
    }
    await safeCopy(text);
    alert("共有が使えないため、コピーしました。受信側で貼り付けてください。");
    return false;
  }

  // ===== Toast =====
  let toastTimer = null;
  const toastEl = document.createElement("div");
  toastEl.className = "fixed left-1/2 -translate-x-1/2 bottom-5 z-[99999] hidden px-4 py-2 rounded-full bg-black/80 text-white text-sm font-bold";
  document.body.appendChild(toastEl);
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.remove("hidden");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>toastEl.classList.add("hidden"), 1200);
  }

  // ===== Mode =====
  function setMode(mode){
    if(mode === "send"){
      sendView.classList.remove("hidden");
      recvView.classList.add("hidden");
      btnModeSend.className = "pressy ripple px-3 py-3 rounded-2xl font-black border border-slate-200 bg-sky-50 text-sky-700";
      btnModeRecv.className = "pressy ripple px-3 py-3 rounded-2xl font-black border border-slate-200 bg-white hover:bg-slate-100";
      globalState.textContent = "送信モード";
    }else{
      recvView.classList.remove("hidden");
      sendView.classList.add("hidden");
      btnModeRecv.className = "pressy ripple px-3 py-3 rounded-2xl font-black border border-slate-200 bg-emerald-50 text-emerald-700";
      btnModeSend.className = "pressy ripple px-3 py-3 rounded-2xl font-black border border-slate-200 bg-white hover:bg-slate-100";
      globalState.textContent = "受信モード";
    }
    // ripple 再バインド（className差し替えで消えるため）
    bindRipple(btnModeSend);
    bindRipple(btnModeRecv);
  }
  btnModeSend.addEventListener("click", ()=>setMode("send"));
  btnModeRecv.addEventListener("click", ()=>setMode("recv"));
  setMode("send");

  // ===== Pseudo fullscreen =====
  function togglePseudoFS(wrapper, video){
    const on = wrapper.classList.contains("pseudoFS");
    if(on){
      wrapper.classList.remove("pseudoFS");
      toast("戻しました");
    }else{
      wrapper.classList.add("pseudoFS");
      toast("画面いっぱい表示");
    }
    // iOS autoplay制限対策で play 試行
    try{ video.play(); }catch{}
  }

  // ===== Sender =====
  let sendPc = null;
  let sendStream = null;
  let currentFacing = "environment";
  let micOn = true;
  let nightLocalOn = false;
  let torchOn = false;

  async function startCameraHighest(){
    const constraints = {
      audio: true,
      video: {
        facingMode: { ideal: currentFacing },
        width: { ideal: 3840 },
        height: { ideal: 2160 },
        frameRate: { ideal: 30, max: 60 }
      }
    };
    sendStream = await navigator.mediaDevices.getUserMedia(constraints);
    localVideo.srcObject = sendStream;

    btnStopAllSend.disabled = false;
    btnFlipCam.disabled = false;
    btnMicMute.disabled = false;
    btnNightLocal.disabled = false;
    btnTorch.disabled = false;
    btnMakeOffer.disabled = false;
    btnFullLocal.disabled = false;

    const vtrack = sendStream.getVideoTracks()[0];
    const atrack = sendStream.getAudioTracks()[0];
    const s = vtrack.getSettings ? vtrack.getSettings() : {};
    camInfo.textContent = [
      `解像度：${s.width || "?"} x ${s.height || "?"}`,
      `FPS：${s.frameRate || "?"}`,
      `カメラ：${(s.facingMode || currentFacing)}`,
      `音声：${atrack ? "有効" : "なし"}`
    ].join(" / ");

    sendConn.textContent = "配信中（Offer作成へ）";
  }

  function stopSenderAll(){
    try{ if(sendPc) sendPc.close(); }catch{}
    sendPc = null;

    if(sendStream) sendStream.getTracks().forEach(t=>t.stop());
    sendStream = null;

    offerOut.value = "";
    answerIn.value = "";

    btnCopyOffer.disabled = true;
    btnShareOffer.disabled = true;
    btnPasteAnswer.disabled = true;
    btnConnectSend.disabled = true;

    btnStopAllSend.disabled = true;
    btnFlipCam.disabled = true;
    btnMicMute.disabled = true;
    btnNightLocal.disabled = true;
    btnTorch.disabled = true;
    btnMakeOffer.disabled = true;
    btnFullLocal.disabled = true;

    micOn = true;
    btnMicMute.textContent = "🎤 マイク：ON";
    nightLocalOn = false;
    localVideo.classList.remove("night");
    btnNightLocal.textContent = "🌙 暗視：OFF";
    torchOn = false;
    btnTorch.textContent = "🔦 ライト：OFF";
    btnTorch.disabled = true; // 再開後に再判定
    camInfo.textContent = "未開始";

    sendConn.textContent = "停止";
  }

  async function flipCamera(){
    currentFacing = (currentFacing === "environment") ? "user" : "environment";
    if(sendStream) sendStream.getTracks().forEach(t=>t.stop());
    sendStream = null;
    await startCameraHighest();
  }

  function toggleMic(){
    if(!sendStream) return;
    const atrack = sendStream.getAudioTracks()[0];
    if(!atrack) return;
    micOn = !micOn;
    atrack.enabled = micOn;
    btnMicMute.textContent = micOn ? "🎤 マイク：ON" : "🎤 マイク：MUTE";
  }

  function toggleNightLocal(){
    nightLocalOn = !nightLocalOn;
    localVideo.classList.toggle("night", nightLocalOn);
    btnNightLocal.textContent = nightLocalOn ? "🌙 暗視：ON" : "🌙 暗視：OFF";
  }

  async function toggleTorch(){
    if(!sendStream) return;
    const vtrack = sendStream.getVideoTracks()[0];
    if(!vtrack) return;
    try{
      torchOn = !torchOn;
      await vtrack.applyConstraints({ advanced: [{ torch: torchOn }] });
      btnTorch.textContent = torchOn ? "🔦 ライト：ON" : "🔦 ライト：OFF";
      btnTorch.disabled = false;
    }catch{
      torchOn = false;
      btnTorch.textContent = "🔦 ライト：非対応";
      btnTorch.disabled = true;
    }
  }

  async function makeOffer(){
    if(!sendStream) throw new Error("先に「カメラ開始」をしてください。");

    // 既存があればクローズ
    try{ if(sendPc) sendPc.close(); }catch{}
    sendPc = new RTCPeerConnection(pcConfig);

    sendStream.getTracks().forEach(tr=>sendPc.addTrack(tr, sendStream));

    const candidates = [];
    sendPc.onicecandidate = (e)=>{
      if(!e.candidate) return;
      const s = e.candidate.candidate || "";
      if(isHostCandidate(s)) candidates.push(e.candidate);
    };
    sendPc.onconnectionstatechange = ()=>{ sendConn.textContent = sendPc.connectionState; };

    const offer = await sendPc.createOffer();
    await sendPc.setLocalDescription(offer);
    await waitIceComplete(sendPc);

    const payload = { sdp: sendPc.localDescription, candidates };
    const text = JSON.stringify(payload);

    offerOut.value = text;
    btnCopyOffer.disabled = false;
    btnShareOffer.disabled = false;
    btnPasteAnswer.disabled = false;
    btnConnectSend.disabled = false;
    sendConn.textContent = "Offer作成済（受信側へ共有）";
  }

  async function connectWithAnswer(){
    if(!sendPc) throw new Error("先に「Offer作成」をしてください。");
    const raw = (answerIn.value || "").trim();
    if(!raw) throw new Error("Answerを貼り付けてください。");

    let payload;
    try{ payload = JSON.parse(raw); }
    catch{ throw new Error("Answerの形式が不正です（途中で欠けている可能性）。"); }

    await sendPc.setRemoteDescription(payload.sdp);
    if(Array.isArray(payload.candidates)){
      for(const c of payload.candidates){
        const s = c.candidate || "";
        if(isHostCandidate(s)){
          try{ await sendPc.addIceCandidate(c); }catch{}
        }
      }
    }
    sendConn.textContent = "接続中…";
  }

  btnStartCam.addEventListener("click", async ()=>{
    try{
      globalState.textContent = "送信：カメラ開始中…";
      btnTorch.disabled = false;
      await startCameraHighest();
      globalState.textContent = "送信：準備OK";
    }catch(e){
      globalState.textContent = "エラー";
      alert("カメラ/マイクの許可が必要です（HTTPSで開いてください）。");
      throw e;
    }
  });
  btnStopAllSend.addEventListener("click", stopSenderAll);
  btnFlipCam.addEventListener("click", async ()=>{ try{ await flipCamera(); }catch{ alert("カメラ切替に失敗しました"); } });
  btnMicMute.addEventListener("click", toggleMic);
  btnNightLocal.addEventListener("click", toggleNightLocal);
  btnTorch.addEventListener("click", toggleTorch);
  btnFullLocal.addEventListener("click", ()=>togglePseudoFS(localWrap, localVideo));
  localVideo.addEventListener("dblclick", ()=>togglePseudoFS(localWrap, localVideo));

  btnMakeOffer.addEventListener("click", async ()=>{
    try{
      globalState.textContent = "送信：Offer作成中…";
      await makeOffer();
      globalState.textContent = "送信：Offer作成済（共有へ）";
    }catch(e){
      globalState.textContent = "エラー";
      alert(e.message || "Offer作成に失敗しました");
      throw e;
    }
  });

  btnCopyOffer.addEventListener("click", ()=>safeCopy(offerOut.value));
  btnShareOffer.addEventListener("click", ()=>shareText("ベビーモニター Offer", offerOut.value));

  btnPasteAnswer.addEventListener("click", async ()=>{
    const t = (await safePaste()).trim();
    if(t) answerIn.value = t;
  });

  btnConnectSend.addEventListener("click", async ()=>{
    try{
      globalState.textContent = "送信：接続中…";
      await connectWithAnswer();
      globalState.textContent = "送信：接続処理OK（状態を確認）";
    }catch(e){
      globalState.textContent = "エラー";
      alert(e.message || "接続に失敗しました");
      throw e;
    }
  });

  // ===== Receiver =====
  let recvPc = null;
  let recvStream = null;
  let spkOn = true;
  let nightRemoteOn = false;

  function resetReceiverAll(){
    try{ if(recvPc) recvPc.close(); }catch{}
    recvPc = null;
    recvStream = null;

    remoteVideo.srcObject = null;
    answerOut.value = "";

    btnShareAnswer.disabled = true;
    btnCopyAnswer.disabled = true;

    btnPlayRemote.disabled = true;
    btnSpkMute.disabled = true;
    btnNightRemote.disabled = true;
    btnFullRemote.disabled = true;
    btnForceIOSFS.disabled = true;

    btnResetRecv.disabled = true;

    spkOn = true;
    remoteVideo.muted = false;
    btnSpkMute.textContent = "🔈 音：ON";

    nightRemoteOn = false;
    remoteVideo.classList.remove("night");
    btnNightRemote.textContent = "🌙 暗視：OFF";

    recvConn.textContent = "未接続";
    globalState.textContent = "受信：待機中";
  }

  async function makeAnswer(){
    const raw = (offerIn.value || "").trim();
    if(!raw) throw new Error("Offerを貼り付けてください。");

    let offerPayload;
    try{ offerPayload = JSON.parse(raw); }
    catch{ throw new Error("Offerの形式が不正です（途中で欠けている可能性）。"); }

    try{ if(recvPc) recvPc.close(); }catch{}
    recvPc = new RTCPeerConnection(pcConfig);

    const candidates = [];
    recvPc.onicecandidate = (e)=>{
      if(!e.candidate) return;
      const s = e.candidate.candidate || "";
      if(isHostCandidate(s)) candidates.push(e.candidate);
    };

    recvPc.ontrack = (e)=>{
      if(!recvStream) recvStream = new MediaStream();
      recvStream.addTrack(e.track);
      remoteVideo.srcObject = recvStream;

      btnPlayRemote.disabled = false;
      btnSpkMute.disabled = false;
      btnNightRemote.disabled = false;
      btnFullRemote.disabled = false;
      btnForceIOSFS.disabled = false;
      btnResetRecv.disabled = false;

      // autoplay try (will often fail on iOS for audio)
      remoteVideo.play().catch(()=>{});
    };

    recvPc.onconnectionstatechange = ()=>{ recvConn.textContent = recvPc.connectionState; };

    await recvPc.setRemoteDescription(offerPayload.sdp);
    if(Array.isArray(offerPayload.candidates)){
      for(const c of offerPayload.candidates){
        const s = c.candidate || "";
        if(isHostCandidate(s)){
          try{ await recvPc.addIceCandidate(c); }catch{}
        }
      }
    }

    const answer = await recvPc.createAnswer();
    await recvPc.setLocalDescription(answer);
    await waitIceComplete(recvPc);

    const payload = { sdp: recvPc.localDescription, candidates };
    const outText = JSON.stringify(payload);

    answerOut.value = outText;
    btnShareAnswer.disabled = false;
    btnCopyAnswer.disabled = false;
    btnResetRecv.disabled = false;

    globalState.textContent = "受信：Answer作成済（送信側へ返す）";
    recvConn.textContent = "Answer作成済";
  }

  btnPasteOffer.addEventListener("click", async ()=>{
    const t = (await safePaste()).trim();
    if(t) offerIn.value = t;
  });

  btnMakeAnswer.addEventListener("click", async ()=>{
    try{
      globalState.textContent = "受信：Answer作成中…";
      await makeAnswer();
    }catch(e){
      globalState.textContent = "エラー";
      alert(e.message || "Answer作成に失敗しました");
      throw e;
    }
  });

  btnShareAnswer.addEventListener("click", ()=>shareText("ベビーモニター Answer", answerOut.value));
  btnCopyAnswer.addEventListener("click", ()=>safeCopy(answerOut.value));

  btnPlayRemote.addEventListener("click", async ()=>{
    try{
      // iOS autoplay制限突破：ユーザー操作で play
      await remoteVideo.play();
      toast("再生しました");
    }catch{
      alert("再生できません。ミュートONにしてから再生→後で音ONにすると成功しやすいです。");
    }
  });

  btnSpkMute.addEventListener("click", ()=>{
    spkOn = !spkOn;
    remoteVideo.muted = !spkOn;
    btnSpkMute.textContent = spkOn ? "🔈 音：ON" : "🔇 音：MUTE";
  });

  btnNightRemote.addEventListener("click", ()=>{
    nightRemoteOn = !nightRemoteOn;
    remoteVideo.classList.toggle("night", nightRemoteOn);
    btnNightRemote.textContent = nightRemoteOn ? "🌙 暗視：ON" : "🌙 暗視：OFF";
  });

  btnFullRemote.addEventListener("click", ()=>togglePseudoFS(remoteWrap, remoteVideo));
  remoteVideo.addEventListener("dblclick", ()=>togglePseudoFS(remoteWrap, remoteVideo));

  // iOSネイティブのvideo fullscreen（対応端末のみ）
  btnForceIOSFS.addEventListener("click", ()=>{
    try{
      if(remoteVideo.webkitEnterFullscreen) remoteVideo.webkitEnterFullscreen();
      else togglePseudoFS(remoteWrap, remoteVideo);
    }catch{
      togglePseudoFS(remoteWrap, remoteVideo);
    }
  });

  btnResetRecv.addEventListener("click", resetReceiverAll);

  // ===== Init =====
  resetReceiverAll();
  btnTorch.disabled = true;

  // unload cleanup
  window.addEventListener("beforeunload", ()=>{
    stopSenderAll();
    resetReceiverAll();
  });

})();
</script>
</body>
</html>
