<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ãƒ™ãƒ“ãƒ¼ãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼ˆLANé™å®š / 1ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { -webkit-tap-highlight-color: transparent; }
    video { background:#000; }
    .night { filter: brightness(1.9) contrast(1.45) saturate(0.85); }
    .glass { backdrop-filter: blur(10px); }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-4xl mx-auto p-4 space-y-4">
    <!-- Header -->
    <header class="space-y-2">
      <div class="flex items-center justify-between gap-2 flex-wrap">
        <div class="text-xl font-black">ãƒ™ãƒ“ãƒ¼ãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼ˆåŒã˜Wi-Fiå†… / 1ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰</div>
        <div id="badgeLan" class="text-xs font-bold px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">
          LANé™å®šãƒ¢ãƒ¼ãƒ‰
        </div>
      </div>
      <div class="text-xs text-slate-500 leading-relaxed">
        â€»åŒ»ç™‚æ©Ÿå™¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚çŸ­æ™‚é–“ã®â€œè£œåŠ©â€ç”¨é€”ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚<br/>
        â€»HTTPSå¿…é ˆï¼ˆGitHub Pagesç­‰ï¼‰ã€‚åŒã˜Wi-Fiå†…ã§ä½¿ã£ã¦ãã ã•ã„ï¼ˆã‚²ã‚¹ãƒˆWi-Fiç­‰ã®ç«¯æœ«éš”é›¢ãŒã‚ã‚‹ã¨æ¥ç¶šã§ãã¾ã›ã‚“ï¼‰ã€‚
      </div>
    </header>

    <!-- Mode & Password -->
    <section class="bg-white rounded-3xl border border-slate-200 p-4 space-y-4 shadow-sm">
      <div class="flex items-center justify-between gap-3 flex-wrap">
        <div class="font-black text-slate-700">0ï¼‰ãƒ¢ãƒ¼ãƒ‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</div>
        <div class="text-xs text-slate-500">åŒã˜ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã®ã¿å¾©å·ãƒ»æ¥ç¶šã§ãã¾ã™</div>
      </div>

      <div class="grid md:grid-cols-2 gap-3">
        <div class="bg-slate-50 rounded-2xl p-3 border border-slate-200">
          <div class="text-sm font-bold text-slate-700 mb-2">ãƒ¢ãƒ¼ãƒ‰é¸æŠ</div>
          <div class="grid grid-cols-2 gap-2">
            <button id="btnModeSend" class="px-3 py-3 rounded-2xl font-black border border-slate-200 bg-white hover:bg-slate-100">
              ğŸ‘¶ é€ä¿¡ï¼ˆãƒ™ãƒ“ãƒ¼å´ï¼‰
            </button>
            <button id="btnModeRecv" class="px-3 py-3 rounded-2xl font-black border border-slate-200 bg-white hover:bg-slate-100">
              ğŸ‘€ å—ä¿¡ï¼ˆè¦‹å®ˆã‚Šå´ï¼‰
            </button>
          </div>
          <div class="mt-2 text-xs text-slate-500">
            åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’2å°ã§é–‹ãã€ç‰‡æ–¹ã‚’é€ä¿¡ãƒ»ã‚‚ã†ç‰‡æ–¹ã‚’å—ä¿¡ã«ã—ã¾ã™ã€‚
          </div>
        </div>

        <div class="bg-slate-50 rounded-2xl p-3 border border-slate-200 space-y-2">
          <div class="flex items-center justify-between">
            <div class="text-sm font-bold text-slate-700">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼š6ã€œ12æ¡ï¼‰</div>
            <button id="btnTogglePw" class="text-xs font-bold px-3 py-1 rounded-full bg-white border border-slate-200">è¡¨ç¤º</button>
          </div>
          <input id="pw" type="password" class="w-full rounded-2xl border border-slate-200 px-4 py-3 font-bold"
                 placeholder="åŒã˜ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä¸¡ç«¯æœ«ã§å…¥åŠ›" />
          <div class="text-xs text-slate-500">
            ã“ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ç«¯æœ«å†…ã§æš—å·éµã«å¤‰æ›ã•ã‚Œã€Offer/Answerã‚³ãƒ¼ãƒ‰ã‚’æš—å·åŒ–ã—ã¾ã™ï¼ˆã‚µãƒ¼ãƒä¸è¦ï¼‰ã€‚
          </div>
        </div>
      </div>

      <div class="flex items-center justify-between gap-2 flex-wrap">
        <div class="text-sm">
          çŠ¶æ…‹ï¼š<span id="globalState" class="font-black text-slate-700">å¾…æ©Ÿä¸­</span>
        </div>
        <div class="text-xs text-slate-500">
          ãƒ–ãƒ©ã‚¦ã‚¶ï¼š<span id="uaHint"></span>
        </div>
      </div>
    </section>

    <!-- SEND VIEW -->
    <section id="sendView" class="space-y-4 hidden">
      <!-- Step 1: camera -->
      <section class="bg-white rounded-3xl border border-slate-200 p-4 space-y-4 shadow-sm">
        <div class="flex items-center justify-between gap-2 flex-wrap">
          <div class="font-black text-slate-700">1ï¼‰ã‚«ãƒ¡ãƒ©ãƒ»éŸ³å£°ã‚’é–‹å§‹ï¼ˆæœ€é«˜ç”»è³ªï¼‰</div>
          <div class="flex items-center gap-2">
            <button id="btnStartCam" class="px-4 py-2 rounded-2xl bg-sky-600 text-white font-black">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
            <button id="btnStopAllSend" class="px-4 py-2 rounded-2xl bg-slate-200 font-black" disabled>åœæ­¢</button>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <div class="text-sm font-bold text-slate-600">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
            <video id="localVideo" class="w-full rounded-3xl aspect-video" playsinline muted autoplay></video>

            <div class="grid grid-cols-2 gap-2">
              <button id="btnFlipCam" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>ğŸ“· å‰/å¾Œåˆ‡æ›¿</button>
              <button id="btnMicMute" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>ğŸ¤ ãƒã‚¤ã‚¯ï¼šON</button>
              <button id="btnNightLocal" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>ğŸŒ™ æš—è¦–ï¼šOFF</button>
              <button id="btnTorch" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>ğŸ”¦ ãƒ©ã‚¤ãƒˆï¼šOFF</button>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3 text-xs text-slate-600">
              <div class="font-bold text-slate-700 mb-1">å®Ÿéš›ã®æ’®å½±è¨­å®š</div>
              <div id="camInfo">æœªé–‹å§‹</div>
              <div class="mt-1 text-slate-500">â€»ç«¯æœ«ãŒå¯¾å¿œã™ã‚‹ç¯„å›²ã§æœ€å¤§ã«ãªã‚Šã¾ã™ï¼ˆç†æƒ³å€¤ï¼š4K/30fpsï¼‰ã€‚</div>
            </div>
          </div>

          <div class="space-y-2">
            <div class="text-sm font-bold text-slate-600">æ¥ç¶šã®æµã‚Œï¼ˆé€ä¿¡å´ï¼‰</div>

            <div class="bg-indigo-50 border border-indigo-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-indigo-900">2ï¼‰Offerã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦æ¸¡ã™</div>
              <div class="text-indigo-700 text-xs mt-1">ã€ŒOfferä½œæˆã€â†’ã‚³ãƒ”ãƒ¼â†’å—ä¿¡å´ã¸è²¼ã‚Šä»˜ã‘</div>
              <div class="mt-2 flex gap-2 flex-wrap">
                <button id="btnMakeOffer" class="px-4 py-2 rounded-2xl bg-indigo-600 text-white font-black" disabled>Offerä½œæˆ</button>
                <button id="btnCopyOffer" class="px-4 py-2 rounded-2xl bg-slate-200 font-black" disabled>Offerã‚’ã‚³ãƒ”ãƒ¼</button>
              </div>
              <textarea id="offerOut" class="mt-2 w-full h-28 rounded-2xl border border-indigo-200 p-3 text-xs font-mono"
                        placeholder="Offerã‚³ãƒ¼ãƒ‰ï¼ˆæš—å·åŒ–æ¸ˆã¿ï¼‰ãŒã“ã“ã«å‡ºã¾ã™" readonly></textarea>
            </div>

            <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-emerald-900">3ï¼‰Answerã‚³ãƒ¼ãƒ‰ã‚’å—ã‘å–ã£ã¦æ¥ç¶š</div>
              <div class="text-emerald-700 text-xs mt-1">å—ä¿¡å´ã§ä½œã£ãŸAnswerã‚’è²¼ã‚Šä»˜ã‘â†’ã€Œæ¥ç¶šã€</div>
              <div class="mt-2 flex gap-2 flex-wrap">
                <button id="btnConnectSend" class="px-4 py-2 rounded-2xl bg-emerald-600 text-white font-black" disabled>æ¥ç¶š</button>
              </div>
              <textarea id="answerIn" class="mt-2 w-full h-28 rounded-2xl border border-emerald-200 p-3 text-xs font-mono"
                        placeholder="Answerã‚³ãƒ¼ãƒ‰ï¼ˆæš—å·åŒ–æ¸ˆã¿ï¼‰ã‚’è²¼ã‚Šä»˜ã‘"></textarea>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-slate-700">æ¥ç¶šçŠ¶æ…‹</div>
              <div class="mt-1 text-sm">Peerï¼š<span id="sendConn" class="font-black">æœªæ¥ç¶š</span></div>
              <div class="text-xs text-slate-500 mt-1">â€»LANé™å®šï¼ˆhostå€™è£œã®ã¿ï¼‰ã€‚å¤–éƒ¨å›ç·šã‹ã‚‰ã¯åŸºæœ¬çš„ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚</div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <!-- RECV VIEW -->
    <section id="recvView" class="space-y-4 hidden">
      <section class="bg-white rounded-3xl border border-slate-200 p-4 space-y-4 shadow-sm">
        <div class="flex items-center justify-between gap-2 flex-wrap">
          <div class="font-black text-slate-700">1ï¼‰Offerã‚³ãƒ¼ãƒ‰ã‚’å—ã‘å–ã£ã¦Answerã‚’è¿”ã™</div>
          <div class="flex items-center gap-2">
            <button id="btnResetRecv" class="px-4 py-2 rounded-2xl bg-slate-200 font-black" disabled>åˆ‡æ–­/ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <div class="bg-indigo-50 border border-indigo-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-indigo-900">Offerã‚³ãƒ¼ãƒ‰ï¼ˆé€ä¿¡å´â†’å—ä¿¡å´ï¼‰</div>
              <textarea id="offerIn" class="mt-2 w-full h-28 rounded-2xl border border-indigo-200 p-3 text-xs font-mono"
                        placeholder="é€ä¿¡å´ã®Offerã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘"></textarea>
              <div class="mt-2 flex gap-2 flex-wrap">
                <button id="btnMakeAnswer" class="px-4 py-2 rounded-2xl bg-indigo-600 text-white font-black">Answerä½œæˆ</button>
              </div>
            </div>

            <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-emerald-900">Answerã‚³ãƒ¼ãƒ‰ï¼ˆå—ä¿¡å´â†’é€ä¿¡å´ï¼‰</div>
              <div class="text-emerald-700 text-xs mt-1">ä½œæˆâ†’ã‚³ãƒ”ãƒ¼â†’é€ä¿¡å´ã«è²¼ã‚Šä»˜ã‘</div>
              <div class="mt-2 flex gap-2 flex-wrap">
                <button id="btnCopyAnswer" class="px-4 py-2 rounded-2xl bg-slate-200 font-black" disabled>Answerã‚’ã‚³ãƒ”ãƒ¼</button>
              </div>
              <textarea id="answerOut" class="mt-2 w-full h-28 rounded-2xl border border-emerald-200 p-3 text-xs font-mono"
                        placeholder="Answerã‚³ãƒ¼ãƒ‰ï¼ˆæš—å·åŒ–æ¸ˆã¿ï¼‰ãŒã“ã“ã«å‡ºã¾ã™" readonly></textarea>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3 text-sm">
              <div class="font-black text-slate-700">æ¥ç¶šçŠ¶æ…‹</div>
              <div class="mt-1 text-sm">Peerï¼š<span id="recvConn" class="font-black">æœªæ¥ç¶š</span></div>
              <div class="text-xs text-slate-500 mt-1">iPhone/iPadã¯è‡ªå‹•å†ç”Ÿåˆ¶é™ãŒã‚ã‚‹ãŸã‚ã€æ˜ åƒãŒå‡ºã¦ã‚‚éŸ³ãŒå‡ºãªã„æ™‚ã¯ã€Œå†ç”Ÿã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
            </div>
          </div>

          <div class="space-y-2">
            <div class="text-sm font-bold text-slate-600">å—ä¿¡æ˜ åƒ</div>
            <video id="remoteVideo" class="w-full rounded-3xl aspect-video" playsinline autoplay></video>

            <div class="grid grid-cols-2 gap-2">
              <button id="btnPlayRemote" class="px-3 py-2 rounded-2xl bg-emerald-600 text-white font-black" disabled>â–¶ å†ç”Ÿ</button>
              <button id="btnSpkMute" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>ğŸ”ˆ éŸ³ï¼šON</button>
              <button id="btnNightRemote" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>ğŸŒ™ æš—è¦–ï¼šOFF</button>
              <button id="btnFull" class="px-3 py-2 rounded-2xl border border-slate-200 bg-white font-bold" disabled>â›¶ å…¨ç”»é¢</button>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3 text-xs text-slate-600">
              <div class="font-bold text-slate-700 mb-1">å—ä¿¡ã®ãƒ’ãƒ³ãƒˆ</div>
              <ul class="list-disc pl-5 space-y-1">
                <li>åŒã˜Wi-Fiã§ã‚‚ã€Œç«¯æœ«éš”é›¢ï¼ˆAP isolationï¼‰ã€ãŒã‚ã‚‹ã¨æ¥ç¶šã§ãã¾ã›ã‚“ï¼ˆãƒ›ãƒ†ãƒ«/ä¸€éƒ¨ã‚²ã‚¹ãƒˆWi-Fiãªã©ï¼‰ã€‚</li>
                <li>å¤–éƒ¨ã‹ã‚‰ã®æ¥ç¶šã¯æƒ³å®šã—ã¾ã›ã‚“ï¼ˆLANå€™è£œã®ã¿ã§ä½œã£ã¦ã„ã¾ã™ï¼‰ã€‚</li>
              </ul>
            </div>
          </div>
        </div>
      </section>
    </section>

    <div class="text-[11px] text-slate-500 px-1">
      ğŸ”’ ã“ã®ã‚¢ãƒ—ãƒªã¯ã€Œæ¥ç¶šæƒ…å ±ã‚’ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§æš—å·åŒ–ã€ã—ã¾ã™ã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã†ã¨å¾©å·ã§ããšã€æ¥ç¶šã§ãã¾ã›ã‚“ã€‚
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // UI
  const uaHint = $("uaHint");
  const globalState = $("globalState");
  const btnModeSend = $("btnModeSend");
  const btnModeRecv = $("btnModeRecv");
  const sendView = $("sendView");
  const recvView = $("recvView");
  const pwEl = $("pw");
  const btnTogglePw = $("btnTogglePw");

  // Send UI
  const btnStartCam = $("btnStartCam");
  const btnStopAllSend = $("btnStopAllSend");
  const btnFlipCam = $("btnFlipCam");
  const btnMicMute = $("btnMicMute");
  const btnNightLocal = $("btnNightLocal");
  const btnTorch = $("btnTorch");
  const localVideo = $("localVideo");
  const camInfo = $("camInfo");
  const btnMakeOffer = $("btnMakeOffer");
  const btnCopyOffer = $("btnCopyOffer");
  const offerOut = $("offerOut");
  const answerIn = $("answerIn");
  const btnConnectSend = $("btnConnectSend");
  const sendConn = $("sendConn");

  // Recv UI
  const btnResetRecv = $("btnResetRecv");
  const offerIn = $("offerIn");
  const btnMakeAnswer = $("btnMakeAnswer");
  const answerOut = $("answerOut");
  const btnCopyAnswer = $("btnCopyAnswer");
  const recvConn = $("recvConn");
  const remoteVideo = $("remoteVideo");
  const btnPlayRemote = $("btnPlayRemote");
  const btnSpkMute = $("btnSpkMute");
  const btnNightRemote = $("btnNightRemote");
  const btnFull = $("btnFull");

  uaHint.textContent = navigator.userAgent.includes("iPhone") || navigator.userAgent.includes("iPad")
    ? "iOSï¼ˆå†ç”Ÿãƒœã‚¿ãƒ³ãŒå¿…è¦ãªå ´åˆã‚ã‚Šï¼‰"
    : "OK";

  // ====== LAN-only WebRTC policy ======
  // STUN/TURNãªã— + hostå€™è£œã®ã¿ã‚’åˆ©ç”¨ï¼ˆå¤–éƒ¨å›ç·šã‹ã‚‰ã®æ¥ç¶šã‚’é¿ã‘ã‚‹æ„å›³ï¼‰
  const pcConfig = { iceServers: [] };

  function isHostCandidate(candStr) {
    // "typ host" ã®ã¿
    return / typ host /i.test(candStr);
  }

  // ====== Crypto (password-gated offer/answer) ======
  const te = new TextEncoder();
  const td = new TextDecoder();

  function b64uEncode(u8) {
    let s = btoa(String.fromCharCode(...u8));
    return s.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
  }
  function b64uDecode(s) {
    s = s.replace(/-/g, "+").replace(/_/g, "/");
    while (s.length % 4) s += "=";
    const bin = atob(s);
    const u8 = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) u8[i] = bin.charCodeAt(i);
    return u8;
  }

  async function deriveKey(pass, saltU8) {
    const baseKey = await crypto.subtle.importKey(
      "raw",
      te.encode(pass),
      { name: "PBKDF2" },
      false,
      ["deriveKey"]
    );
    return crypto.subtle.deriveKey(
      {
        name: "PBKDF2",
        salt: saltU8,
        iterations: 120000,
        hash: "SHA-256"
      },
      baseKey,
      { name: "AES-GCM", length: 256 },
      false,
      ["encrypt", "decrypt"]
    );
  }

  async function encryptJSON(pass, obj) {
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const key = await deriveKey(pass, salt);
    const plain = te.encode(JSON.stringify(obj));
    const cipher = new Uint8Array(await crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, plain));
    return "v1." + b64uEncode(salt) + "." + b64uEncode(iv) + "." + b64uEncode(cipher);
  }

  async function decryptJSON(pass, blob) {
    const parts = (blob || "").trim().split(".");
    if (parts.length !== 4 || parts[0] !== "v1") throw new Error("å½¢å¼ãŒä¸æ­£ã§ã™");
    const salt = b64uDecode(parts[1]);
    const iv = b64uDecode(parts[2]);
    const cipher = b64uDecode(parts[3]);
    const key = await deriveKey(pass, salt);
    const plainBuf = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, cipher);
    return JSON.parse(td.decode(new Uint8Array(plainBuf)));
  }

  function mustPw() {
    const p = pwEl.value || "";
    if (p.length < 4) throw new Error("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ4æ–‡å­—ä»¥ä¸Šæ¨å¥¨ï¼‰");
    return p;
  }

  async function safeCopy(text) {
    if (!text) return;
    try { await navigator.clipboard.writeText(text); }
    catch {
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
    }
  }

  function setMode(mode) {
    // mode: "send" | "recv"
    if (mode === "send") {
      sendView.classList.remove("hidden");
      recvView.classList.add("hidden");
      btnModeSend.className = "px-3 py-3 rounded-2xl font-black border border-slate-200 bg-sky-50 text-sky-700";
      btnModeRecv.className = "px-3 py-3 rounded-2xl font-black border border-slate-200 bg-white hover:bg-slate-100";
      globalState.textContent = "é€ä¿¡ãƒ¢ãƒ¼ãƒ‰";
    } else {
      recvView.classList.remove("hidden");
      sendView.classList.add("hidden");
      btnModeRecv.className = "px-3 py-3 rounded-2xl font-black border border-slate-200 bg-emerald-50 text-emerald-700";
      btnModeSend.className = "px-3 py-3 rounded-2xl font-black border border-slate-200 bg-white hover:bg-slate-100";
      globalState.textContent = "å—ä¿¡ãƒ¢ãƒ¼ãƒ‰";
    }
  }

  btnModeSend.addEventListener("click", () => setMode("send"));
  btnModeRecv.addEventListener("click", () => setMode("recv"));
  setMode("send");

  btnTogglePw.addEventListener("click", () => {
    const isPw = pwEl.type === "password";
    pwEl.type = isPw ? "text" : "password";
    btnTogglePw.textContent = isPw ? "éè¡¨ç¤º" : "è¡¨ç¤º";
  });

  // ====== Sender logic ======
  let sendPc = null;
  let sendStream = null;
  let currentFacing = "environment"; // "user" | "environment"
  let micOn = true;
  let nightLocalOn = false;
  let torchOn = false;

  async function startCameraHighest() {
    // â€œæœ€é«˜ç”»è³ªâ€è¦æ±‚ï¼ˆç«¯æœ«ãŒå¯èƒ½ãªæœ€å¤§ã¸ï¼‰
    const constraints = {
      audio: true,
      video: {
        facingMode: { ideal: currentFacing },
        width: { ideal: 3840 },
        height: { ideal: 2160 },
        frameRate: { ideal: 30, max: 60 }
      }
    };
    sendStream = await navigator.mediaDevices.getUserMedia(constraints);
    localVideo.srcObject = sendStream;

    // UI enable
    btnStopAllSend.disabled = false;
    btnFlipCam.disabled = false;
    btnMicMute.disabled = false;
    btnNightLocal.disabled = false;
    btnTorch.disabled = false;
    btnMakeOffer.disabled = false;

    // show actual settings
    const vtrack = sendStream.getVideoTracks()[0];
    const atrack = sendStream.getAudioTracks()[0];
    const s = vtrack.getSettings ? vtrack.getSettings() : {};
    camInfo.textContent = [
      `è§£åƒåº¦ï¼š${s.width || "?"} x ${s.height || "?"}`,
      `FPSï¼š${s.frameRate || "?"}`,
      `ã‚«ãƒ¡ãƒ©ï¼š${(s.facingMode || currentFacing)}`,
      `éŸ³å£°ï¼š${atrack ? "æœ‰åŠ¹" : "ãªã—"}`
    ].join(" / ");

    sendConn.textContent = "é…ä¿¡ä¸­ï¼ˆOfferä½œæˆã¸ï¼‰";
  }

  function stopSenderAll() {
    try { if (sendPc) sendPc.close(); } catch {}
    sendPc = null;

    if (sendStream) {
      sendStream.getTracks().forEach(t => t.stop());
    }
    sendStream = null;

    offerOut.value = "";
    answerIn.value = "";
    btnCopyOffer.disabled = true;
    btnConnectSend.disabled = true;

    btnStopAllSend.disabled = true;
    btnFlipCam.disabled = true;
    btnMicMute.disabled = true;
    btnNightLocal.disabled = true;
    btnTorch.disabled = true;
    btnMakeOffer.disabled = true;

    micOn = true;
    btnMicMute.textContent = "ğŸ¤ ãƒã‚¤ã‚¯ï¼šON";
    nightLocalOn = false;
    localVideo.classList.remove("night");
    btnNightLocal.textContent = "ğŸŒ™ æš—è¦–ï¼šOFF";
    torchOn = false;
    btnTorch.textContent = "ğŸ”¦ ãƒ©ã‚¤ãƒˆï¼šOFF";
    camInfo.textContent = "æœªé–‹å§‹";

    sendConn.textContent = "åœæ­¢";
  }

  async function flipCamera() {
    currentFacing = (currentFacing === "environment") ? "user" : "environment";
    // restart stream
    stopSenderTracksOnly();
    await startCameraHighest();
  }

  function stopSenderTracksOnly() {
    if (sendStream) sendStream.getTracks().forEach(t => t.stop());
    sendStream = null;
  }

  function toggleMic() {
    if (!sendStream) return;
    const atrack = sendStream.getAudioTracks()[0];
    if (!atrack) return;
    micOn = !micOn;
    atrack.enabled = micOn;
    btnMicMute.textContent = micOn ? "ğŸ¤ ãƒã‚¤ã‚¯ï¼šON" : "ğŸ¤ ãƒã‚¤ã‚¯ï¼šMUTE";
  }

  function toggleNightLocal() {
    nightLocalOn = !nightLocalOn;
    localVideo.classList.toggle("night", nightLocalOn);
    btnNightLocal.textContent = nightLocalOn ? "ğŸŒ™ æš—è¦–ï¼šON" : "ğŸŒ™ æš—è¦–ï¼šOFF";
  }

  async function toggleTorch() {
    if (!sendStream) return;
    const vtrack = sendStream.getVideoTracks()[0];
    if (!vtrack) return;
    // Torchã¯ç«¯æœ«ãƒ»ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œãŒå¿…è¦
    try {
      torchOn = !torchOn;
      await vtrack.applyConstraints({ advanced: [{ torch: torchOn }] });
      btnTorch.textContent = torchOn ? "ğŸ”¦ ãƒ©ã‚¤ãƒˆï¼šON" : "ğŸ”¦ ãƒ©ã‚¤ãƒˆï¼šOFF";
    } catch (e) {
      torchOn = false;
      btnTorch.textContent = "ğŸ”¦ ãƒ©ã‚¤ãƒˆï¼šéå¯¾å¿œ";
      btnTorch.disabled = true;
    }
  }

  function waitIceComplete(pc, timeoutMs=1500) {
    return new Promise(resolve => {
      if (pc.iceGatheringState === "complete") return resolve();
      const t = setTimeout(() => {
        pc.removeEventListener("icegatheringstatechange", onChange);
        resolve();
      }, timeoutMs);
      function onChange() {
        if (pc.iceGatheringState === "complete") {
          clearTimeout(t);
          pc.removeEventListener("icegatheringstatechange", onChange);
          resolve();
        }
      }
      pc.addEventListener("icegatheringstatechange", onChange);
    });
  }

  async function makeOfferEncrypted() {
    const pass = mustPw();
    if (!sendStream) throw new Error("å…ˆã«ã‚«ãƒ¡ãƒ©é–‹å§‹ã‚’ã—ã¦ãã ã•ã„ã€‚");

    sendPc = new RTCPeerConnection(pcConfig);

    // add tracks
    sendStream.getTracks().forEach(tr => sendPc.addTrack(tr, sendStream));

    const candidates = [];
    sendPc.onicecandidate = (e) => {
      if (!e.candidate) return;
      const s = e.candidate.candidate || "";
      if (isHostCandidate(s)) candidates.push(e.candidate);
    };

    sendPc.onconnectionstatechange = () => {
      sendConn.textContent = sendPc.connectionState;
    };

    const offer = await sendPc.createOffer();
    await sendPc.setLocalDescription(offer);
    await waitIceComplete(sendPc);

    const payload = {
      sdp: sendPc.localDescription,
      candidates
    };

    const blob = await encryptJSON(pass, payload);
    offerOut.value = blob;
    btnCopyOffer.disabled = false;
    btnConnectSend.disabled = false;
    sendConn.textContent = "Offerä½œæˆæ¸ˆï¼ˆå—ä¿¡å´ã¸æ¸¡ã—ã¦ãã ã•ã„ï¼‰";
  }

  async function connectWithEncryptedAnswer() {
    const pass = mustPw();
    if (!sendPc) throw new Error("Offerä½œæˆå¾Œã«æ¥ç¶šã—ã¦ãã ã•ã„ã€‚");
    const blob = (answerIn.value || "").trim();
    if (!blob) throw new Error("Answerã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");

    let payload;
    try {
      payload = await decryptJSON(pass, blob);
    } catch (e) {
      throw new Error("å¾©å·ã«å¤±æ•—ï¼šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã„ï¼ã‚³ãƒ¼ãƒ‰ãŒå£Šã‚Œã¦ã„ã¾ã™ã€‚");
    }

    await sendPc.setRemoteDescription(payload.sdp);
    if (Array.isArray(payload.candidates)) {
      for (const c of payload.candidates) {
        const s = c.candidate || "";
        if (isHostCandidate(s)) {
          try { await sendPc.addIceCandidate(c); } catch {}
        }
      }
    }
    sendConn.textContent = "æ¥ç¶šä¸­â€¦";
  }

  btnStartCam.addEventListener("click", async () => {
    try {
      globalState.textContent = "é€ä¿¡ï¼šã‚«ãƒ¡ãƒ©é–‹å§‹ä¸­â€¦";
      await startCameraHighest();
      globalState.textContent = "é€ä¿¡ï¼šæº–å‚™OK";
    } catch (e) {
      globalState.textContent = "ã‚¨ãƒ©ãƒ¼";
      alert("ã‚«ãƒ¡ãƒ©/ãƒã‚¤ã‚¯ã®è¨±å¯ãŒå¿…è¦ã§ã™ï¼ˆHTTPSã§é–‹ã„ã¦ãã ã•ã„ï¼‰ã€‚");
    }
  });

  btnStopAllSend.addEventListener("click", () => stopSenderAll());
  btnFlipCam.addEventListener("click", async () => {
    try { await flipCamera(); } catch { alert("ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
  });
  btnMicMute.addEventListener("click", () => toggleMic());
  btnNightLocal.addEventListener("click", () => toggleNightLocal());
  btnTorch.addEventListener("click", async () => await toggleTorch());

  btnMakeOffer.addEventListener("click", async () => {
    try {
      globalState.textContent = "é€ä¿¡ï¼šOfferä½œæˆä¸­â€¦";
      await makeOfferEncrypted();
      globalState.textContent = "é€ä¿¡ï¼šOfferä½œæˆæ¸ˆ";
    } catch (e) {
      globalState.textContent = "ã‚¨ãƒ©ãƒ¼";
      alert(e.message || "Offerä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  });

  btnCopyOffer.addEventListener("click", async () => {
    await safeCopy(offerOut.value);
  });

  btnConnectSend.addEventListener("click", async () => {
    try {
      globalState.textContent = "é€ä¿¡ï¼šæ¥ç¶šä¸­â€¦";
      await connectWithEncryptedAnswer();
      globalState.textContent = "é€ä¿¡ï¼šæ¥ç¶šå‡¦ç†OKï¼ˆçŠ¶æ…‹ã‚’ç¢ºèªï¼‰";
    } catch (e) {
      globalState.textContent = "ã‚¨ãƒ©ãƒ¼";
      alert(e.message || "æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  });

  // ====== Receiver logic ======
  let recvPc = null;
  let recvStream = null;
  let spkOn = true;
  let nightRemoteOn = false;

  function resetReceiverAll() {
    try { if (recvPc) recvPc.close(); } catch {}
    recvPc = null;
    recvStream = null;
    remoteVideo.srcObject = null;

    answerOut.value = "";
    btnCopyAnswer.disabled = true;
    btnPlayRemote.disabled = true;
    btnSpkMute.disabled = true;
    btnNightRemote.disabled = true;
    btnFull.disabled = true;
    btnResetRecv.disabled = true;

    spkOn = true;
    remoteVideo.muted = false;
    btnSpkMute.textContent = "ğŸ”ˆ éŸ³ï¼šON";
    nightRemoteOn = false;
    remoteVideo.classList.remove("night");
    btnNightRemote.textContent = "ğŸŒ™ æš—è¦–ï¼šOFF";

    recvConn.textContent = "æœªæ¥ç¶š";
    globalState.textContent = "å—ä¿¡ï¼šå¾…æ©Ÿä¸­";
  }

  async function makeAnswerEncrypted() {
    const pass = mustPw();
    const blob = (offerIn.value || "").trim();
    if (!blob) throw new Error("Offerã‚³ãƒ¼ãƒ‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚");

    let offerPayload;
    try {
      offerPayload = await decryptJSON(pass, blob);
    } catch (e) {
      throw new Error("å¾©å·ã«å¤±æ•—ï¼šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•ã„ï¼ã‚³ãƒ¼ãƒ‰ãŒå£Šã‚Œã¦ã„ã¾ã™ã€‚");
    }

    recvPc = new RTCPeerConnection(pcConfig);

    const candidates = [];
    recvPc.onicecandidate = (e) => {
      if (!e.candidate) return;
      const s = e.candidate.candidate || "";
      if (isHostCandidate(s)) candidates.push(e.candidate);
    };

    recvPc.ontrack = (e) => {
      if (!recvStream) recvStream = new MediaStream();
      recvStream.addTrack(e.track);
      remoteVideo.srcObject = recvStream;

      btnPlayRemote.disabled = false;
      btnSpkMute.disabled = false;
      btnNightRemote.disabled = false;
      btnFull.disabled = false;
      btnResetRecv.disabled = false;

      // try autoplay
      remoteVideo.play().catch(() => {});
    };

    recvPc.onconnectionstatechange = () => {
      recvConn.textContent = recvPc.connectionState;
    };

    await recvPc.setRemoteDescription(offerPayload.sdp);
    if (Array.isArray(offerPayload.candidates)) {
      for (const c of offerPayload.candidates) {
        const s = c.candidate || "";
        if (isHostCandidate(s)) {
          try { await recvPc.addIceCandidate(c); } catch {}
        }
      }
    }

    const answer = await recvPc.createAnswer();
    await recvPc.setLocalDescription(answer);
    await waitIceComplete(recvPc);

    const payload = {
      sdp: recvPc.localDescription,
      candidates
    };

    const outBlob = await encryptJSON(pass, payload);
    answerOut.value = outBlob;
    btnCopyAnswer.disabled = false;
    btnResetRecv.disabled = false;

    globalState.textContent = "å—ä¿¡ï¼šAnswerä½œæˆæ¸ˆï¼ˆé€ä¿¡å´ã¸è¿”ã™ï¼‰";
    recvConn.textContent = "Answerä½œæˆæ¸ˆ";
  }

  btnMakeAnswer.addEventListener("click", async () => {
    try {
      globalState.textContent = "å—ä¿¡ï¼šAnswerä½œæˆä¸­â€¦";
      await makeAnswerEncrypted();
    } catch (e) {
      globalState.textContent = "ã‚¨ãƒ©ãƒ¼";
      alert(e.message || "Answerä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  });

  btnCopyAnswer.addEventListener("click", async () => {
    await safeCopy(answerOut.value);
  });

  btnPlayRemote.addEventListener("click", async () => {
    try { await remoteVideo.play(); } catch {}
  });

  btnSpkMute.addEventListener("click", () => {
    spkOn = !spkOn;
    remoteVideo.muted = !spkOn;
    btnSpkMute.textContent = spkOn ? "ğŸ”ˆ éŸ³ï¼šON" : "ğŸ”‡ éŸ³ï¼šMUTE";
  });

  btnNightRemote.addEventListener("click", () => {
    nightRemoteOn = !nightRemoteOn;
    remoteVideo.classList.toggle("night", nightRemoteOn);
    btnNightRemote.textContent = nightRemoteOn ? "ğŸŒ™ æš—è¦–ï¼šON" : "ğŸŒ™ æš—è¦–ï¼šOFF";
  });

  btnFull.addEventListener("click", async () => {
    try {
      if (remoteVideo.requestFullscreen) await remoteVideo.requestFullscreen();
      else if (remoteVideo.webkitEnterFullscreen) remoteVideo.webkitEnterFullscreen();
    } catch {}
  });

  btnResetRecv.addEventListener("click", () => resetReceiverAll());

  // ====== Cleanup on unload ======
  window.addEventListener("beforeunload", () => {
    stopSenderAll();
    resetReceiverAll();
  });

  // åˆæœŸï¼šå—ä¿¡å´ã‚‚ã‚¯ãƒªã‚¢çŠ¶æ…‹ã«
  resetReceiverAll();
})();
</script>
</body>
</html>