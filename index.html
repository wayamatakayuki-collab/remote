<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ãƒ™ãƒ“ãƒ¼ãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼ˆå®¶LANé™å®š / 1ãƒ•ã‚¡ã‚¤ãƒ« / AirDropå³æ¥ç¶šï¼‰</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body { -webkit-tap-highlight-color: transparent; }
    video { background:#000; }
    .night { filter: brightness(2.0) contrast(1.5) saturate(0.85); }
    .glass { backdrop-filter: blur(12px); }
    .btn { @apply px-4 py-3 rounded-2xl font-black active:scale-[0.99] transition; }
    .btnSm { @apply px-3 py-2 rounded-2xl font-bold active:scale-[0.99] transition; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body class="bg-slate-50 text-slate-800">
  <div class="max-w-4xl mx-auto p-4 space-y-4">
    <!-- Header -->
    <header class="space-y-2">
      <div class="flex items-start justify-between gap-2 flex-wrap">
        <div>
          <div class="text-xl md:text-2xl font-black leading-tight">ãƒ™ãƒ“ãƒ¼ãƒ¢ãƒ‹ã‚¿ãƒ¼ï¼ˆå®¶LANé™å®š / AirDropå³æ¥ç¶šï¼‰</div>
          <div class="text-xs text-slate-500 mt-1">
            â€»GitHub Pagesç­‰ã®<strong>HTTPS</strong>ã§å‹•ä½œã—ã¾ã™ã€‚<strong>åŒã˜Wi-Fi</strong>ã§ä½¿ã£ã¦ãã ã•ã„ï¼ˆã‚²ã‚¹ãƒˆWi-Fiã®ç«¯æœ«éš”é›¢ãŒã‚ã‚‹ã¨æ¥ç¶šä¸å¯ï¼‰ã€‚
          </div>
        </div>
        <div class="flex gap-2 items-center">
          <div class="text-xs font-black px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">
            LANå‰æï¼ˆSTUN/TURNãªã—ï¼‰
          </div>
        </div>
      </div>

      <div class="bg-white rounded-3xl border border-slate-200 p-3 shadow-sm">
        <div class="flex items-center justify-between gap-2 flex-wrap">
          <div class="flex items-center gap-2">
            <div class="text-sm font-black text-slate-700">ãƒ¢ãƒ¼ãƒ‰</div>
            <div class="text-[11px] text-slate-500">åŒã˜ãƒšãƒ¼ã‚¸ã‚’2å°ã§é–‹ã„ã¦ã€ç‰‡æ–¹ã‚’é€ä¿¡ãƒ»ç‰‡æ–¹ã‚’å—ä¿¡ã«</div>
          </div>
          <div class="text-[11px] text-slate-500">ãƒ–ãƒ©ã‚¦ã‚¶ï¼š<span id="uaHint" class="font-bold"></span></div>
        </div>

        <div class="mt-2 grid grid-cols-2 gap-2">
          <button id="btnModeSend" class="btn bg-white border border-slate-200 hover:bg-slate-100">ğŸ‘¶ é€ä¿¡ï¼ˆãƒ™ãƒ“ãƒ¼å´ï¼‰</button>
          <button id="btnModeRecv" class="btn bg-white border border-slate-200 hover:bg-slate-100">ğŸ‘€ å—ä¿¡ï¼ˆè¦‹å®ˆã‚Šå´ï¼‰</button>
        </div>

        <div class="mt-2 flex items-center justify-between gap-2 flex-wrap">
          <div class="text-sm">
            çŠ¶æ…‹ï¼š<span id="globalState" class="font-black text-slate-700">å¾…æ©Ÿä¸­</span>
          </div>
          <div class="text-xs text-slate-500">
            ãƒ’ãƒ³ãƒˆï¼šAirDropã¯ã€Œå…±æœ‰ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ï¼ˆiPhone/iPadã§æœ€é€Ÿï¼‰
          </div>
        </div>
      </div>
    </header>

    <!-- SEND VIEW -->
    <section id="sendView" class="space-y-4 hidden">
      <!-- Quick actions -->
      <section class="bg-white rounded-3xl border border-slate-200 p-4 shadow-sm space-y-4">
        <div class="flex items-center justify-between gap-2 flex-wrap">
          <div>
            <div class="font-black text-slate-700">é€ä¿¡ï¼ˆãƒ™ãƒ“ãƒ¼å´ï¼‰</div>
            <div class="text-xs text-slate-500 mt-0.5">æœ€çŸ­ï¼š<strong>ã‚«ãƒ¡ãƒ©é–‹å§‹ â†’ Offerä½œæˆ â†’ AirDropã§é€ã‚‹</strong></div>
          </div>
          <div class="flex gap-2">
            <button id="btnStopAllSend" class="btnSm bg-slate-200 text-slate-800" disabled>åœæ­¢</button>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <!-- Preview -->
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <div class="text-sm font-bold text-slate-600">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
              <button id="btnFullLocal" class="btnSm bg-white border border-slate-200" disabled>â›¶ å…¨ç”»é¢</button>
            </div>
            <video id="localVideo" class="w-full rounded-3xl aspect-video" playsinline muted autoplay></video>

            <div class="grid grid-cols-2 gap-2">
              <button id="btnStartCam" class="btn bg-sky-600 text-white">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
              <button id="btnFlipCam" class="btnSm bg-white border border-slate-200" disabled>ğŸ“· å‰/å¾Œ</button>

              <button id="btnMicMute" class="btnSm bg-white border border-slate-200" disabled>ğŸ¤ ãƒã‚¤ã‚¯ï¼šON</button>
              <button id="btnNightLocal" class="btnSm bg-white border border-slate-200" disabled>ğŸŒ™ æš—è¦–ï¼šOFF</button>

              <button id="btnTorch" class="btnSm bg-white border border-slate-200 col-span-2" disabled>ğŸ”¦ ãƒ©ã‚¤ãƒˆï¼šOFF</button>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3 text-xs text-slate-600">
              <div class="font-bold text-slate-700 mb-1">å®Ÿéš›ã®æ’®å½±è¨­å®š</div>
              <div id="camInfo">æœªé–‹å§‹</div>
              <div class="mt-1 text-slate-500">â€»ç«¯æœ«ãŒå¯¾å¿œã™ã‚‹ç¯„å›²ã§æœ€å¤§ã«å¯„ã›ã¾ã™ï¼ˆç†æƒ³ï¼š4K/30fpsï¼‰ã€‚</div>
            </div>

            <div class="text-[11px] text-slate-500">
              â€»æš—è¦–ã¯ç–‘ä¼¼ï¼ˆæ˜ã‚‹ã•/ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·èª¿ï¼‰ã§ã™ã€‚èµ¤å¤–ç·šæš—è¦–ã®è¿½åŠ ã¯Webã‚¢ãƒ—ãƒªã§ã¯ã§ãã¾ã›ã‚“ã€‚
            </div>
          </div>

          <!-- Connection -->
          <div class="space-y-3">
            <div class="bg-indigo-50 border border-indigo-200 rounded-2xl p-3">
              <div class="flex items-center justify-between gap-2 flex-wrap">
                <div>
                  <div class="font-black text-indigo-900">â‘  Offerã‚’ä½œæˆã—ã¦AirDrop</div>
                  <div class="text-xs text-indigo-700 mt-1">å—ä¿¡å´ã¯ã€ŒOfferãƒªãƒ³ã‚¯ã‚’é–‹ãã€ã ã‘ã§OK</div>
                </div>
                <div class="text-xs text-indigo-700 font-bold">æœ€å„ªå…ˆæ‰‹é †</div>
              </div>

              <div class="mt-3 flex gap-2 flex-wrap">
                <button id="btnMakeOffer" class="btn bg-indigo-600 text-white" disabled>Offerä½œæˆ</button>
                <button id="btnShareOffer" class="btnSm bg-white border border-indigo-200 text-indigo-900" disabled>ğŸ“¤ å…±æœ‰ï¼ˆAirDropï¼‰</button>
                <button id="btnCopyOffer" class="btnSm bg-slate-200 text-slate-800" disabled>ã‚³ãƒ”ãƒ¼</button>
              </div>

              <div class="mt-2 grid gap-2">
                <div class="text-[11px] text-slate-600">Offerãƒªãƒ³ã‚¯ï¼ˆAirDropã§é€ã‚‹æ¨å¥¨ï¼‰</div>
                <input id="offerLinkOut" class="w-full rounded-2xl border border-indigo-200 px-3 py-2 text-xs bg-white" readonly />
                <textarea id="offerOut" class="w-full h-24 rounded-2xl border border-indigo-200 p-3 text-xs mono bg-white" readonly
                  placeholder="Offerã‚³ãƒ¼ãƒ‰ï¼ˆä¿é™ºï¼šæ‰‹å‹•è²¼ä»˜ç”¨ï¼‰"></textarea>
              </div>
            </div>

            <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-3">
              <div class="font-black text-emerald-900">â‘¡ Answerãƒªãƒ³ã‚¯ã‚’å—ã‘å–ã£ãŸã‚‰è‡ªå‹•æ¥ç¶š</div>
              <div class="text-xs text-emerald-700 mt-1">
                å—ä¿¡å´ã‹ã‚‰AirDropã§è¿”ã£ã¦ããŸ<strong>Answerãƒªãƒ³ã‚¯</strong>ã‚’é–‹ãã¨ã€ã“ã®ã‚¿ãƒ–ãŒè‡ªå‹•ã§æ¥ç¶šã—ã¾ã™ã€‚
              </div>

              <div class="mt-3 flex gap-2 flex-wrap">
                <button id="btnConnectSend" class="btn bg-emerald-600 text-white" disabled>æ‰‹å‹•ã§æ¥ç¶š</button>
                <button id="btnPasteAnswerFromClipboard" class="btnSm bg-white border border-emerald-200 text-emerald-900" disabled>ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰</button>
              </div>

              <textarea id="answerIn" class="mt-2 w-full h-24 rounded-2xl border border-emerald-200 p-3 text-xs mono bg-white"
                placeholder="Answerã‚³ãƒ¼ãƒ‰ï¼ˆä¿é™ºï¼šæ‰‹å‹•è²¼ä»˜ç”¨ï¼‰"></textarea>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3">
              <div class="font-black text-slate-700">æ¥ç¶šçŠ¶æ…‹</div>
              <div class="mt-1 text-sm">Peerï¼š<span id="sendConn" class="font-black">æœªæ¥ç¶š</span></div>
              <div class="text-[11px] text-slate-500 mt-1">â€»STUN/TURNãªã—ï¼ˆLANæƒ³å®šï¼‰ã€‚åŒä¸€Wi-Fiã§ã‚‚ç«¯æœ«éš”é›¢ãŒã‚ã‚‹ã¨æ¥ç¶šã§ãã¾ã›ã‚“ã€‚</div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <!-- RECV VIEW -->
    <section id="recvView" class="space-y-4 hidden">
      <section class="bg-white rounded-3xl border border-slate-200 p-4 shadow-sm space-y-4">
        <div class="flex items-center justify-between gap-2 flex-wrap">
          <div>
            <div class="font-black text-slate-700">å—ä¿¡ï¼ˆè¦‹å®ˆã‚Šå´ï¼‰</div>
            <div class="text-xs text-slate-500 mt-0.5">æœ€çŸ­ï¼šé€ä¿¡å´ã‹ã‚‰<strong>Offerãƒªãƒ³ã‚¯ã‚’AirDropã§å—ã‘å–ã£ã¦é–‹ã</strong>ã ã‘</div>
          </div>
          <div class="flex gap-2">
            <button id="btnResetRecv" class="btnSm bg-slate-200 text-slate-800" disabled>åˆ‡æ–­/ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <!-- Flow -->
          <div class="space-y-3">
            <div class="bg-indigo-50 border border-indigo-200 rounded-2xl p-3">
              <div class="font-black text-indigo-900">â‘  Offerã‚’å—ã‘å–ã‚‹</div>
              <div class="text-xs text-indigo-700 mt-1">
                AirDropã§å—ã‘å–ã£ãŸOfferãƒªãƒ³ã‚¯ã‚’é–‹ãã¨<strong>è‡ªå‹•å…¥åŠ›</strong>ã•ã‚Œã¾ã™ï¼ˆã†ã¾ãã„ã‹ãªã„æ™‚ã ã‘è²¼ã‚Šä»˜ã‘ï¼‰ã€‚
              </div>

              <div class="mt-2 flex gap-2 flex-wrap">
                <button id="btnPasteOfferFromClipboard" class="btnSm bg-white border border-indigo-200 text-indigo-900">ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰</button>
                <button id="btnMakeAnswer" class="btn bg-indigo-600 text-white">Answerä½œæˆ</button>
              </div>

              <textarea id="offerIn" class="mt-2 w-full h-24 rounded-2xl border border-indigo-200 p-3 text-xs mono bg-white"
                placeholder="Offerã‚³ãƒ¼ãƒ‰ï¼ˆä¿é™ºï¼šæ‰‹å‹•è²¼ä»˜ç”¨ï¼‰"></textarea>
            </div>

            <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-3">
              <div class="font-black text-emerald-900">â‘¡ Answerã‚’AirDropã§è¿”ã™</div>
              <div class="text-xs text-emerald-700 mt-1">ä½œæˆã—ãŸã‚‰<strong>å…±æœ‰ï¼ˆAirDropï¼‰</strong>ã§é€ä¿¡å´ã¸è¿”ã—ã¾ã™ã€‚</div>

              <div class="mt-2 flex gap-2 flex-wrap">
                <button id="btnShareAnswer" class="btnSm bg-white border border-emerald-200 text-emerald-900" disabled>ğŸ“¤ å…±æœ‰ï¼ˆAirDropï¼‰</button>
                <button id="btnCopyAnswer" class="btnSm bg-slate-200 text-slate-800" disabled>ã‚³ãƒ”ãƒ¼</button>
              </div>

              <div class="mt-2 grid gap-2">
                <div class="text-[11px] text-slate-600">Answerãƒªãƒ³ã‚¯ï¼ˆAirDropæ¨å¥¨ï¼‰</div>
                <input id="answerLinkOut" class="w-full rounded-2xl border border-emerald-200 px-3 py-2 text-xs bg-white" readonly />
                <textarea id="answerOut" class="w-full h-24 rounded-2xl border border-emerald-200 p-3 text-xs mono bg-white" readonly
                  placeholder="Answerã‚³ãƒ¼ãƒ‰ï¼ˆä¿é™ºï¼šæ‰‹å‹•è²¼ä»˜ç”¨ï¼‰"></textarea>
              </div>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3">
              <div class="font-black text-slate-700">æ¥ç¶šçŠ¶æ…‹</div>
              <div class="mt-1 text-sm">Peerï¼š<span id="recvConn" class="font-black">æœªæ¥ç¶š</span></div>
              <div class="text-[11px] text-slate-500 mt-1">iPhone/iPadã¯è‡ªå‹•å†ç”Ÿåˆ¶é™ãŒã‚ã‚‹ãŸã‚ã€æ˜ åƒãŒå‡ºãªã„æ™‚ã¯ã€Œå†ç”Ÿã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
            </div>
          </div>

          <!-- Video -->
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <div class="text-sm font-bold text-slate-600">å—ä¿¡æ˜ åƒ</div>
              <button id="btnFullRemote" class="btnSm bg-white border border-slate-200" disabled>â›¶ å…¨ç”»é¢</button>
            </div>

            <video id="remoteVideo" class="w-full rounded-3xl aspect-video" playsinline autoplay></video>

            <div class="grid grid-cols-2 gap-2">
              <button id="btnPlayRemote" class="btn bg-emerald-600 text-white" disabled>â–¶ å†ç”Ÿ</button>
              <button id="btnSpkMute" class="btnSm bg-white border border-slate-200" disabled>ğŸ”ˆ éŸ³ï¼šON</button>
              <button id="btnNightRemote" class="btnSm bg-white border border-slate-200" disabled>ğŸŒ™ æš—è¦–ï¼šOFF</button>
              <button id="btnFullAlt" class="btnSm bg-white border border-slate-200" disabled>â›¶ï¼ˆä»£æ›¿ï¼‰</button>
            </div>

            <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3 text-xs text-slate-600">
              <div class="font-bold text-slate-700 mb-1">å®¶ã®ä¸­ã§ã€Œã™ãä½¿ã†ã€ã‚³ãƒ„</div>
              <ul class="list-disc pl-5 space-y-1">
                <li>é€ä¿¡å´ã¯ã€Œã‚«ãƒ¡ãƒ©é–‹å§‹ã€ã—ãŸã‚¿ãƒ–ã‚’é–‰ã˜ãªã„ï¼ˆAirDropãƒªãƒ³ã‚¯ã¯åˆ¥ã‚¿ãƒ–ã§é–‹ãï¼‰</li>
                <li>åŒã˜Wi-Fiã§ã‚‚ç«¯æœ«éš”é›¢ãŒã‚ã‚‹ã¨æ¥ç¶šä¸å¯ï¼ˆã‚²ã‚¹ãƒˆWi-Fiæ³¨æ„ï¼‰</li>
                <li>éŸ³ãŒå‡ºãªã„æ™‚ã¯ã€Œå†ç”Ÿã€ã‚’æŠ¼ã™ï¼ˆiOSåˆ¶é™å¯¾ç­–ï¼‰</li>
              </ul>
            </div>
          </div>
        </div>
      </section>
    </section>

    <div class="text-[11px] text-slate-500 px-1">
      ğŸ”’ ã“ã‚Œã¯åŒ»ç™‚æ©Ÿå™¨ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚çŸ­æ™‚é–“ã®è£œåŠ©ç”¨é€”ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚å¤–éƒ¨æ¥ç¶šã¯æƒ³å®šã—ã¾ã›ã‚“ï¼ˆSTUN/TURNãªã—ï¼‰ã€‚
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // UI
  const uaHint = $("uaHint");
  const globalState = $("globalState");
  const btnModeSend = $("btnModeSend");
  const btnModeRecv = $("btnModeRecv");
  const sendView = $("sendView");
  const recvView = $("recvView");

  // Send UI
  const btnStartCam = $("btnStartCam");
  const btnStopAllSend = $("btnStopAllSend");
  const btnFlipCam = $("btnFlipCam");
  const btnMicMute = $("btnMicMute");
  const btnNightLocal = $("btnNightLocal");
  const btnTorch = $("btnTorch");
  const btnFullLocal = $("btnFullLocal");
  const localVideo = $("localVideo");
  const camInfo = $("camInfo");

  const btnMakeOffer = $("btnMakeOffer");
  const btnShareOffer = $("btnShareOffer");
  const btnCopyOffer = $("btnCopyOffer");
  const offerLinkOut = $("offerLinkOut");
  const offerOut = $("offerOut");

  const btnConnectSend = $("btnConnectSend");
  const btnPasteAnswerFromClipboard = $("btnPasteAnswerFromClipboard");
  const answerIn = $("answerIn");
  const sendConn = $("sendConn");

  // Recv UI
  const btnResetRecv = $("btnResetRecv");
  const btnPasteOfferFromClipboard = $("btnPasteOfferFromClipboard");
  const btnMakeAnswer = $("btnMakeAnswer");
  const offerIn = $("offerIn");

  const btnShareAnswer = $("btnShareAnswer");
  const btnCopyAnswer = $("btnCopyAnswer");
  const answerLinkOut = $("answerLinkOut");
  const answerOut = $("answerOut");

  const recvConn = $("recvConn");
  const remoteVideo = $("remoteVideo");
  const btnPlayRemote = $("btnPlayRemote");
  const btnSpkMute = $("btnSpkMute");
  const btnNightRemote = $("btnNightRemote");
  const btnFullRemote = $("btnFullRemote");
  const btnFullAlt = $("btnFullAlt");

  // UA hint
  const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
  uaHint.textContent = isIOS ? "iOSï¼ˆå¿…è¦ãªã‚‰ã€Œå†ç”Ÿã€ï¼‰" : "OK";

  // ===== WebRTC: LAN-onlyï¼ˆSTUN/TURNãªã—ï¼‰=====
  const pcConfig = { iceServers: [] };

  // ===== Base64url helpers =====
  const te = new TextEncoder();
  const td = new TextDecoder();

  function b64uEncode(u8) {
    let s = btoa(String.fromCharCode(...u8));
    return s.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
  }
  function b64uDecode(s) {
    s = (s || "").replace(/-/g, "+").replace(/_/g, "/");
    while (s.length % 4) s += "=";
    const bin = atob(s);
    const u8 = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) u8[i] = bin.charCodeAt(i);
    return u8;
  }

  function packDesc(desc) {
    // ãªã‚‹ã¹ãè»½ãï¼štype + sdp ã ã‘
    const mini = { type: desc.type, sdp: filterHostCandidatesInSdp(desc.sdp || "") };
    return b64uEncode(te.encode(JSON.stringify(mini)));
  }
  function unpackDesc(b64) {
    const obj = JSON.parse(td.decode(b64uDecode(b64)));
    if (!obj || !obj.type || !obj.sdp) throw new Error("ãƒªãƒ³ã‚¯ãŒå£Šã‚Œã¦ã„ã¾ã™");
    return obj;
  }

  function filterHostCandidatesInSdp(sdp) {
    // â€œLANé™å®šâ€ã«å¯„ã›ã‚‹ï¼šhostä»¥å¤–å€™è£œã‚’å‰Šã‚‹ï¼ˆSTUNç„¡ã—ãªã‚‰é€šå¸¸hostã®ã¿ã ãŒå¿µã®ãŸã‚ï¼‰
    const lines = (sdp || "").split(/\r?\n/);
    const keep = [];
    for (const ln of lines) {
      if (ln.startsWith("a=candidate:")) {
        if (/ typ host /i.test(ln)) keep.push(ln);
        continue;
      }
      // end-of-candidates ã¯æ®‹ã™
      keep.push(ln);
    }
    return keep.join("\r\n");
  }

  function buildLink(kind, packed) {
    // ã‚µãƒ¼ãƒã¸é€ã‚‰ã‚Œãªã„fragmentã§å…±æœ‰ï¼ˆGitHub Pagesã§ã‚‚å®‰å…¨ï¼‰
    const base = location.origin + location.pathname;
    if (kind === "offer") return base + "#o=" + packed;
    if (kind === "answer") return base + "#a=" + packed;
    return base;
  }

  function parseFragment() {
    const h = (location.hash || "").replace(/^#/, "");
    if (!h) return null;
    const mO = h.match(/^o=(.+)$/);
    const mA = h.match(/^a=(.+)$/);
    if (mO) return { kind: "offer", data: mO[1] };
    if (mA) return { kind: "answer", data: mA[1] };
    return null;
  }

  // ===== Clipboard / Share helpers =====
  async function safeCopy(text) {
    if (!text) return false;
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch {
      try {
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        return true;
      } catch {
        return false;
      }
    }
  }

  async function readClipboard() {
    try {
      return await navigator.clipboard.readText();
    } catch {
      return "";
    }
  }

  async function shareLink(title, url, fallbackText) {
    // iOS Safariãªã‚‰ã“ã“ã‹ã‚‰AirDropãŒé¸ã¹ã‚‹
    try {
      if (navigator.share) {
        await navigator.share({ title, text: "", url });
        return true;
      }
    } catch {
      // user canceled etc.
    }
    // fallback: copy
    const ok = await safeCopy(url);
    alert(ok
      ? "å…±æœ‰æ©Ÿèƒ½ãŒä½¿ãˆãªã„ãŸã‚ã€ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚è²¼ã‚Šä»˜ã‘ã¦é€ã£ã¦ãã ã•ã„ã€‚"
      : (fallbackText || "å…±æœ‰ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"));
    return false;
  }

  // ===== Fullscreen helper =====
  async function requestVideoFullscreen(videoEl) {
    if (!videoEl) return;
    try {
      if (videoEl.requestFullscreen) await videoEl.requestFullscreen();
      else if (videoEl.webkitEnterFullscreen) videoEl.webkitEnterFullscreen(); // iOS
    } catch {}
  }

  // ===== Mode =====
  let mode = "send";
  function setMode(next) {
    mode = next;
    if (mode === "send") {
      sendView.classList.remove("hidden");
      recvView.classList.add("hidden");
      btnModeSend.className = "btn bg-sky-50 text-sky-700 border border-slate-200";
      btnModeRecv.className = "btn bg-white border border-slate-200 hover:bg-slate-100";
      globalState.textContent = "é€ä¿¡ãƒ¢ãƒ¼ãƒ‰";
    } else {
      recvView.classList.remove("hidden");
      sendView.classList.add("hidden");
      btnModeRecv.className = "btn bg-emerald-50 text-emerald-700 border border-slate-200";
      btnModeSend.className = "btn bg-white border border-slate-200 hover:bg-slate-100";
      globalState.textContent = "å—ä¿¡ãƒ¢ãƒ¼ãƒ‰";
    }
  }
  btnModeSend.addEventListener("click", () => setMode("send"));
  btnModeRecv.addEventListener("click", () => setMode("recv"));

  // ===== Sender =====
  let sendPc = null;
  let sendStream = null;
  let currentFacing = "environment";
  let micOn = true;
  let nightLocalOn = false;
  let torchOn = false;
  let lastOfferPacked = "";
  let localOfferDesc = null;

  async function startCameraHighest() {
    const constraints = {
      audio: true,
      video: {
        facingMode: { ideal: currentFacing },
        width: { ideal: 3840 },
        height: { ideal: 2160 },
        frameRate: { ideal: 30, max: 60 }
      }
    };
    sendStream = await navigator.mediaDevices.getUserMedia(constraints);
    localVideo.srcObject = sendStream;

    // enable controls
    btnStopAllSend.disabled = false;
    btnFlipCam.disabled = false;
    btnMicMute.disabled = false;
    btnNightLocal.disabled = false;
    btnTorch.disabled = false;
    btnMakeOffer.disabled = false;
    btnFullLocal.disabled = false;

    btnPasteAnswerFromClipboard.disabled = false;

    // actual settings
    const vtrack = sendStream.getVideoTracks()[0];
    const atrack = sendStream.getAudioTracks()[0];
    const s = vtrack.getSettings ? vtrack.getSettings() : {};
    camInfo.textContent = [
      `è§£åƒåº¦ï¼š${s.width || "?"} x ${s.height || "?"}`,
      `FPSï¼š${s.frameRate || "?"}`,
      `ã‚«ãƒ¡ãƒ©ï¼š${(s.facingMode || currentFacing)}`,
      `éŸ³å£°ï¼š${atrack ? "æœ‰åŠ¹" : "ãªã—"}`
    ].join(" / ");

    // torch capability check (not perfect)
    btnTorch.disabled = false;
    sendConn.textContent = "é…ä¿¡ä¸­ï¼ˆOfferä½œæˆã¸ï¼‰";
  }

  function stopSenderAll() {
    try { if (sendPc) sendPc.close(); } catch {}
    sendPc = null;
    localOfferDesc = null;

    if (sendStream) sendStream.getTracks().forEach(t => t.stop());
    sendStream = null;

    offerOut.value = "";
    offerLinkOut.value = "";
    answerIn.value = "";

    lastOfferPacked = "";
    btnCopyOffer.disabled = true;
    btnShareOffer.disabled = true;
    btnConnectSend.disabled = true;

    btnStopAllSend.disabled = true;
    btnFlipCam.disabled = true;
    btnMicMute.disabled = true;
    btnNightLocal.disabled = true;
    btnTorch.disabled = true;
    btnMakeOffer.disabled = true;
    btnFullLocal.disabled = true;
    btnPasteAnswerFromClipboard.disabled = true;

    micOn = true;
    btnMicMute.textContent = "ğŸ¤ ãƒã‚¤ã‚¯ï¼šON";
    nightLocalOn = false;
    localVideo.classList.remove("night");
    btnNightLocal.textContent = "ğŸŒ™ æš—è¦–ï¼šOFF";
    torchOn = false;
    btnTorch.textContent = "ğŸ”¦ ãƒ©ã‚¤ãƒˆï¼šOFF";
    camInfo.textContent = "æœªé–‹å§‹";
    sendConn.textContent = "åœæ­¢";
  }

  async function flipCamera() {
    currentFacing = (currentFacing === "environment") ? "user" : "environment";
    if (sendStream) sendStream.getTracks().forEach(t => t.stop());
    sendStream = null;
    await startCameraHighest();
  }

  function toggleMic() {
    if (!sendStream) return;
    const atrack = sendStream.getAudioTracks()[0];
    if (!atrack) return;
    micOn = !micOn;
    atrack.enabled = micOn;
    btnMicMute.textContent = micOn ? "ğŸ¤ ãƒã‚¤ã‚¯ï¼šON" : "ğŸ¤ ãƒã‚¤ã‚¯ï¼šMUTE";
  }

  function toggleNightLocal() {
    nightLocalOn = !nightLocalOn;
    localVideo.classList.toggle("night", nightLocalOn);
    btnNightLocal.textContent = nightLocalOn ? "ğŸŒ™ æš—è¦–ï¼šON" : "ğŸŒ™ æš—è¦–ï¼šOFF";
  }

  async function toggleTorch() {
    if (!sendStream) return;
    const vtrack = sendStream.getVideoTracks()[0];
    if (!vtrack) return;
    try {
      torchOn = !torchOn;
      await vtrack.applyConstraints({ advanced: [{ torch: torchOn }] });
      btnTorch.textContent = torchOn ? "ğŸ”¦ ãƒ©ã‚¤ãƒˆï¼šON" : "ğŸ”¦ ãƒ©ã‚¤ãƒˆï¼šOFF";
      btnTorch.disabled = false;
    } catch {
      torchOn = false;
      btnTorch.textContent = "ğŸ”¦ ãƒ©ã‚¤ãƒˆï¼šéå¯¾å¿œ";
      btnTorch.disabled = true;
    }
  }

  function waitIceGathering(pc, timeoutMs = 6000) {
    return new Promise((resolve) => {
      let done = false;
      let lastCandAt = Date.now();

      const finish = () => {
        if (done) return;
        done = true;
        try { pc.removeEventListener("icegatheringstatechange", onState); } catch {}
        try { pc.removeEventListener("icecandidate", onCand); } catch {}
        resolve();
      };

      const onState = () => {
        if (pc.iceGatheringState === "complete") finish();
      };

      const onCand = (e) => {
        if (!e.candidate) {
          // end of candidates
          finish();
          return;
        }
        lastCandAt = Date.now();
      };

      pc.addEventListener("icegatheringstatechange", onState);
      pc.addEventListener("icecandidate", onCand);

      // Safety timeout OR "quiet period"ï¼ˆå€™è£œãŒæ¥ãªããªã£ãŸã‚‰çµ‚ãˆã‚‹ï¼‰
      const t = setInterval(() => {
        if (done) { clearInterval(t); return; }
        const quiet = Date.now() - lastCandAt;
        if (pc.iceGatheringState === "complete" || quiet > 700) {
          clearInterval(t);
          finish();
        }
      }, 250);

      setTimeout(() => { clearInterval(t); finish(); }, timeoutMs);
    });
  }

  async function makeOffer() {
    if (!sendStream) throw new Error("å…ˆã«ã€Œã‚«ãƒ¡ãƒ©é–‹å§‹ã€ã‚’ã—ã¦ãã ã•ã„ã€‚");

    // reset pc if any
    try { if (sendPc) sendPc.close(); } catch {}
    sendPc = new RTCPeerConnection(pcConfig);

    // add tracks
    sendStream.getTracks().forEach(tr => sendPc.addTrack(tr, sendStream));

    sendPc.onconnectionstatechange = () => {
      sendConn.textContent = sendPc.connectionState;
    };

    globalState.textContent = "é€ä¿¡ï¼šOfferä½œæˆä¸­â€¦";

    const offer = await sendPc.createOffer();
    await sendPc.setLocalDescription(offer);

    await waitIceGathering(sendPc, 6500);

    localOfferDesc = sendPc.localDescription; // candidates included
    const packed = packDesc(localOfferDesc);
    lastOfferPacked = packed;

    const offerLink = buildLink("offer", packed);
    offerLinkOut.value = offerLink;
    offerOut.value = JSON.stringify({ type: localOfferDesc.type, sdp: filterHostCandidatesInSdp(localOfferDesc.sdp || "") });

    btnCopyOffer.disabled = false;
    btnShareOffer.disabled = false;
    btnConnectSend.disabled = false;

    globalState.textContent = "é€ä¿¡ï¼šOfferä½œæˆæ¸ˆï¼ˆAirDropã§é€ã£ã¦ãã ã•ã„ï¼‰";
    sendConn.textContent = "Offerä½œæˆæ¸ˆ";
  }

  async function connectWithAnswerPacked(packed) {
    if (!sendPc) throw new Error("å…ˆã«Offerä½œæˆãŒå¿…è¦ã§ã™ã€‚");
    const desc = unpackDesc(packed);
    await sendPc.setRemoteDescription(desc);
  }

  async function connectWithAnswerCodeText(text) {
    if (!sendPc) throw new Error("å…ˆã«Offerä½œæˆãŒå¿…è¦ã§ã™ã€‚");
    const obj = JSON.parse(text);
    if (!obj || !obj.type || !obj.sdp) throw new Error("Answerã‚³ãƒ¼ãƒ‰ã®å½¢å¼ãŒä¸æ­£ã§ã™");
    await sendPc.setRemoteDescription({ type: obj.type, sdp: obj.sdp });
  }

  // sender UI hooks
  btnStartCam.addEventListener("click", async () => {
    try {
      globalState.textContent = "é€ä¿¡ï¼šã‚«ãƒ¡ãƒ©é–‹å§‹ä¸­â€¦";
      await startCameraHighest();
      globalState.textContent = "é€ä¿¡ï¼šæº–å‚™OKï¼ˆOfferä½œæˆã¸ï¼‰";
    } catch {
      globalState.textContent = "ã‚¨ãƒ©ãƒ¼";
      alert("ã‚«ãƒ¡ãƒ©/ãƒã‚¤ã‚¯ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚HTTPSã§é–‹ã„ã¦ãã ã•ã„ã€‚");
    }
  });

  btnStopAllSend.addEventListener("click", stopSenderAll);
  btnFlipCam.addEventListener("click", async () => { try { await flipCamera(); } catch { alert("ã‚«ãƒ¡ãƒ©åˆ‡æ›¿ã«å¤±æ•—ã—ã¾ã—ãŸ"); } });
  btnMicMute.addEventListener("click", toggleMic);
  btnNightLocal.addEventListener("click", toggleNightLocal);
  btnTorch.addEventListener("click", toggleTorch);

  btnFullLocal.addEventListener("click", () => requestVideoFullscreen(localVideo));
  localVideo.addEventListener("dblclick", () => requestVideoFullscreen(localVideo));

  btnMakeOffer.addEventListener("click", async () => {
    try {
      await makeOffer();
    } catch (e) {
      globalState.textContent = "ã‚¨ãƒ©ãƒ¼";
      alert(e.message || "Offerä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  });

  btnCopyOffer.addEventListener("click", async () => {
    const ok = await safeCopy(offerLinkOut.value || offerOut.value);
    if (!ok) alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
  });

  btnShareOffer.addEventListener("click", async () => {
    const url = offerLinkOut.value;
    if (!url) return;
    await shareLink("Offerï¼ˆå—ä¿¡å´ã§é–‹ãï¼‰", url, "å…±æœ‰ã«å¤±æ•—ã—ã¾ã—ãŸ");
  });

  btnPasteAnswerFromClipboard.addEventListener("click", async () => {
    const text = await readClipboard();
    if (!text) return alert("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ãŒç©ºã§ã™");
    // URLå½¢å¼ãªã‚‰ #a= ã‚’æ‹¾ã†
    try {
      const m = text.match(/#a=([^ \n]+)/);
      if (m) {
        answerIn.value = "(Answerãƒªãƒ³ã‚¯ã‚’æ¤œå‡ºã—ã¾ã—ãŸ)";
        globalState.textContent = "é€ä¿¡ï¼šAnswerãƒªãƒ³ã‚¯ã‚’æ¤œå‡º â†’ æ¥ç¶šä¸­â€¦";
        await connectWithAnswerPacked(m[1]);
        globalState.textContent = "é€ä¿¡ï¼šæ¥ç¶šå‡¦ç†OKï¼ˆçŠ¶æ…‹ã‚’ç¢ºèªï¼‰";
        return;
      }
    } catch {}
    // ãã‚Œä»¥å¤–ã¯ã‚³ãƒ¼ãƒ‰JSONã¨ã—ã¦è©¦ã™
    answerIn.value = text;
    alert("è²¼ã‚Šä»˜ã‘ã¾ã—ãŸã€‚å¿…è¦ãªã‚‰ã€Œæ‰‹å‹•ã§æ¥ç¶šã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
  });

  btnConnectSend.addEventListener("click", async () => {
    try {
      globalState.textContent = "é€ä¿¡ï¼šæ¥ç¶šä¸­â€¦";
      // Answeræ¬„ãŒURLãªã‚‰ãã“ã‹ã‚‰ã€JSONãªã‚‰JSONã¨ã—ã¦
      const t = (answerIn.value || "").trim();
      if (!t) throw new Error("AnswerãŒç©ºã§ã™ï¼ˆå—ä¿¡å´ã®Answerã‚’è²¼ã‚Šä»˜ã‘ã€ã¾ãŸã¯Answerãƒªãƒ³ã‚¯ã‚’é–‹ã„ã¦ãã ã•ã„ï¼‰");

      const m = t.match(/#a=([^ \n]+)/);
      if (m) await connectWithAnswerPacked(m[1]);
      else await connectWithAnswerCodeText(t);

      globalState.textContent = "é€ä¿¡ï¼šæ¥ç¶šå‡¦ç†OKï¼ˆçŠ¶æ…‹ã‚’ç¢ºèªï¼‰";
    } catch (e) {
      globalState.textContent = "ã‚¨ãƒ©ãƒ¼";
      alert(e.message || "æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  });

  // ===== Receiver =====
  let recvPc = null;
  let recvStream = null;
  let spkOn = true;
  let nightRemoteOn = false;
  let lastAnswerPacked = "";

  function resetReceiverAll() {
    try { if (recvPc) recvPc.close(); } catch {}
    recvPc = null;
    recvStream = null;
    remoteVideo.srcObject = null;

    answerOut.value = "";
    answerLinkOut.value = "";
    btnCopyAnswer.disabled = true;
    btnShareAnswer.disabled = true;
    btnPlayRemote.disabled = true;
    btnSpkMute.disabled = true;
    btnNightRemote.disabled = true;
    btnFullRemote.disabled = true;
    btnFullAlt.disabled = true;
    btnResetRecv.disabled = true;

    spkOn = true;
    remoteVideo.muted = false;
    btnSpkMute.textContent = "ğŸ”ˆ éŸ³ï¼šON";

    nightRemoteOn = false;
    remoteVideo.classList.remove("night");
    btnNightRemote.textContent = "ğŸŒ™ æš—è¦–ï¼šOFF";

    recvConn.textContent = "æœªæ¥ç¶š";
    globalState.textContent = "å—ä¿¡ï¼šå¾…æ©Ÿä¸­";
    lastAnswerPacked = "";
  }

  async function makeAnswerFromOfferPacked(packed) {
    // close existing
    try { if (recvPc) recvPc.close(); } catch {}
    recvPc = new RTCPeerConnection(pcConfig);

    recvPc.onconnectionstatechange = () => {
      recvConn.textContent = recvPc.connectionState;
    };

    const offerDesc = unpackDesc(packed);

    recvPc.ontrack = (e) => {
      if (!recvStream) recvStream = new MediaStream();
      recvStream.addTrack(e.track);
      remoteVideo.srcObject = recvStream;

      btnPlayRemote.disabled = false;
      btnSpkMute.disabled = false;
      btnNightRemote.disabled = false;
      btnFullRemote.disabled = false;
      btnFullAlt.disabled = false;
      btnResetRecv.disabled = false;

      // try autoplay
      remoteVideo.play().catch(() => {});
    };

    globalState.textContent = "å—ä¿¡ï¼šAnswerä½œæˆä¸­â€¦";
    await recvPc.setRemoteDescription(offerDesc);

    const answer = await recvPc.createAnswer();
    await recvPc.setLocalDescription(answer);

    await waitIceGathering(recvPc, 6500);

    const localAnswerDesc = recvPc.localDescription;
    const packedAns = packDesc(localAnswerDesc);
    lastAnswerPacked = packedAns;

    const ansLink = buildLink("answer", packedAns);
    answerLinkOut.value = ansLink;

    // ä¿é™ºã‚³ãƒ¼ãƒ‰
    answerOut.value = JSON.stringify({ type: localAnswerDesc.type, sdp: filterHostCandidatesInSdp(localAnswerDesc.sdp || "") });

    btnCopyAnswer.disabled = false;
    btnShareAnswer.disabled = false;
    btnResetRecv.disabled = false;

    globalState.textContent = "å—ä¿¡ï¼šAnswerä½œæˆæ¸ˆï¼ˆAirDropã§è¿”ã—ã¦ãã ã•ã„ï¼‰";
    recvConn.textContent = "Answerä½œæˆæ¸ˆ";
  }

  // receiver UI hooks
  btnPasteOfferFromClipboard.addEventListener("click", async () => {
    const text = await readClipboard();
    if (!text) return alert("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ãŒç©ºã§ã™");
    // URLãªã‚‰ #o= ã‚’æ‹¾ã†
    const m = text.match(/#o=([^ \n]+)/);
    if (m) {
      offerIn.value = "(Offerãƒªãƒ³ã‚¯ã‚’æ¤œå‡ºã—ã¾ã—ãŸ)";
      try {
        await makeAnswerFromOfferPacked(m[1]);
        // è‡ªå‹•ã§å…±æœ‰ã‚·ãƒ¼ãƒˆã¾ã§å‡ºã™ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¿ãƒƒãƒ—ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚‹ã®ã§tryï¼‰
        try { await shareLink("Answerï¼ˆé€ä¿¡å´ã§é–‹ãï¼‰", answerLinkOut.value); } catch {}
      } catch (e) {
        alert(e.message || "Answerä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
      }
      return;
    }
    // JSONã‚³ãƒ¼ãƒ‰ã¨ã—ã¦è²¼ã‚Šä»˜ã‘
    offerIn.value = text;
    alert("è²¼ã‚Šä»˜ã‘ã¾ã—ãŸã€‚å¿…è¦ãªã‚‰ã€ŒAnswerä½œæˆã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
  });

  btnMakeAnswer.addEventListener("click", async () => {
    try {
      const t = (offerIn.value || "").trim();
      if (!t) throw new Error("OfferãŒç©ºã§ã™ï¼ˆAirDropã®Offerãƒªãƒ³ã‚¯ã‚’é–‹ãã®ãŒæœ€é€Ÿã§ã™ï¼‰");

      // URLãŒå…¥ã£ã¦ã„ã‚Œã°ãã“ã‹ã‚‰
      const m = t.match(/#o=([^ \n]+)/);
      if (m) {
        await makeAnswerFromOfferPacked(m[1]);
      } else {
        // JSONã‚³ãƒ¼ãƒ‰ã¨ã—ã¦
        const obj = JSON.parse(t);
        if (!obj || !obj.type || !obj.sdp) throw new Error("Offerã‚³ãƒ¼ãƒ‰ã®å½¢å¼ãŒä¸æ­£ã§ã™");
        const packed = packDesc(obj); // å—ä¿¡å´ã§ã‚‚packedåŒ–ã—ã¦å…±é€šå‡¦ç†ã¸
        await makeAnswerFromOfferPacked(packed);
      }

      // ä½œæˆç›´å¾Œã«å…±æœ‰ã‚’ä¿ƒã™ï¼ˆiOSã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ãªã®ã§ã€ã“ã“ã¯ã‚¿ãƒƒãƒ—æ¸ˆã¿ã§OKï¼‰
      await shareLink("Answerï¼ˆé€ä¿¡å´ã§é–‹ãï¼‰", answerLinkOut.value);
    } catch (e) {
      globalState.textContent = "ã‚¨ãƒ©ãƒ¼";
      alert(e.message || "Answerä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  });

  btnCopyAnswer.addEventListener("click", async () => {
    const ok = await safeCopy(answerLinkOut.value || answerOut.value);
    if (!ok) alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
  });

  btnShareAnswer.addEventListener("click", async () => {
    const url = answerLinkOut.value;
    if (!url) return;
    await shareLink("Answerï¼ˆé€ä¿¡å´ã§é–‹ãï¼‰", url, "å…±æœ‰ã«å¤±æ•—ã—ã¾ã—ãŸ");
  });

  btnPlayRemote.addEventListener("click", async () => {
    try { await remoteVideo.play(); } catch {}
  });

  btnSpkMute.addEventListener("click", () => {
    spkOn = !spkOn;
    remoteVideo.muted = !spkOn;
    btnSpkMute.textContent = spkOn ? "ğŸ”ˆ éŸ³ï¼šON" : "ğŸ”‡ éŸ³ï¼šMUTE";
  });

  btnNightRemote.addEventListener("click", () => {
    nightRemoteOn = !nightRemoteOn;
    remoteVideo.classList.toggle("night", nightRemoteOn);
    btnNightRemote.textContent = nightRemoteOn ? "ğŸŒ™ æš—è¦–ï¼šON" : "ğŸŒ™ æš—è¦–ï¼šOFF";
  });

  btnFullRemote.addEventListener("click", () => requestVideoFullscreen(remoteVideo));
  btnFullAlt.addEventListener("click", () => requestVideoFullscreen(remoteVideo));
  remoteVideo.addEventListener("dblclick", () => requestVideoFullscreen(remoteVideo));

  btnResetRecv.addEventListener("click", resetReceiverAll);

  // ===== Deep-link auto flowï¼ˆAirDropãƒªãƒ³ã‚¯ã‚’é–‹ã„ãŸã‚‰è‡ªå‹•å‡¦ç†ï¼‰=====
  async function handleDeepLink() {
    const frag = parseFragment();
    if (!frag) return;

    // å…±æœ‰ãƒªãƒ³ã‚¯ã‚’é–‹ã„ãŸã‚¿ãƒ–ã¯â€œä¸­ç¶™ã‚¿ãƒ–â€ã«ãªã‚Šã‚„ã™ã„ã®ã§ã€æ¡ˆå†…ã‚’å‡ºã—ã¤ã¤è‡ªå‹•å®Ÿè¡Œ
    if (frag.kind === "offer") {
      // å—ä¿¡å´ï¼šOfferãƒªãƒ³ã‚¯ã‚’é–‹ã„ãŸã‚‰ã€å¯èƒ½ãªé™ã‚ŠAnswerä½œæˆã¾ã§é€²ã‚ã‚‹
      setMode("recv");
      offerIn.value = "(Offerãƒªãƒ³ã‚¯ã‹ã‚‰è‡ªå‹•å…¥åŠ›)";
      try {
        await makeAnswerFromOfferPacked(frag.data);
        // ã“ã“ã¯è‡ªå‹•ã§shareã‚’é–‹ã‘ãªã„ã“ã¨ã‚‚ã‚ã‚‹ã®ã§ã€ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã ã‘ã§ã‚‚OK
        globalState.textContent = "å—ä¿¡ï¼šAnswerä½œæˆæ¸ˆï¼ˆå…±æœ‰ã§AirDropã—ã¦ãã ã•ã„ï¼‰";
      } catch (e) {
        globalState.textContent = "å—ä¿¡ï¼šOfferå—ä¿¡ï¼ˆæ‰‹å‹•ã§Answerä½œæˆã—ã¦ãã ã•ã„ï¼‰";
      }
      return;
    }

    if (frag.kind === "answer") {
      // é€ä¿¡å´ï¼šAnswerãƒªãƒ³ã‚¯ã‚’é–‹ã„ãŸã‚‰ã€æ¥ç¶šã‚’è©¦ã¿ã‚‹ï¼ˆé€ä¿¡å´PCãŒæ—¢ã«ã‚ã‚‹å‰æï¼‰
      setMode("send");
      answerIn.value = "(Answerãƒªãƒ³ã‚¯ã‹ã‚‰è‡ªå‹•å…¥åŠ›)";
      // é€ä¿¡å´ã®Offerï¼ˆRTCPeerConnectionï¼‰ãŒç„¡ã„ã‚¿ãƒ–ã§Answerãƒªãƒ³ã‚¯ã‚’é–‹ãã¨æ¥ç¶šã§ããªã„
      // â†’ ãã®å ´åˆã¯èª¬æ˜ã‚’å‡ºã™
      try {
        if (!sendPc) throw new Error("é€ä¿¡å´ã§ã€Œã‚«ãƒ¡ãƒ©é–‹å§‹â†’Offerä½œæˆã€ã—ãŸã‚¿ãƒ–ã‚’é–‹ã„ãŸã¾ã¾ã€ãã“ã§Answerãƒªãƒ³ã‚¯ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚");
        globalState.textContent = "é€ä¿¡ï¼šAnswerå—ä¿¡ â†’ æ¥ç¶šä¸­â€¦";
        await connectWithAnswerPacked(frag.data);
        globalState.textContent = "é€ä¿¡ï¼šæ¥ç¶šå‡¦ç†OKï¼ˆçŠ¶æ…‹ã‚’ç¢ºèªï¼‰";
      } catch (e) {
        globalState.textContent = "é€ä¿¡ï¼šAnswerå—ä¿¡ï¼ˆæ³¨æ„ã‚ã‚Šï¼‰";
        alert(e.message || "æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚é€ä¿¡å´ã®ã‚¿ãƒ–ã§Answerãƒªãƒ³ã‚¯ã‚’é–‹ã„ã¦ãã ã•ã„ã€‚");
      }
      return;
    }
  }

  // ===== Init =====
  setMode("send");
  resetReceiverAll();

  // basic cleanup
  window.addEventListener("beforeunload", () => {
    stopSenderAll();
    resetReceiverAll();
  });

  // Deep link on load
  handleDeepLink().catch(() => {});
})();
</script>
</body>
</html>
